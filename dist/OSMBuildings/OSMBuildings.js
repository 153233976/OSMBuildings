!function(){var e=function(){var e={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgrey:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};function t(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+(t-e)*(2/3-i)*6:e}function i(e,t){if(void 0!==e)return Math.min(t,Math.max(0,e||0))}var r=function(e,t,r,o){this.r=i(e,1),this.g=i(t,1),this.b=i(r,1),this.a=i(o,1)||1};return r.parse=function(t){if("string"==typeof t){var i;if(t=t.toLowerCase(),i=(t=e[t]||t).match(/^#?(\w{2})(\w{2})(\w{2})$/))return new r(parseInt(i[1],16)/255,parseInt(i[2],16)/255,parseInt(i[3],16)/255);if(i=t.match(/^#?(\w)(\w)(\w)$/))return new r(parseInt(i[1]+i[1],16)/255,parseInt(i[2]+i[2],16)/255,parseInt(i[3]+i[3],16)/255);if(i=t.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new r(parseFloat(i[1])/255,parseFloat(i[2])/255,parseFloat(i[3])/255,i[4]?parseFloat(i[5]):1)}return new r},r.fromHSL=function(e,t,i){var o=(new r).fromHSL(e,t,i);return o.a=a,o},r.prototype={isValid:function(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b},toHSL:function(){if(this.isValid()){var e,t,i=Math.max(this.r,this.g,this.b),r=Math.min(this.r,this.g,this.b),o=(i+r)/2,n=i-r;if(n){switch(t=o>.5?n/(2-i-r):n/(i+r),i){case this.r:e=(this.g-this.b)/n+(this.g<this.b?6:0);break;case this.g:e=(this.b-this.r)/n+2;break;case this.b:e=(this.r-this.g)/n+4}e*=60}else e=t=0;return{h:e,s:t,l:o}}},fromHSL:function(e,i,r){if(0===i)return this.r=this.g=this.b=r,this;var o=r<.5?r*(1+i):r+i-r*i,n=2*r-o;return e/=360,this.r=t(n,o,e+1/3),this.g=t(n,o,e),this.b=t(n,o,e-1/3),this},toString:function(){if(this.isValid())return 1===this.a?"#"+((1<<24)+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1,7):"rgba("+[Math.round(255*this.r),Math.round(255*this.g),Math.round(255*this.b),this.a.toFixed(2)].join(",")+")"},toArray:function(){if(this.isValid)return[this.r,this.g,this.b]},hue:function(e){var t=this.toHSL();return this.fromHSL(t.h+e,t.s,t.l)},saturation:function(e){var t=this.toHSL();return this.fromHSL(t.h,t.s*e,t.l)},lightness:function(e){var t=this.toHSL();return this.fromHSL(t.h,t.s,t.l*e)},clone:function(){return new r(this.r,this.g,this.b,this.a)}},r}();"object"==typeof module&&(module.exports=e);var t=function(){"use strict";var e=Math.PI,t=Math.sin,i=Math.cos,r=Math.tan,o=Math.asin,n=Math.atan2,a=e/180,s=864e5,l=2440588,u=2451545;function h(e){return function(e){return e.valueOf()/s-.5+l}(e)-u}var f=23.4397*a;function c(s){var l,u,h=function(i){return i+a*(1.9148*t(i)+.02*t(2*i)+3e-4*t(3*i))+102.9372*a+e}(function(e){return a*(357.5291+.98560028*e)}(s));return{dec:(l=h,u=0,o(t(u)*i(f)+i(u)*t(f)*t(l))),ra:function(e,o){return n(t(e)*i(f)-r(o)*t(f),i(e))}(h,0)}}return function(e,s,l){var u=a*-l,f=a*s,d=h(e),m=c(d),g=function(e,t){return a*(280.16+360.9856235*e)-t}(d,u)-m.ra;return{azimuth:function(e,o,a){return n(t(e),i(e)*t(o)-r(a)*i(o))}(g,f,m.dec),altitude:function(e,r,n){return o(t(r)*t(n)+i(r)*i(n)*i(e))}(g,f,m.dec)}}}();const i={name:"picking",vs:"precision highp float; //is default in vertex shaders anyway, using highp fixes #49\n#define halfPi 1.57079632679\nattribute vec4 aPosition;\nattribute vec3 aPickingColor;\nattribute float aZScale;\nuniform mat4 uModelMatrix;\nuniform mat4 uMatrix;\nuniform float uFogDistance;\nuniform float uFade;\nuniform float uIndex;\nvarying vec4 vColor;\nvoid main() {\nfloat f = clamp(uFade*aZScale, 0.0, 1.0);\nif (f == 0.0) {\ngl_Position = vec4(0.0, 0.0, 0.0, 0.0);\nvColor = vec4(0.0, 0.0, 0.0, 0.0);\n} else {\nvec4 pos = vec4(aPosition.x, aPosition.y, aPosition.z*f, aPosition.w);\ngl_Position = uMatrix * pos;\nvec4 mPosition = vec4(uModelMatrix * pos);\nfloat distance = length(mPosition);\nif (distance > uFogDistance) {\nvColor = vec4(0.0, 0.0, 0.0, 0.0);\n} else {\nvColor = vec4(clamp(uIndex, 0.0, 1.0), aPickingColor.g, aPickingColor.b, 1.0);\n}\n}\n}\n",fs:"#ifdef GL_ES\nprecision mediump float;\n#endif\nvarying vec4 vColor;\nvoid main() {\ngl_FragColor = vColor;\n}\n"},r={name:"buildings",vs:"precision highp float; //is default in vertex shaders anyway, using highp fixes #49\n#define halfPi 1.57079632679\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nattribute vec3 aNormal;\nattribute vec3 aColor;\nattribute float aHeight;\nattribute vec4 aTintColor;\nattribute float aZScale;\nuniform mat4 uModelMatrix;\nuniform mat4 uMatrix;\nuniform mat3 uNormalTransform;\nuniform vec3 uLightDirection;\nuniform vec3 uLightColor;\nuniform vec2 uViewDirOnMap;\nuniform vec2 uLowerEdgePoint;\nuniform float uFade;\nvarying vec3 vColor;\nvarying vec2 vTexCoord;\nvarying float verticalDistanceToLowerEdge;\nconst float gradientStrength = 0.4;\nvoid main() {\nfloat f = clamp(uFade*aZScale, 0.0, 1.0);\nif (f == 0.0) {\ngl_Position = vec4(0.0, 0.0, 0.0, 0.0);\nvColor = vec3(0.0, 0.0, 0.0);\n} else {\nvec4 pos = vec4(aPosition.x, aPosition.y, aPosition.z*f, aPosition.w);\ngl_Position = uMatrix * pos;\nvec3 color = aColor;\n// tint ***********************************************\nif (aTintColor.a > 0.0) {\ncolor = mix(aColor, aTintColor.rgb, 0.5);\n}\n//*** light intensity, defined by light direction on surface ****************\nvec3 transformedNormal = aNormal * uNormalTransform;\nfloat lightIntensity = max( dot(transformedNormal, uLightDirection), 0.0) / 1.5;\ncolor = color + uLightColor * lightIntensity;\nvTexCoord = aTexCoord;\n//*** vertical shading ******************************************************\nfloat verticalShading = clamp(gradientStrength - ((pos.z*gradientStrength) / (aHeight * f)), 0.0, gradientStrength);\n//***************************************************************************\nvColor = color-verticalShading;\nvec4 worldPos = uModelMatrix * pos;\nvec2 dirFromLowerEdge = worldPos.xy / worldPos.w - uLowerEdgePoint;\nverticalDistanceToLowerEdge = dot(dirFromLowerEdge, uViewDirOnMap);\n}\n}\n",fs:"#ifdef GL_ES\nprecision mediump float;\n#endif\nvarying vec3 vColor;\nvarying vec2 vTexCoord;\nvarying float verticalDistanceToLowerEdge;\nuniform vec3 uFogColor;\nuniform float uFogDistance;\nuniform float uFogBlurDistance;\nuniform sampler2D uWallTexIndex;\nvoid main() {\n\nfloat fogIntensity = (verticalDistanceToLowerEdge - uFogDistance) / uFogBlurDistance;\nfogIntensity = clamp(fogIntensity, 0.0, 1.0);\ngl_FragColor = vec4( vColor* texture2D(uWallTexIndex, vTexCoord).rgb, 1.0-fogIntensity);\n}\n"},o={name:"buildings_with_shadows",vs:"precision highp float; //is default in vertex shaders anyway, using highp fixes #49\n#define halfPi 1.57079632679\nattribute vec4 aPosition;\nattribute vec3 aNormal;\nattribute vec3 aColor;\nattribute vec2 aTexCoord;\nattribute float aHeight;\nattribute vec4 aTintColor;\nattribute float aZScale;\nuniform mat4 uModelMatrix;\nuniform mat4 uMatrix;\nuniform mat4 uSunMatrix;\nuniform mat3 uNormalTransform;\nuniform vec2 uViewDirOnMap;\nuniform vec2 uLowerEdgePoint;\nuniform float uFade;\nvarying vec3 vColor;\nvarying vec2 vTexCoord;\nvarying vec3 vNormal;\nvarying vec3 vSunRelPosition;\nvarying float verticalDistanceToLowerEdge;\nfloat gradientStrength = 0.4;\nvoid main() {\nfloat f = clamp(uFade*aZScale, 0.0, 1.0);\nif (f == 0.0) {\ngl_Position = vec4(0.0, 0.0, 0.0, 0.0);\nvColor = vec3(0.0, 0.0, 0.0);\n} else {\nvec4 pos = vec4(aPosition.x, aPosition.y, aPosition.z*f, aPosition.w);\ngl_Position = uMatrix * pos;\nvec3 color = aColor;\n// tint ***********************************************\nif (aTintColor.a > 0.0) {\ncolor = mix(aColor, aTintColor.rgb, 0.5);\n}\n//*** light intensity, defined by light direction on surface ****************\nvNormal = aNormal;\nvTexCoord = aTexCoord;\n//vec3 transformedNormal = aNormal * uNormalTransform;\n//float lightIntensity = max( dot(aNormal, uLightDirection), 0.0) / 1.5;\n//color = color + uLightColor * lightIntensity;\n//*** vertical shading ******************************************************\nfloat verticalShading = clamp(gradientStrength - ((pos.z*gradientStrength) / (aHeight * f)), 0.0, gradientStrength);\n//***************************************************************************\nvColor = color-verticalShading;\nvec4 worldPos = uModelMatrix * pos;\nvec2 dirFromLowerEdge = worldPos.xy / worldPos.w - uLowerEdgePoint;\nverticalDistanceToLowerEdge = dot(dirFromLowerEdge, uViewDirOnMap);\n// *** shadow mapping ********\nvec4 sunRelPosition = uSunMatrix * pos;\nvSunRelPosition = (sunRelPosition.xyz / sunRelPosition.w + 1.0) / 2.0;\n}\n}\n",fs:"\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\nprecision mediump float;\n#endif\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\nvarying vec3 vNormal;\nvarying vec3 vSunRelPosition;\nvarying float verticalDistanceToLowerEdge;\nuniform vec3 uFogColor;\nuniform vec2 uShadowTexDimensions;\nuniform sampler2D uShadowTexIndex;\nuniform sampler2D uWallTexIndex;\nuniform float uFogDistance;\nuniform float uFogBlurDistance;\nuniform float uShadowStrength;\nuniform vec3 uLightDirection;\nuniform vec3 uLightColor;\nfloat isSeenBySun(const vec2 sunViewNDC, const float depth, const float bias) {\nif ( clamp( sunViewNDC, 0.0, 1.0) != sunViewNDC) //not inside sun's viewport\nreturn 1.0;\n\nfloat depthFromTexture = texture2D( uShadowTexIndex, sunViewNDC.xy).x;\n\n//compare depth values not in reciprocal but in linear depth\nreturn step(1.0/depthFromTexture, 1.0/depth + bias);\n}\nvoid main() {\nvec3 normal = normalize(vNormal); //may degenerate during per-pixel interpolation\nfloat diffuse = dot(uLightDirection, normal);\ndiffuse = max(diffuse, 0.0);\n// reduce shadow strength with:\n// - lowering sun positions, to be consistent with the shadows on the basemap (there,\n// shadows are faded out with lowering sun positions to hide shadow artifacts caused\n// when sun direction and map surface are almost perpendicular\n// - large angles between the sun direction and the surface normal, to hide shadow\n// artifacts that occur when surface normal and sun direction are almost perpendicular\nfloat shadowStrength = pow( max( min(\ndot(uLightDirection, vec3(0.0, 0.0, 1.0)),\ndot(uLightDirection, normal)\n), 0.0), 1.5);\nif (diffuse > 0.0 && shadowStrength > 0.0) {\n// note: the diffuse term is also the cosine between the surface normal and the\n// light direction\nfloat bias = clamp(0.0007*tan(acos(diffuse)), 0.0, 0.01);\nvec2 pos = fract( vSunRelPosition.xy * uShadowTexDimensions);\n\nvec2 tl = floor(vSunRelPosition.xy * uShadowTexDimensions) / uShadowTexDimensions;\nfloat tlVal = isSeenBySun( tl, vSunRelPosition.z, bias);\nfloat trVal = isSeenBySun( tl + vec2(1.0, 0.0) / uShadowTexDimensions, vSunRelPosition.z, bias);\nfloat blVal = isSeenBySun( tl + vec2(0.0, 1.0) / uShadowTexDimensions, vSunRelPosition.z, bias);\nfloat brVal = isSeenBySun( tl + vec2(1.0, 1.0) / uShadowTexDimensions, vSunRelPosition.z, bias);\nfloat occludedBySun = mix(\nmix(tlVal, trVal, pos.x),\nmix(blVal, brVal, pos.x),\npos.y);\ndiffuse *= 1.0 - (shadowStrength * (1.0 - occludedBySun));\n}\nvec3 color = vColor* texture2D( uWallTexIndex, vTexCoord.st).rgb +\n(diffuse/1.5) * uLightColor;\nfloat fogIntensity = (verticalDistanceToLowerEdge - uFogDistance) / uFogBlurDistance;\nfogIntensity = clamp(fogIntensity, 0.0, 1.0);\n//gl_FragColor = vec4( mix(color, uFogColor, fogIntensity), 1.0);\ngl_FragColor = vec4( color, 1.0-fogIntensity);\n}\n"},n={name:"basemap",vs:"precision highp float; // is default in vertex shaders anyway, using highp fixes #49\n#define halfPi 1.57079632679\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uViewMatrix;\nuniform mat4 uModelMatrix;\nuniform vec2 uViewDirOnMap;\nuniform vec2 uLowerEdgePoint;\nvarying vec2 vTexCoord;\nvarying float verticalDistanceToLowerEdge;\nvoid main() {\ngl_Position = uViewMatrix * aPosition;\nvTexCoord = aTexCoord;\nvec4 worldPos = uModelMatrix * aPosition;\nvec2 dirFromLowerEdge = worldPos.xy / worldPos.w - uLowerEdgePoint;\nverticalDistanceToLowerEdge = dot(dirFromLowerEdge, uViewDirOnMap);\n}\n",fs:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D uTexIndex;\nuniform vec3 uFogColor;\nvarying vec2 vTexCoord;\nvarying float verticalDistanceToLowerEdge;\nuniform float uFogDistance;\nuniform float uFogBlurDistance;\nvoid main() {\nfloat fogIntensity = (verticalDistanceToLowerEdge - uFogDistance) / uFogBlurDistance;\nfogIntensity = clamp(fogIntensity, 0.0, 1.0);\ngl_FragColor = vec4(texture2D(uTexIndex, vec2(vTexCoord.x, 1.0-vTexCoord.y)).rgb, 1.0-fogIntensity);\n}\n"},s={name:"basemap_with_shadows",vs:"precision highp float; //is default in vertex shaders anyway, using highp fixes #49\nattribute vec3 aPosition;\nattribute vec3 aNormal;\nuniform mat4 uModelMatrix;\nuniform mat4 uMatrix;\nuniform mat4 uSunMatrix;\nuniform vec2 uViewDirOnMap;\nuniform vec2 uLowerEdgePoint;\n//varying vec2 vTexCoord;\nvarying vec3 vSunRelPosition;\nvarying vec3 vNormal;\nvarying float verticalDistanceToLowerEdge;\nvoid main() {\nvec4 pos = vec4(aPosition.xyz, 1.0);\ngl_Position = uMatrix * pos;\nvec4 sunRelPosition = uSunMatrix * pos;\nvSunRelPosition = (sunRelPosition.xyz / sunRelPosition.w + 1.0) / 2.0;\nvNormal = aNormal;\nvec4 worldPos = uModelMatrix * pos;\nvec2 dirFromLowerEdge = worldPos.xy / worldPos.w - uLowerEdgePoint;\nverticalDistanceToLowerEdge = dot(dirFromLowerEdge, uViewDirOnMap);\n}\n",fs:"\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n/* This shader computes the diffuse brightness of the map layer. It does *not*\n* render the map texture itself, but is instead intended to be blended on top\n* of an already rendered map.\n* Note: this shader is not (and does not attempt to) be physically correct.\n* It is intented to be a blend between a useful illustration of cast\n* shadows and a mitigation of shadow casting artifacts occuring at\n* low angles on incidence.\n* Map brightness is only affected by shadows, not by light direction.\n* Shadows are darkest when light comes from straight above (and thus\n* shadows can be computed reliably) and become less and less visible\n* with the light source close to horizon (where moiré and offset\n* artifacts would otherwise be visible).\n*/\n//uniform sampler2D uTexIndex;\nuniform sampler2D uShadowTexIndex;\nuniform vec3 uFogColor;\nuniform vec3 uDirToSun;\nuniform vec2 uShadowTexDimensions;\nuniform float uShadowStrength;\nvarying vec2 vTexCoord;\nvarying vec3 vSunRelPosition;\nvarying vec3 vNormal;\nvarying float verticalDistanceToLowerEdge;\nuniform float uFogDistance;\nuniform float uFogBlurDistance;\nfloat isSeenBySun( const vec2 sunViewNDC, const float depth, const float bias) {\nif ( clamp( sunViewNDC, 0.0, 1.0) != sunViewNDC) //not inside sun's viewport\nreturn 1.0;\n\nfloat depthFromTexture = texture2D( uShadowTexIndex, sunViewNDC.xy).x;\n\n//compare depth values not in reciprocal but in linear depth\nreturn step(1.0/depthFromTexture, 1.0/depth + bias);\n}\nvoid main() {\n//vec2 tl = floor(vSunRelPosition.xy * uShadowTexDimensions) / uShadowTexDimensions;\n//gl_FragColor = vec4(vec3(texture2D( uShadowTexIndex, tl).x), 1.0);\n//return;\nfloat diffuse = dot(uDirToSun, normalize(vNormal));\ndiffuse = max(diffuse, 0.0);\n\nfloat shadowStrength = uShadowStrength * pow(diffuse, 1.5);\nif (diffuse > 0.0) {\n// note: the diffuse term is also the cosine between the surface normal and the\n// light direction\nfloat bias = clamp(0.0007*tan(acos(diffuse)), 0.0, 0.01);\n\nvec2 pos = fract( vSunRelPosition.xy * uShadowTexDimensions);\n\nvec2 tl = floor(vSunRelPosition.xy * uShadowTexDimensions) / uShadowTexDimensions;\nfloat tlVal = isSeenBySun( tl, vSunRelPosition.z, bias);\nfloat trVal = isSeenBySun( tl + vec2(1.0, 0.0) / uShadowTexDimensions, vSunRelPosition.z, bias);\nfloat blVal = isSeenBySun( tl + vec2(0.0, 1.0) / uShadowTexDimensions, vSunRelPosition.z, bias);\nfloat brVal = isSeenBySun( tl + vec2(1.0, 1.0) / uShadowTexDimensions, vSunRelPosition.z, bias);\ndiffuse = mix( mix(tlVal, trVal, pos.x),\nmix(blVal, brVal, pos.x),\npos.y);\n}\ndiffuse = mix(1.0, diffuse, shadowStrength);\n\nfloat fogIntensity = (verticalDistanceToLowerEdge - uFogDistance) / uFogBlurDistance;\nfogIntensity = clamp(fogIntensity, 0.0, 1.0);\nfloat darkness = (1.0 - diffuse);\ndarkness *= (1.0 - fogIntensity);\ngl_FragColor = vec4(vec3(1.0 - darkness), 1.0);\n}\n"},l={name:"texture",vs:"precision highp float; //is default in vertex shaders anyway, using highp fixes #49\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMatrix;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_Position = uMatrix * aPosition;\nvTexCoord = aTexCoord;\n}\n",fs:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D uTexIndex;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_FragColor = vec4(texture2D(uTexIndex, vTexCoord.st).rgb, 1.0);\n}\n"},u={name:"depth_normal",vs:"precision highp float; //is default in vertex shaders anyway, using highp fixes #49\nattribute vec4 aPosition;\nattribute vec3 aNormal;\nattribute float aZScale;\nuniform mat4 uMatrix;\nuniform mat4 uModelMatrix;\nuniform mat3 uNormalMatrix;\nuniform vec2 uViewDirOnMap;\nuniform vec2 uLowerEdgePoint;\nuniform float uFade;\nvarying float verticalDistanceToLowerEdge;\nvarying vec3 vNormal;\nvoid main() {\nfloat f = clamp(uFade*aZScale, 0.0, 1.0);\nif (f == 0.0) {\ngl_Position = vec4(0.0, 0.0, 0.0, 0.0);\nverticalDistanceToLowerEdge = 0.0;\n} else {\nvec4 pos = vec4(aPosition.x, aPosition.y, aPosition.z*f, aPosition.w);\ngl_Position = uMatrix * pos;\nvNormal = uNormalMatrix * aNormal;\nvec4 worldPos = uModelMatrix * pos;\nvec2 dirFromLowerEdge = worldPos.xy / worldPos.w - uLowerEdgePoint;\nverticalDistanceToLowerEdge = dot(dirFromLowerEdge, uViewDirOnMap);\n}\n}\n",fs:"\n#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform float uFogDistance;\nuniform float uFogBlurDistance;\nvarying float verticalDistanceToLowerEdge;\nvarying vec3 vNormal;\nvoid main() {\nfloat fogIntensity = (verticalDistanceToLowerEdge - uFogDistance) / uFogBlurDistance;\ngl_FragColor = vec4(normalize(vNormal) / 2.0 + 0.5, clamp(fogIntensity, 0.0, 1.0));\n}\n"},h={name:"ambient_from_depth",vs:"precision highp float; //is default in vertex shaders anyway, using highp fixes #49\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_Position = aPosition;\nvTexCoord = aTexCoord;\n}\n",fs:"#ifdef GL_FRAGMENT_PRECISION_HIGH\n// we need high precision for the depth values\nprecision highp float;\n#else\nprecision mediump float;\n#endif\nuniform sampler2D uDepthTexIndex;\nuniform sampler2D uFogTexIndex;\nuniform vec2 uInverseTexSize; //in 1/pixels, e.g. 1/512 if the texture is 512px wide\nuniform float uEffectStrength;\nuniform float uNearPlane;\nuniform float uFarPlane;\nvarying vec2 vTexCoord;\n/* Retrieves the depth value 'offset' pixels away from 'pos' from texture 'uDepthTexIndex'. */\nfloat getDepth(vec2 pos, ivec2 offset)\n{\nfloat z = texture2D(uDepthTexIndex, pos + float(offset) * uInverseTexSize).x;\nreturn (2.0 * uNearPlane) / (uFarPlane + uNearPlane - z * (uFarPlane - uNearPlane)); // linearize depth\n}\n/* getOcclusionFactor() determines a heuristic factor (from [0..1]) for how\n* much the fragment at 'pos' with depth 'depthHere'is occluded by the\n* fragment that is (dx, dy) texels away from it.\n*/\nfloat getOcclusionFactor(float depthHere, vec2 pos, ivec2 offset) {\nfloat depthThere = getDepth(pos, offset);\n/* if the fragment at (dx, dy) has no depth (i.e. there was nothing rendered there),\n* then 'here' is not occluded (result 1.0) */\nif (depthThere == 0.0)\nreturn 1.0;\n/* if the fragment at (dx, dy) is further away from the viewer than 'here', then\n* 'here is not occluded' */\nif (depthHere < depthThere )\nreturn 1.0;\nfloat relDepthDiff = depthThere / depthHere;\nfloat depthDiff = abs(depthThere - depthHere) * uFarPlane;\n/* if the fragment at (dx, dy) is closer to the viewer than 'here', then it occludes\n* 'here'. The occlusion is the higher the bigger the depth difference between the two\n* locations is.\n* However, if the depth difference is too high, we assume that 'there' lies in a\n* completely different depth region of the scene than 'here' and thus cannot occlude\n* 'here'. This last assumption gets rid of very dark artifacts around tall buildings.\n*/\nreturn depthDiff < 50.0 ? mix(0.99, 1.0, 1.0 - clamp(depthDiff, 0.0, 1.0)) : 1.0;\n}\n/* This shader approximates the ambient occlusion in screen space (SSAO).\n* It is based on the assumption that a pixel will be occluded by neighboring\n* pixels iff. those have a depth value closer to the camera than the original\n* pixel itself (the function getOcclusionFactor() computes this occlusion\n* by a single other pixel).\n*\n* A naive approach would sample all pixels within a given distance. For an\n* interesting-looking effect, the sampling area needs to be at least 9 pixels\n* wide (-/+ 4), requiring 81 texture lookups per pixel for ambient occlusion.\n* This overburdens many GPUs.\n* To make the ambient occlusion computation faster, we do not consider all\n* texels in the sampling area, but only 16. This causes some sampling artifacts\n* that are later removed by blurring the ambient occlusion texture (this is\n* done in a separate shader).\n*/\nvoid main() {\nfloat depthHere = getDepth(vTexCoord, ivec2(0, 0));\nfloat fogIntensity = texture2D(uFogTexIndex, vTexCoord).w;\nif (depthHere == 0.0)\n{\n\t//there was nothing rendered 'here' --\x3e it can't be occluded\ngl_FragColor = vec4(1.0);\nreturn;\n}\nfloat occlusionFactor = 1.0;\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(-1, 0));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(+1, 0));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2( 0, -1));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2( 0, +1));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(-2, -2));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(+2, +2));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(+2, -2));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(-2, +2));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(-4, 0));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(+4, 0));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2( 0, -4));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2( 0, +4));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(-4, -4));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(+4, +4));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(+4, -4));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(-4, +4));\nocclusionFactor = pow(occlusionFactor, 4.0) + 55.0/255.0; // empirical bias determined to let SSAO have no effect on the map plane\nocclusionFactor = 1.0 - ((1.0 - occlusionFactor) * uEffectStrength * (1.0-fogIntensity));\ngl_FragColor = vec4(vec3(occlusionFactor), 1.0);\n}\n"},f={name:"flat_color",vs:"precision highp float; // is default in vertex shaders anyway, using highp fixes #49\nattribute vec4 aPosition;\nuniform mat4 uMatrix;\nvoid main() {\ngl_Position = uMatrix * aPosition;\n}\n",fs:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform vec4 uColor;\nvoid main() {\ngl_FragColor = uColor;\n}\n"},c={name:"horizon",vs:"precision highp float; // is default in vertex shaders anyway, using highp fixes #49\n#define halfPi 1.57079632679\nattribute vec4 aPosition;\nuniform mat4 uMatrix;\nuniform float uAbsoluteHeight;\nvarying vec2 vTexCoord;\nvarying float vRelativeHeight;\nvoid main() {\ngl_Position = uMatrix * aPosition;\nvRelativeHeight = aPosition.z / uAbsoluteHeight;\n}\n",fs:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform vec3 uFogColor;\nvarying float vRelativeHeight;\nvoid main() {\nfloat blendFactor = min(100.0 * vRelativeHeight, 1.0);\nvec4 skyColor = vec4(0.9, 0.85, 1.0, 1.0);\ngl_FragColor = mix(vec4(uFogColor, 1.0), skyColor, blendFactor);\n}\n"},d={name:"blur",vs:"precision highp float; // is default in vertex shaders anyway, using highp fixes #49\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_Position = aPosition;\nvTexCoord = aTexCoord;\n}\n",fs:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D uTexIndex;\nuniform vec2 uInverseTexSize; // as 1/n pixels, e.g. 1/512 if the texture is 512px wide\nvarying vec2 vTexCoord;\n// Retrieves the texel color 'offset' pixels away from 'pos' from texture 'uTexIndex'.\nvec4 getTexel(vec2 pos, vec2 offset) {\nreturn texture2D(uTexIndex, pos + offset * uInverseTexSize);\n}\nvoid main() {\nvec4 center = texture2D(uTexIndex, vTexCoord);\nvec4 nonDiagonalNeighbors = getTexel(vTexCoord, vec2(-1.0, 0.0)) +\ngetTexel(vTexCoord, vec2(+1.0, 0.0)) +\ngetTexel(vTexCoord, vec2( 0.0, -1.0)) +\ngetTexel(vTexCoord, vec2( 0.0, +1.0));\nvec4 diagonalNeighbors = getTexel(vTexCoord, vec2(-1.0, -1.0)) +\ngetTexel(vTexCoord, vec2(+1.0, +1.0)) +\ngetTexel(vTexCoord, vec2(-1.0, +1.0)) +\ngetTexel(vTexCoord, vec2(+1.0, -1.0));\n\n// approximate Gaussian blur (mean 0.0, stdev 1.0)\ngl_FragColor = 0.2/1.0 * center +\n0.5/4.0 * nonDiagonalNeighbors +\n0.3/4.0 * diagonalNeighbors;\n}\n"},m={name:"marker",vs:"precision highp float; // is default in vertex shaders anyway, using highp fixes #49\nattribute vec4 aPosition;\n// uniform mat4 uMatrix;\nuniform mat4 uProjMatrix;\nuniform mat4 uViewMatrix;\nuniform mat4 uModelMatrix;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nvoid main() {\nmat4 modelView = uViewMatrix * uModelMatrix;\nmodelView[0][0] = 1.0;\nmodelView[0][1] = 0.0;\nmodelView[0][2] = 0.0;\nmodelView[1][0] = 0.0;\nmodelView[1][1] = 1.0;\nmodelView[1][2] = 0.0;\nmodelView[2][0] = 0.0;\nmodelView[2][1] = 0.0;\nmodelView[2][2] = 1.0;\nmat4 mvp = uProjMatrix * modelView;\nfloat reciprScaleOnscreen = 0.02;\nfloat w = (mvp * vec4(0,0,0,1)).w;\nw *= reciprScaleOnscreen;\nvec4 pos = vec4((aPosition.x * w), (aPosition.y * w) , aPosition.z * w, 1);\ngl_Position = mvp * pos;\nvTexCoord = aTexCoord;\n}\n",fs:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D uTexIndex;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_FragColor = texture2D(uTexIndex, vTexCoord);\n}\n"},g='class Request{static load(e,t){const r=new XMLHttpRequest,n=setTimeout(e=>{4!==r.readyState&&(r.abort(),t("status"))},1e4);return r.onreadystatechange=(()=>{4===r.readyState&&(clearTimeout(n),!r.status||r.status<200||r.status>299?t("status"):t(null,r))}),r.open("GET",e),r.send(null),{abort:()=>{r.abort()}}}static getText(e,t){return this.load(e,(e,r)=>{e?t(e):void 0!==r.responseText?t(null,r.responseText):t("content")})}static getXML(e,t){return this.load(e,(e,r)=>{e?t(e):void 0!==r.responseXML?t(null,r.responseXML):t("content")})}static getJSON(e,t){return this.load(e,(r,n)=>{if(r)return void t(r);if(!n.responseText)return void t("content");let o;try{o=JSON.parse(n.responseText),t(null,o)}catch(r){console.warn(`Could not parse JSON from ${e}\\n${r.message}`),t("content")}})}}var Qolor=function(){var e={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgrey:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};function t(e,t,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+6*(t-e)*r:r<.5?t:r<2/3?e+(t-e)*(2/3-r)*6:e}function r(e,t){if(void 0!==e)return Math.min(t,Math.max(0,e||0))}var n=function(e,t,n,o){this.r=r(e,1),this.g=r(t,1),this.b=r(n,1),this.a=r(o,1)||1};return n.parse=function(t){if("string"==typeof t){var r;if(t=t.toLowerCase(),r=(t=e[t]||t).match(/^#?(\\w{2})(\\w{2})(\\w{2})$/))return new n(parseInt(r[1],16)/255,parseInt(r[2],16)/255,parseInt(r[3],16)/255);if(r=t.match(/^#?(\\w)(\\w)(\\w)$/))return new n(parseInt(r[1]+r[1],16)/255,parseInt(r[2]+r[2],16)/255,parseInt(r[3]+r[3],16)/255);if(r=t.match(/rgba?\\((\\d+)\\D+(\\d+)\\D+(\\d+)(\\D+([\\d.]+))?\\)/))return new n(parseFloat(r[1])/255,parseFloat(r[2])/255,parseFloat(r[3])/255,r[4]?parseFloat(r[5]):1)}return new n},n.fromHSL=function(e,t,r){var o=(new n).fromHSL(e,t,r);return o.a=a,o},n.prototype={isValid:function(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b},toHSL:function(){if(this.isValid()){var e,t,r=Math.max(this.r,this.g,this.b),n=Math.min(this.r,this.g,this.b),o=(r+n)/2,a=r-n;if(a){switch(t=o>.5?a/(2-r-n):a/(r+n),r){case this.r:e=(this.g-this.b)/a+(this.g<this.b?6:0);break;case this.g:e=(this.b-this.r)/a+2;break;case this.b:e=(this.r-this.g)/a+4}e*=60}else e=t=0;return{h:e,s:t,l:o}}},fromHSL:function(e,r,n){if(0===r)return this.r=this.g=this.b=n,this;var o=n<.5?n*(1+r):n+r-n*r,a=2*n-o;return e/=360,this.r=t(a,o,e+1/3),this.g=t(a,o,e),this.b=t(a,o,e-1/3),this},toString:function(){if(this.isValid())return 1===this.a?"#"+((1<<24)+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1,7):"rgba("+[Math.round(255*this.r),Math.round(255*this.g),Math.round(255*this.b),this.a.toFixed(2)].join(",")+")"},toArray:function(){if(this.isValid)return[this.r,this.g,this.b]},hue:function(e){var t=this.toHSL();return this.fromHSL(t.h+e,t.s,t.l)},saturation:function(e){var t=this.toHSL();return this.fromHSL(t.h,t.s*e,t.l)},lightness:function(e){var t=this.toHSL();return this.fromHSL(t.h,t.s,t.l*e)},clone:function(){return new n(this.r,this.g,this.b,this.a)}},n}();"object"==typeof module&&(module.exports=Qolor);class OBJ{constructor(e,t){this.materialIndex={},this.vertexIndex=[],t&&this.readMTL(t),this.meshes=[],this.readOBJ(e)}readMTL(e){const t=e.split(/[\\r\\n]/g);let r,n=[];t.forEach(e=>{const t=e.trim().split(/\\s+/);switch(t[0]){case"newmtl":r&&(this.materialIndex[r]=n),r=t[1],n=[];break;case"Kd":n=[parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3])]}}),r&&(this.materialIndex[r]=n),e=null}readOBJ(e){let t,r,n=[];e.split(/[\\r\\n]/g).forEach(e=>{const o=e.trim().split(/\\s+/);switch(o[0]){case"g":case"o":this.storeMesh(t,r,n),t=o[1],n=[];break;case"usemtl":this.storeMesh(t,r,n),this.materialIndex[o[1]]&&(r=this.materialIndex[o[1]]),n=[];break;case"v":this.vertexIndex.push([parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3])]);break;case"f":n.push([parseFloat(o[1])-1,parseFloat(o[2])-1,parseFloat(o[3])-1])}}),this.storeMesh(t,r,n)}storeMesh(e,t,r){if(r.length){const n=this.createGeometry(r);this.meshes.push({...n,color:t,id:e})}}sub(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]}unit(e){const t=this.len(e);return[e[0]/t,e[1]/t,e[2]/t]}normal(e,t,r){const n=this.sub(e,t),o=this.sub(t,r);return this.unit([n[1]*o[2]-n[2]*o[1],n[2]*o[0]-n[0]*o[2],n[0]*o[1]-n[1]*o[0]])}createGeometry(e){const t=[],r=[],n=[];let o=-1/0;return e.forEach(e=>{const a=this.vertexIndex[e[0]],i=this.vertexIndex[e[1]],s=this.vertexIndex[e[2]],l=this.normal(a,i,s);t.push(a[0],a[2],a[1],i[0],i[2],i[1],s[0],s[2],s[1]),r.push(l[0],l[1],l[2],l[0],l[1],l[2],l[0],l[1],l[2]),n.push(0,0,0,0,0,0),o=Math.max(o,a[1],i[1],s[1])}),{vertices:t,normals:r,texCoords:n,height:o}}}OBJ.parse=function(e,t){return new OBJ(e,t).meshes};const triangulate=function(){const e=10,t=[.8627450980392157,.8235294117647058,.7843137254901961];METERS_PER_LEVEL=3;const r={brick:"#cc7755",bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",glass:"#e8f8f8",gold:"#ffcc00",plants:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},n={asphalt:"tar_paper",bitumen:"tar_paper",block:"stone",bricks:"brick",glas:"glass",glassfront:"glass",grass:"plants",masonry:"stone",granite:"stone",panels:"panel",paving_stones:"stone",plastered:"plaster",rooftiles:"roof_tiles",roofingfelt:"tar_paper",sandstone:"stone",sheet:"canvas",sheets:"canvas",shingle:"tar_paper",shingles:"tar_paper",slates:"slate",steel:"metal",tar:"tar_paper",tent:"canvas",thatch:"plants",tile:"roof_tiles",tiles:"roof_tiles"},o=.5,a=6378137*Math.PI/180;function i(e){return"string"!=typeof e?null:"#"===(e=e.toLowerCase())[0]?e:r[n[e]||e]||null}function s(e,r){r=r||0;let n,o=Qolor.parse(e);return[(n=o.isValid()?o.saturation(.7).toArray():t)[0]+r,n[1]+r,n[2]+r]}return function(t,r,n,l,f){const c=[a*Math.cos(n[1]/180*Math.PI),a];(function(e){switch(e.type){case"MultiPolygon":return e.coordinates;case"Polygon":return[e.coordinates];default:return[]}})(r.geometry).map(a=>{const u=function(e,t,r){return e.map((e,n)=>(0===n!==function(e){return 0<e.reduce((e,t,r,n)=>e+(r<n.length-1?(n[r+1][0]-t[0])*(n[r+1][1]+t[1]):0),0)}(e)&&e.reverse(),e.map(function(e){return[(e[0]-t[0])*r[0],-(e[1]-t[1])*r[1]]})))}(a,n,c);!function(t,r,n,a,l){const f=function(t,r){const n={};switch(n.center=[r.minX+(r.maxX-r.minX)/2,r.minY+(r.maxY-r.minY)/2],n.radius=(r.maxX-r.minX)/2,n.roofHeight=t.roofHeight||(t.roofLevels?t.roofLevels*METERS_PER_LEVEL:0),t.roofShape){case"cone":case"pyramid":case"dome":case"onion":n.roofHeight=n.roofHeight||1*n.radius;break;case"gabled":case"hipped":case"half-hipped":case"skillion":case"gambrel":case"mansard":case"round":n.roofHeight=n.roofHeight||1*METERS_PER_LEVEL;break;case"flat":n.roofHeight=0;break;default:n.roofHeight=0}let o;if(n.wallZ=t.minHeight||(t.minLevel?t.minLevel*METERS_PER_LEVEL:0),void 0!==t.height)o=t.height,n.roofHeight=Math.min(n.roofHeight,o),n.roofZ=o-n.roofHeight,n.wallHeight=o-n.roofHeight-n.wallZ;else if(void 0!==t.levels)o=t.levels*METERS_PER_LEVEL,n.roofZ=o,n.wallHeight=o-n.wallZ;else{switch(t.shape){case"cone":case"dome":case"pyramid":o=2*n.radius,n.roofHeight=0;break;case"sphere":o=4*n.radius,n.roofHeight=0;break;default:o=e}n.roofZ=o,n.wallHeight=o-n.wallZ}return n}(r,function(e){let t=1/0,r=1/0,n=-1/0,o=-1/0;for(let a=0;a<e.length;a++)t=Math.min(t,e[a][0]),r=Math.min(r,e[a][1]),n=Math.max(n,e[a][0]),o=Math.max(o,e[a][1]);return{minX:t,minY:r,maxX:n,maxY:o}}(n[0])),c=s(a||r.wallColor||r.color||i(r.material),l),u=s(a||r.roofColor||i(r.roofMaterial),l);switch(r.shape){case"cone":return void split.cylinder(t,f.center,f.radius,0,f.wallHeight,f.wallZ,c);case"dome":return void split.dome(t,f.center,f.radius,f.wallHeight,f.wallZ,c);case"pyramid":return void split.pyramid(t,n,f.center,f.wallHeight,f.wallZ,c);case"sphere":return void split.sphere(t,f.center,f.radius,f.wallHeight,f.wallZ,c)}switch(createRoof(t,r,n,f,u,c),r.shape){case"none":return;case"cylinder":return void split.cylinder(t,f.center,f.radius,f.radius,f.wallHeight,f.wallZ,c);default:let e=.2,a=.4;"glass"!==r.material&&(e=0,a=0,r.levels&&(a=parseFloat(r.levels)-parseFloat(r.minLevel||0)<<0)),split.extrusion(t,n,f.wallHeight,f.wallZ,c,[0,o,e/f.wallHeight,a/f.wallHeight])}}(t,r.properties,u,l,f)})}}();var createRoof;function pointOnSegment(e,t){return e[0]>=Math.min(t[0][0],t[1][0])&&e[0]<=Math.max(t[1][0],t[0][0])&&e[1]>=Math.min(t[0][1],t[1][1])&&e[1]<=Math.max(t[1][1],t[0][1])}function getVectorSegmentIntersection(e,t,r){var n,o,a,i,s,l=r[0],f=[r[1][0]-r[0][0],r[1][1]-r[0][1]];if(0!==t[0]||0!==f[0]){if(0!==t[0]&&(a=t[1]/t[0],n=e[1]-a*e[0]),0!==f[0]&&(i=f[1]/f[0],o=l[1]-i*l[0]),0===t[0]&&pointOnSegment(s=[e[0],i*e[0]+o],r))return s;if(0===f[0]&&pointOnSegment(s=[l[0],a*l[0]+n],r))return s;if(a!==i){var c=(o-n)/(a-i);return pointOnSegment(s=[c,a*c+n],r)?s:void 0}}}function getDistanceToLine(e,t){var r=t[0],n=t[1];if(r[0]!==n[0]||r[1]!==n[1]){var o=(n[1]-r[1])/(n[0]-r[0]),a=r[1]-o*r[0];if(0===o)return Math.abs(a-e[1]);if(o===1/0)return Math.abs(r[0]-e[0]);var i=-1/o,s=(e[1]-i*e[0]-a)/(o-i),l=o*s+a,f=e[0]-s,c=e[1]-l;return Math.sqrt(f*f+c*c)}}!function(){function e(e,r,n,o,a,i,s){if(0,n.length>1||void 0===r.roofDirection)return t(e,r,n,a,i);var l=(r.roofDirection/180-.5)*Math.PI,f=[Math.cos(l),Math.sin(l)],c=function(e,t,r){for(var n,o=[],a=0;a<r.length-1;a++)if(void 0!==(n=getVectorSegmentIntersection(e,t,[r[a],r[a+1]]))){if(2===o.length)return;a++,r.splice(a,0,n),o.push(a)}if(!(o.length<2))return{index:o,roof:r}}(a.center,f,n[0]);if(!c)return t(e,r,n,a,i);for(var u,h=c.index,p=c.roof,d=[],g=0,x=[p[h[0]],p[h[1]]],v=0;v<p.length;v++)d[v]=getDistanceToLine(p[v],x),g=Math.max(g,d[v]);for(v=0;v<p.length;v++)p[v][2]=(1-d[v]/g)*a.roofHeight;for(u=p.slice(h[0],h[1]+1),split.polygon(e,[u],a.roofZ,i),u=(u=p.slice(h[1],p.length-1)).concat(p.slice(0,h[0]+1)),split.polygon(e,[u],a.roofZ,i),v=0;v<p.length-1;v++)0===p[v][2]&&0===p[v+1][2]||split.quad(e,[p[v][0],p[v][1],a.roofZ+p[v][2]],[p[v][0],p[v][1],a.roofZ],[p[v+1][0],p[v+1][1],a.roofZ],[p[v+1][0],p[v+1][1],a.roofZ+p[v+1][2]],s)}function t(e,t,r,n,o){"cylinder"===t.shape?split.circle(e,n.center,n.radius,n.roofZ,o):split.polygon(e,r,n.roofZ,o)}createRoof=function(r,n,o,a,i,s){switch(n.roofShape){case"cone":return function(e,t,r,n){split.polygon(e,t,r.roofZ,n),split.cylinder(e,r.center,r.radius,0,r.roofHeight,r.roofZ,n)}(r,o,a,i);case"dome":return function(e,t,r,n){split.polygon(e,t,r.roofZ,n),split.dome(e,r.center,r.radius,r.roofHeight,r.roofZ,n)}(r,o,a,i);case"pyramid":return function(e,t,r,n,o){"cylinder"===t.shape?split.cylinder(e,n.center,n.radius,0,n.roofHeight,n.roofZ,o):split.pyramid(e,r,n.center,n.roofHeight,n.roofZ,o)}(r,n,o,a,i);case"skillion":return function(e,r,n,o,a,i){if(void 0===r.roofDirection)return t(e,r,n,o,a);var s,l,f=r.roofDirection/180*Math.PI,c=1/0,u=-1/0;n[0].forEach(function(e){var t=e[1]*Math.cos(-f)+e[0]*Math.sin(-f);t<c&&(c=t,s=e),t>u&&(u=t,l=e)});var h=n[0],p=[Math.cos(f),Math.sin(f)],d=[s,[s[0]+p[0],s[1]+p[1]]],g=getDistanceToLine(l,d);n.forEach(function(e){e.forEach(function(e){var t=getDistanceToLine(e,d);e[2]=t/g*o.roofHeight})}),split.polygon(e,[h],o.roofZ,a),n.forEach(function(t){for(var r=0;r<t.length-1;r++)0===t[r][2]&&0===t[r+1][2]||split.quad(e,[t[r][0],t[r][1],o.roofZ+t[r][2]],[t[r][0],t[r][1],o.roofZ],[t[r+1][0],t[r+1][1],o.roofZ],[t[r+1][0],t[r+1][1],o.roofZ+t[r+1][2]],i)})}(r,n,o,a,i,s);case"gabled":return e(r,n,o,0,a,i,s);case"hipped":case"half-hipped":return t(r,n,o,a,i);case"gambrel":case"mansard":return e(r,n,o,0,a,i,s);case"round":return function(e,r,n,o,a,i){if(n.length>1||void 0===r.roofDirection)return t(e,r,n,o,a);return t(e,r,n,o,a)}(r,n,o,a,i);case"onion":return function(e,t,r,n){split.polygon(e,t,r.roofZ,n);for(var o,a,i=[{rScale:.8,hScale:0},{rScale:.9,hScale:.18},{rScale:.9,hScale:.35},{rScale:.8,hScale:.47},{rScale:.6,hScale:.59},{rScale:.5,hScale:.65},{rScale:.2,hScale:.82},{rScale:0,hScale:1}],s=0,l=i.length-1;s<l;s++)o=r.roofHeight*i[s].hScale,a=r.roofHeight*i[s+1].hScale,split.cylinder(e,r.center,r.radius*i[s].rScale,r.radius*i[s+1].rScale,a-o,r.roofZ+o,n)}(r,o,a,i);default:return t(r,n,o,a,i)}}}();const split={NUM_Y_SEGMENTS:24,NUM_X_SEGMENTS:32,quad:(e,t,r,n,o,a)=>{split.triangle(e,t,r,n,a),split.triangle(e,n,o,t,a)},triangle:(e,t,r,n,o)=>{const a=vec3.normal(t,r,n);[].push.apply(e.vertices,[].concat(t,n,r)),[].push.apply(e.normals,[].concat(a,a,a)),[].push.apply(e.colors,[].concat(o,o,o)),e.texCoords.push(0,0,0,0,0,0)},circle:(e,t,r,n,o)=>{let a,i;n=n||0;for(let s=0;s<split.NUM_X_SEGMENTS;s++)a=s/split.NUM_X_SEGMENTS,i=(s+1)/split.NUM_X_SEGMENTS,split.triangle(e,[t[0]+r*Math.sin(a*Math.PI*2),t[1]+r*Math.cos(a*Math.PI*2),n],[t[0],t[1],n],[t[0]+r*Math.sin(i*Math.PI*2),t[1]+r*Math.cos(i*Math.PI*2),n],o)},polygon:(e,t,r,n)=>{r=r||0;const o=[],a=[];let i,s,l=0;t.forEach((e,n)=>{e.forEach(e=>{o.push(e[0],e[1],r+(e[2]||0))}),n&&(l+=t[n-1].length,a.push(l))});const f=earcut(o,a,3);let c,u,h;for(i=0,s=f.length-2;i<s;i+=3)c=3*f[i],u=3*f[i+1],h=3*f[i+2],split.triangle(e,[o[c],o[c+1],o[c+2]],[o[u],o[u+1],o[u+2]],[o[h],o[h+1],o[h+2]],n)},cube:(e,t,r,n,o,a,i,s)=>{const l=[o=o||0,a=a||0,i=i||0],f=[o+t,a,i],c=[o+t,a+r,i],u=[o,a+r,i],h=[o,a,i+n],p=[o+t,a,i+n],d=[o+t,a+r,i+n],g=[o,a+r,i+n];split.quad(e,f,l,u,c,s),split.quad(e,h,p,d,g,s),split.quad(e,l,f,p,h,s),split.quad(e,f,c,d,p,s),split.quad(e,c,u,g,d,s),split.quad(e,u,l,h,g,s)},cylinder:(e,t,r,n,o,a,i)=>{a=a||0;const s=split.NUM_X_SEGMENTS,l=2*Math.PI;let f,c,u,h,p,d;for(let g=0;g<s;g++)f=g/s*l,c=(g+1)/s*l,u=Math.sin(f),h=Math.cos(f),p=Math.sin(c),d=Math.cos(c),split.triangle(e,[t[0]+r*u,t[1]+r*h,a],[t[0]+n*p,t[1]+n*d,a+o],[t[0]+r*p,t[1]+r*d,a],i),0!==n&&split.triangle(e,[t[0]+n*u,t[1]+n*h,a+o],[t[0]+n*p,t[1]+n*d,a+o],[t[0]+r*u,t[1]+r*h,a],i)},dome:(e,t,r,n,o,a,i)=>{o=o||0;const s=split.NUM_Y_SEGMENTS/2,l=Math.PI/2,f=i?0:-l;let c,u,h,p,d,g,x,v,m,y;for(let i=0;i<s;i++)c=i/s*l+f,u=(i+1)/s*l+f,h=Math.cos(c),p=Math.sin(c),x=h*r,v=(d=Math.cos(u))*r,m=((g=Math.sin(u))-p)*n,y=o-g*n,split.cylinder(e,t,v,x,m,y,a)},sphere:(e,t,r,n,o,a)=>{o=o||0;let i=0;return i+=split.dome(e,t,r,n/2,o+n/2,a,!0),i+=split.dome(e,t,r,n/2,o+n/2,a)},pyramid:(e,t,r,n,o,a)=>{o=o||0;for(let i=0,s=(t=t[0]).length-1;i<s;i++)split.triangle(e,[t[i][0],t[i][1],o],[t[i+1][0],t[i+1][1],o],[r[0],r[1],o+n],a)},extrusion:(e,t,r,n,o,a)=>{n=n||0;let i,s,l,f,c,u,h,p,d,g,x,v,m=a[2]*r,y=a[3]*r;t.forEach(t=>{for(x=0,v=t.length-1;x<v;x++)i=t[x],s=t[x+1],l=vec2.len(vec2.sub(i,s)),f=[i[0],i[1],n],c=[s[0],s[1],n],u=[s[0],s[1],n+r],h=[i[0],i[1],n+r],p=vec3.normal(f,c,u),[].push.apply(e.vertices,[].concat(f,u,c,f,h,u)),[].push.apply(e.normals,[].concat(p,p,p,p,p,p)),[].push.apply(e.colors,[].concat(o,o,o,o,o,o)),d=a[0]*l<<0,g=a[1]*l<<0,e.texCoords.push(d,y,g,m,g,y,d,y,d,m,g,m)})}};var earcut=function(){function e(e,o,a){a=a||2;var i,s,c,h,p,d,g,x=o&&o.length,v=x?o[0]*a:e.length,m=t(e,0,v,a,!0),y=[];if(!m)return y;if(x&&(m=function(e,n,o,a){var i,s,c,h,p,d=[];for(i=0,s=n.length;i<s;i++)c=n[i]*a,h=i<s-1?n[i+1]*a:e.length,(p=t(e,c,h,a,!1))===p.next&&(p.steiner=!0),d.push(u(p));for(d.sort(l),i=0;i<d.length;i++)f(d[i],o),o=r(o,o.next);return o}(e,o,m,a)),e.length>80*a){i=c=e[0],s=h=e[1];for(var b=a;b<v;b+=a)(p=e[b])<i&&(i=p),(d=e[b+1])<s&&(s=d),p>c&&(c=p),d>h&&(h=d);g=Math.max(c-i,h-s)}return n(m,y,a,i,s,g),y}function t(e,t,r,n,o){var a,i;if(o===w(e,t,r,n)>0)for(a=t;a<r;a+=n)i=y(a,e[a],e[a+1],i);else for(a=r-n;a>=t;a-=n)i=y(a,e[a],e[a+1],i);return i&&g(i,i.next)&&(b(i),i=i.next),i}function r(e,t){if(!e)return e;t||(t=e);var r,n=e;do{if(r=!1,n.steiner||!g(n,n.next)&&0!==d(n.prev,n,n.next))n=n.next;else{if(b(n),(n=t=n.prev)===n.next)return null;r=!0}}while(r||n!==t);return t}function n(e,t,l,f,u,h,p){if(e){!p&&h&&function(e,t,r,n){var o=e;do{null===o.z&&(o.z=c(o.x,o.y,t,r,n)),o.prevZ=o.prev,o.nextZ=o.next,o=o.next}while(o!==e);o.prevZ.nextZ=null,o.prevZ=null,function(e){var t,r,n,o,a,i,s,l,f=1;do{for(r=e,e=null,a=null,i=0;r;){for(i++,n=r,s=0,t=0;t<f&&(s++,n=n.nextZ);t++);for(l=f;s>0||l>0&&n;)0===s?(o=n,n=n.nextZ,l--):0!==l&&n?r.z<=n.z?(o=r,r=r.nextZ,s--):(o=n,n=n.nextZ,l--):(o=r,r=r.nextZ,s--),a?a.nextZ=o:e=o,o.prevZ=a,a=o;r=n}a.nextZ=null,f*=2}while(i>1)}(o)}(e,f,u,h);for(var d,g,x=e;e.prev!==e.next;)if(d=e.prev,g=e.next,h?a(e,f,u,h):o(e))t.push(d.i/l),t.push(e.i/l),t.push(g.i/l),b(e),e=g.next,x=g.next;else if((e=g)===x){p?1===p?n(e=i(e,t,l),t,l,f,u,h,2):2===p&&s(e,t,l,f,u,h):n(r(e),t,l,f,u,h,1);break}}}function o(e){var t=e.prev,r=e,n=e.next;if(d(t,r,n)>=0)return!1;for(var o=e.next.next;o!==e.prev;){if(h(t.x,t.y,r.x,r.y,n.x,n.y,o.x,o.y)&&d(o.prev,o,o.next)>=0)return!1;o=o.next}return!0}function a(e,t,r,n){var o=e.prev,a=e,i=e.next;if(d(o,a,i)>=0)return!1;for(var s=o.x<a.x?o.x<i.x?o.x:i.x:a.x<i.x?a.x:i.x,l=o.y<a.y?o.y<i.y?o.y:i.y:a.y<i.y?a.y:i.y,f=o.x>a.x?o.x>i.x?o.x:i.x:a.x>i.x?a.x:i.x,u=o.y>a.y?o.y>i.y?o.y:i.y:a.y>i.y?a.y:i.y,p=c(s,l,t,r,n),g=c(f,u,t,r,n),x=e.nextZ;x&&x.z<=g;){if(x!==e.prev&&x!==e.next&&h(o.x,o.y,a.x,a.y,i.x,i.y,x.x,x.y)&&d(x.prev,x,x.next)>=0)return!1;x=x.nextZ}for(x=e.prevZ;x&&x.z>=p;){if(x!==e.prev&&x!==e.next&&h(o.x,o.y,a.x,a.y,i.x,i.y,x.x,x.y)&&d(x.prev,x,x.next)>=0)return!1;x=x.prevZ}return!0}function i(e,t,r){var n=e;do{var o=n.prev,a=n.next.next;!g(o,a)&&x(o,n,n.next,a)&&v(o,a)&&v(a,o)&&(t.push(o.i/r),t.push(n.i/r),t.push(a.i/r),b(n),b(n.next),n=e=a),n=n.next}while(n!==e);return n}function s(e,t,o,a,i,s){var l=e;do{for(var f=l.next.next;f!==l.prev;){if(l.i!==f.i&&p(l,f)){var c=m(l,f);return l=r(l,l.next),c=r(c,c.next),n(l,t,o,a,i,s),void n(c,t,o,a,i,s)}f=f.next}l=l.next}while(l!==e)}function l(e,t){return e.x-t.x}function f(e,t){if(t=function(e,t){var r,n=t,o=e.x,a=e.y,i=-1/0;do{if(a<=n.y&&a>=n.next.y){var s=n.x+(a-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=o&&s>i){if(i=s,s===o){if(a===n.y)return n;if(a===n.next.y)return n.next}r=n.x<n.next.x?n:n.next}}n=n.next}while(n!==t);if(!r)return null;if(o===i)return r.prev;var l,f=r,c=r.x,u=r.y,p=1/0;n=r.next;for(;n!==f;)o>=n.x&&n.x>=c&&h(a<u?o:i,a,c,u,a<u?i:o,a,n.x,n.y)&&((l=Math.abs(a-n.y)/(o-n.x))<p||l===p&&n.x>r.x)&&v(n,e)&&(r=n,p=l),n=n.next;return r}(e,t)){var n=m(t,e);r(n,n.next)}}function c(e,t,r,n,o){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)/o)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/o)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function u(e){var t=e,r=e;do{t.x<r.x&&(r=t),t=t.next}while(t!==e);return r}function h(e,t,r,n,o,a,i,s){return(o-i)*(t-s)-(e-i)*(a-s)>=0&&(e-i)*(n-s)-(r-i)*(t-s)>=0&&(r-i)*(a-s)-(o-i)*(n-s)>=0}function p(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var r=e;do{if(r.i!==e.i&&r.next.i!==e.i&&r.i!==t.i&&r.next.i!==t.i&&x(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}(e,t)&&v(e,t)&&v(t,e)&&function(e,t){var r=e,n=!1,o=(e.x+t.x)/2,a=(e.y+t.y)/2;do{r.y>a!=r.next.y>a&&o<(r.next.x-r.x)*(a-r.y)/(r.next.y-r.y)+r.x&&(n=!n),r=r.next}while(r!==e);return n}(e,t)}function d(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function g(e,t){return e.x===t.x&&e.y===t.y}function x(e,t,r,n){return!!(g(e,t)&&g(r,n)||g(e,n)&&g(r,t))||d(e,t,r)>0!=d(e,t,n)>0&&d(r,n,e)>0!=d(r,n,t)>0}function v(e,t){return d(e.prev,e,e.next)<0?d(e,t,e.next)>=0&&d(e,e.prev,t)>=0:d(e,t,e.prev)<0||d(e,e.next,t)<0}function m(e,t){var r=new M(e.i,e.x,e.y),n=new M(t.i,t.x,t.y),o=e.next,a=t.prev;return e.next=t,t.prev=e,r.next=o,o.prev=r,n.next=r,r.prev=n,a.next=n,n.prev=a,n}function y(e,t,r,n){var o=new M(e,t,r);return n?(o.next=n.next,o.prev=n,n.next.prev=o,n.next=o):(o.prev=o,o.next=o),o}function b(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function M(e,t,r){this.i=e,this.x=t,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function w(e,t,r,n){for(var o=0,a=t,i=r-n;a<r;a+=n)o+=(e[i]-e[a])*(e[a+1]+e[i+1]),i=a;return o}return e.deviation=function(e,t,r,n){var o,a,i=t&&t.length,s=i?t[0]*r:e.length,l=Math.abs(w(e,0,s,r));if(i)for(o=0,a=t.length;o<a;o++){var f=t[o]*r,c=o<a-1?t[o+1]*r:e.length;l-=Math.abs(w(e,f,c,r))}var u=0;for(o=0,a=n.length;o<a;o+=3){var h=n[o]*r,p=n[o+1]*r,d=n[o+2]*r;u+=Math.abs((e[h]-e[d])*(e[p+1]-e[h+1])-(e[h]-e[p])*(e[d+1]-e[h+1]))}return 0===l&&0===u?0:Math.abs((u-l)/l)},e.flatten=function(e){for(var t=e[0][0].length,r={vertices:[],holes:[],dimensions:t},n=0,o=0;o<e.length;o++){for(var a=0;a<e[o].length;a++)for(var i=0;i<t;i++)r.vertices.push(e[o][a][i]);o>0&&(n+=e[o-1].length,r.holes.push(n))}return r},e}();const vec3={len:e=>Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),sub:(e,t)=>[e[0]-t[0],e[1]-t[1],e[2]-t[2]],unit:e=>{const t=vec3.len(e);return[e[0]/t,e[1]/t,e[2]/t]},normal:(e,t,r)=>{const n=vec3.sub(e,t),o=vec3.sub(t,r);return vec3.unit([n[1]*o[2]-n[2]*o[1],n[2]*o[0]-n[0]*o[2],n[0]*o[1]-n[1]*o[0]])}},vec2={len:e=>Math.sqrt(e[0]*e[0]+e[1]*e[1]),add:(e,t)=>[e[0]+t[0],e[1]+t[1]],sub:(e,t)=>[e[0]-t[0],e[1]-t[1]],dot:(e,t)=>e[1]*t[0]-e[0]*t[1],scale:(e,t)=>[e[0]*t,e[1]*t],equals:(e,t)=>e[0]===t[0]&&e[1]===t[1]};function getOrigin(e){const t=e.coordinates;switch(e.type){case"Point":return t;case"MultiPoint":case"LineString":return t[0];case"MultiLineString":case"Polygon":return t[0][0];case"MultiPolygon":return t[0][0][0]}}function getPickingColor(e){return[0,(255&++e)/255,(e>>8&255)/255]}function postResult(e,t,r){const n={items:e,position:t,vertices:new Float32Array(r.vertices),normals:new Float32Array(r.normals),colors:new Float32Array(r.colors),texCoords:new Float32Array(r.texCoords),heights:new Float32Array(r.heights),pickingColors:new Float32Array(r.pickingColors)};postMessage(n,[n.vertices.buffer,n.normals.buffer,n.colors.buffer,n.texCoords.buffer,n.heights.buffer,n.pickingColors.buffer])}function loadGeoJSON(e){"object"==typeof e.url?(postMessage("load"),processGeoJSON(e.url,e.options)):Request.getJSON(e.url,(t,r)=>{t?postMessage("error"):(postMessage("load"),processGeoJSON(r,e.options))})}function processGeoJSON(e,t){if(!e||!e.features.length)return void postMessage("error");const r={vertices:[],normals:[],colors:[],texCoords:[],heights:[],pickingColors:[]},n=[],o=getOrigin(e.features[0].geometry),a={latitude:o[1],longitude:o[0]};e.features.forEach((e,a)=>{const i=e.properties,s=t.id||e.id,l=getPickingColor(a);let f=r.vertices.length;triangulate(r,e,o),f=(r.vertices.length-f)/3;for(let e=0;e<f;e++)r.heights.push(i.height),r.pickingColors.push(...l);n.push({id:s,properties:i,vertexCount:f})}),postResult(n,a,r)}function loadOBJ(e){Request.getText(e.url,(e,t)=>{if(e)return void postMessage("error");let r=t.match(/^mtllib\\s+(.*)$/m);r?Request.getText(this.url.replace(/[^\\/]+$/,"")+r[1],(e,r)=>{e?postMessage("error"):(postMessage("load"),processOBJ(t,r))}):(postMessage("load"),processOBJ(t,null))})}function processOBJ(e,t,r){const n={vertices:[],normals:[],colors:[],texCoords:[],heights:[],pickingColors:[]},o=[],a=Qolor.parse(r.color).toArray(),s=r.position;OBJ.parse(e,t).forEach((e,t)=>{n.vertices.push(...e.vertices),n.normals.push(...e.normals),n.texCoords.push(...e.texCoords);const s=r.id||e.id,l=(s/2%2?-1:1)*(s%2?.03:.06),f=a||e.color||DEFAULT_COLOR,c=e.vertices.length/3,u=getPickingColor(i);for(let t=0;t<c;t++)n.colors.push(f[0]+l,f[1]+l,f[2]+l),n.heights.push(e.height),n.pickingColors.push(...u);o.push({id:s,properties:{},vertexCount:c})}),postResult(o,s,n)}onmessage=function(e){const t=e.data;"GeoJSON"===t.type&&loadGeoJSON(t),"OBJ"===t.type&&loadOBJ(t)};';class p{constructor(e,t){let i;const r={antialias:!t,depth:!0,premultipliedAlpha:!1};try{i=e.getContext("webgl",r)}catch(e){}if(!i)try{i=e.getContext("experimental-webgl",r)}catch(e){}if(!i)throw new Error("GL not supported");e.addEventListener("webglcontextlost",e=>{console.warn("context lost")}),e.addEventListener("webglcontextrestored",e=>{console.warn("context restored")}),i.viewport(0,0,e.width,e.height),i.cullFace(i.BACK),i.enable(i.CULL_FACE),i.enable(i.DEPTH_TEST),i.clearColor(.5,.5,.5,1),t||(i.anisotropyExtension=i.getExtension("EXT_texture_filter_anisotropic"),i.anisotropyExtension&&(i.anisotropyExtension.maxAnisotropyLevel=i.getParameter(i.anisotropyExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),i.depthTextureExtension=i.getExtension("WEBGL_depth_texture")),this.GL=i}destroy(){this.GL.getExtension("WEBGL_lose_context").loseContext(),this.GL=null}}function x(e){return e*Math.PI/180}function v(e,t,i){const r=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],u=t[6],h=t[7],f=t[8],c=t[9],d=t[10],m=t[11],g=t[12],p=t[13],x=t[14],v=t[15],w=i[0],b=i[1],T=i[2],A=i[3],y=i[4],M=i[5],E=i[6],P=i[7],D=i[8],B=i[9],S=i[10],C=i[11],F=i[12],I=i[13],R=i[14],_=i[15];e[0]=r*w+o*y+n*D+a*F,e[1]=r*b+o*M+n*B+a*I,e[2]=r*T+o*E+n*S+a*R,e[3]=r*A+o*P+n*C+a*_,e[4]=s*w+l*y+u*D+h*F,e[5]=s*b+l*M+u*B+h*I,e[6]=s*T+l*E+u*S+h*R,e[7]=s*A+l*P+u*C+h*_,e[8]=f*w+c*y+d*D+m*F,e[9]=f*b+c*M+d*B+m*I,e[10]=f*T+c*E+d*S+m*R,e[11]=f*A+c*P+d*C+m*_,e[12]=g*w+p*y+x*D+v*F,e[13]=g*b+p*M+x*B+v*I,e[14]=g*T+p*E+x*S+v*R,e[15]=g*A+p*P+x*C+v*_}p.Buffer=class{constructor(e,t){this.id=M.createBuffer(),this.itemSize=e,this.numItems=t.length/e,M.bindBuffer(M.ARRAY_BUFFER,this.id),M.bufferData(M.ARRAY_BUFFER,t,M.STATIC_DRAW),t=null}enable(){M.bindBuffer(M.ARRAY_BUFFER,this.id)}use(){M.bindBuffer(M.ARRAY_BUFFER,this.id)}destroy(){M.deleteBuffer(this.id),this.id=null}},p.Framebuffer=class{constructor(e,t,i){if(i&&!M.depthTextureExtension)throw new Error("GL: Depth textures are not supported");this.useDepthTexture=!!i,this.setSize(e,t)}setSize(e,t){if(this.frameBuffer){if(e===this.width&&t===this.height)return}else this.frameBuffer=M.createFramebuffer();if(M.bindFramebuffer(M.FRAMEBUFFER,this.frameBuffer),this.width=e,this.height=t,this.depthRenderBuffer&&(M.deleteRenderbuffer(this.depthRenderBuffer),this.depthRenderBuffer=null),this.depthTexture&&(this.depthTexture.destroy(),this.depthTexture=null),this.useDepthTexture?(this.depthTexture=new p.texture.Image,this.depthTexture.enable(0),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MIN_FILTER,M.NEAREST),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MAG_FILTER,M.NEAREST),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_WRAP_S,M.CLAMP_TO_EDGE),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_WRAP_T,M.CLAMP_TO_EDGE),M.texImage2D(M.TEXTURE_2D,0,M.DEPTH_STENCIL,e,t,0,M.DEPTH_STENCIL,M.depthTextureExtension.UNSIGNED_INT_24_8_WEBGL,null),M.framebufferTexture2D(M.FRAMEBUFFER,M.DEPTH_STENCIL_ATTACHMENT,M.TEXTURE_2D,this.depthTexture.id,0)):(this.depthRenderBuffer=M.createRenderbuffer(),M.bindRenderbuffer(M.RENDERBUFFER,this.depthRenderBuffer),M.renderbufferStorage(M.RENDERBUFFER,M.DEPTH_COMPONENT16,e,t),M.framebufferRenderbuffer(M.FRAMEBUFFER,M.DEPTH_ATTACHMENT,M.RENDERBUFFER,this.depthRenderBuffer)),this.renderTexture&&this.renderTexture.destroy(),this.renderTexture=new p.texture.Data(M,e,t),M.bindTexture(M.TEXTURE_2D,this.renderTexture.id),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_WRAP_S,M.CLAMP_TO_EDGE),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_WRAP_T,M.CLAMP_TO_EDGE),M.framebufferTexture2D(M.FRAMEBUFFER,M.COLOR_ATTACHMENT0,M.TEXTURE_2D,this.renderTexture.id,0),M.checkFramebufferStatus(M.FRAMEBUFFER)!==M.FRAMEBUFFER_COMPLETE)throw new Error("Combination of framebuffer attachments doesn't work");M.bindRenderbuffer(M.RENDERBUFFER,null),M.bindFramebuffer(M.FRAMEBUFFER,null)}enable(){M.bindFramebuffer(M.FRAMEBUFFER,this.frameBuffer),this.useDepthTexture||M.bindRenderbuffer(M.RENDERBUFFER,this.depthRenderBuffer)}disable(){M.bindFramebuffer(M.FRAMEBUFFER,null),this.useDepthTexture||M.bindRenderbuffer(M.RENDERBUFFER,null)}getPixel(e,t){if(e<0||t<0||e>=this.width||t>=this.height)return;const i=new Uint8Array(4);return M.readPixels(e,t,1,1,M.RGBA,M.UNSIGNED_BYTE,i),i}getData(){const e=new Uint8Array(this.width*this.height*4);return M.readPixels(0,0,this.width,this.height,M.RGBA,M.UNSIGNED_BYTE,e),e}destroy(){this.renderTexture&&this.renderTexture.destroy(),this.depthTexture&&this.depthTexture.destroy()}},p.Shader=class{constructor(e){if(this.name=e.source.name||"",this.id=M.createProgram(),this.compile(M.VERTEX_SHADER,e.source.vs),this.compile(M.FRAGMENT_SHADER,e.source.fs),M.linkProgram(this.id),!M.getProgramParameter(this.id,M.LINK_STATUS))throw new Error(M.getProgramParameter(this.id,M.VALIDATE_STATUS)+"\n"+M.getError());M.useProgram(this.id),this.attributes={},(e.attributes||[]).forEach(e=>{this.locateAttribute(e)}),this.uniforms={},(e.uniforms||[]).forEach(e=>{this.locateUniform(e)})}locateAttribute(e){const t=M.getAttribLocation(this.id,e);if(t<0)throw new Error(`unable to locate attribute "${e}" in shader "${this.name}"`);this.attributes[e]=t}locateUniform(e){const t=M.getUniformLocation(this.id,e);if(!t)throw new Error(`unable to locate uniform "${e}" in shader "${this.name}"`);this.uniforms[e]=t}compile(e,t){const i=M.createShader(e);if(M.shaderSource(i,t),M.compileShader(i),!M.getShaderParameter(i,M.COMPILE_STATUS))throw new Error(M.getShaderInfoLog(i));M.attachShader(this.id,i)}enable(){M.useProgram(this.id);for(let e in this.attributes)M.enableVertexAttribArray(this.attributes[e]);return this}disable(){if(this.attributes)for(let e in this.attributes)M.disableVertexAttribArray(this.attributes[e])}setBuffer(e,t){if(void 0===this.attributes[e])throw new Error(`attempt to bind buffer to invalid attribute "${e}" in shader "${this.name}"`);t.enable(),M.vertexAttribPointer(this.attributes[e],t.itemSize,M.FLOAT,!1,0,0)}setParam(e,t,i){if(void 0===this.uniforms[e])throw new Error(`attempt to bind to invalid uniform "${e}" in shader "${this.name}"`);M["uniform"+t](this.uniforms[e],i)}setMatrix(e,t,i){if(void 0===this.uniforms[e])throw new Error(`attempt to bind to invalid uniform "${e}" in shader "${this.name}"`);M["uniformMatrix"+t](this.uniforms[e],!1,i)}setTexture(e,t,i){i.enable(t),this.setParam(e,"1i",t)}destroy(){this.disable(),this.id=null}},p.Matrix=class{constructor(e){this.data=new Float32Array(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}multiply(e){return v(this.data,this.data,e.data),this}translate(e,t,i){return v(this.data,this.data,[1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1]),this}rotateX(e){const t=x(e),i=Math.cos(t),r=Math.sin(t);return v(this.data,this.data,[1,0,0,0,0,i,r,0,0,-r,i,0,0,0,0,1]),this}rotateY(e){const t=x(e),i=Math.cos(t),r=Math.sin(t);return v(this.data,this.data,[i,0,-r,0,0,1,0,0,r,0,i,0,0,0,0,1]),this}rotateZ(e){const t=x(e),i=Math.cos(t),r=Math.sin(t);return v(this.data,this.data,[i,-r,0,0,r,i,0,0,0,0,1,0,0,0,0,1]),this}scale(e,t,i){return v(this.data,this.data,[e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1]),this}},p.Matrix.multiply=((e,t)=>{const i=new Float32Array(16);return v(i,e.data,t.data),i}),p.Matrix.Perspective=class extends p.Matrix{constructor(e,t,i,r){const o=1/Math.tan(e*(Math.PI/180)/2),n=1/(i-r);super([o/t,0,0,0,0,o,0,0,0,0,(r+i)*n,-1,0,0,2*r*i*n,0])}},p.Matrix.Frustum=class extends p.Matrix{constructor(e,t,i,r,o,n){const a=1/(t-e),s=1/(i-r),l=1/(o-n);super([2*o*a,0,0,0,0,2*o*s,0,0,(t+e)*a,(i+r)*s,(n+o)*l,-1,0,0,n*o*2*l,0])}},p.Matrix.Ortho=class extends p.Matrix{constructor(e,t,i,r,o,n){super([2/(t-e),0,0,0,0,2/(i-r),0,0,0,0,-2/(n-o),0,-(t+e)/(t-e),-(i+r)/(i-r),-(n+o)/(n-o),1])}},p.Matrix.invert3=(e=>{const t=e[0],i=e[1],r=e[2],o=e[4],n=e[5],a=e[6],s=e[8],l=e[9],u=e[10],h=u*n-a*l,f=-u*o+a*s,c=l*o-n*s;let d=t*h+i*f+r*c;return d?[h*(d=1/d),(-u*i+r*l)*d,(a*i-r*n)*d,f*d,(u*t-r*s)*d,(-a*t+r*o)*d,c*d,(-l*t+i*s)*d,(n*t-i*o)*d]:null}),p.Matrix.transpose3=(e=>new Float32Array([e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8]])),p.Matrix.transpose=(e=>new Float32Array([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]])),p.Matrix.transform=(e=>{const t=e[12],i=e[13],r=e[14],o=e[15];return{x:(t/o+1)/2,y:(i/o+1)/2,z:(r/o+1)/2}}),p.Matrix.invert=(e=>{const t=new Float32Array(16),i=e[0],r=e[1],o=e[2],n=e[3],a=e[4],s=e[5],l=e[6],u=e[7],h=e[8],f=e[9],c=e[10],d=e[11],m=e[12],g=e[13],p=e[14],x=e[15],v=i*s-r*a,w=i*l-o*a,b=i*u-n*a,T=r*l-o*s,A=r*u-n*s,y=o*u-n*l,M=h*g-f*m,E=h*p-c*m,P=h*x-d*m,D=f*p-c*g,B=f*x-d*g,S=c*x-d*p;let C=v*S-w*B+b*D+T*P-A*E+y*M;if(C)return C=1/C,t[0]=(s*S-l*B+u*D)*C,t[1]=(o*B-r*S-n*D)*C,t[2]=(g*y-p*A+x*T)*C,t[3]=(c*A-f*y-d*T)*C,t[4]=(l*P-a*S-u*E)*C,t[5]=(i*S-o*P+n*E)*C,t[6]=(p*b-m*y-x*w)*C,t[7]=(h*y-c*b+d*w)*C,t[8]=(a*B-s*P+u*M)*C,t[9]=(r*P-i*B-n*M)*C,t[10]=(m*A-g*b+x*v)*C,t[11]=(f*b-h*A-d*v)*C,t[12]=(s*E-a*D-l*M)*C,t[13]=(i*D-r*E+o*M)*C,t[14]=(g*w-m*T-p*v)*C,t[15]=(h*T-f*w+c*v)*C,t}),p.Matrix.identity=(()=>new p.Matrix([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])),p.texture={},p.texture.Image=class{constructor(){this.id=M.createTexture(),M.bindTexture(M.TEXTURE_2D,this.id),M.bindTexture(M.TEXTURE_2D,null)}clamp(e,t){if(e.width<=t&&e.height<=t)return e;let i=t,r=t;const o=e.width/e.height;o<1?i=Math.round(r*o):r=Math.round(i/o);const n=G.createElement("CANVAS");return n.width=i,n.height=r,n.getContext("2d").drawImage(e,0,0,n.width,n.height),n}load(e,t){const i=new Image;return i.crossOrigin="*",i.onload=(e=>{this.set(i),t&&t(i)}),i.onerror=(e=>{t&&t()}),i.src=e,this}color(e){return M.bindTexture(M.TEXTURE_2D,this.id),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MIN_FILTER,M.LINEAR),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MAG_FILTER,M.LINEAR),M.texImage2D(M.TEXTURE_2D,0,M.RGBA,1,1,0,M.RGBA,M.UNSIGNED_BYTE,new Uint8Array([255*e[0],255*e[1],255*e[2],255*(void 0===e[3]?1:e[3])])),M.bindTexture(M.TEXTURE_2D,null),this}set(e){if(this.id)return e=this.clamp(e,M.getParameter(M.MAX_TEXTURE_SIZE)),M.bindTexture(M.TEXTURE_2D,this.id),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MIN_FILTER,M.LINEAR_MIPMAP_NEAREST),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MAG_FILTER,M.LINEAR),M.texImage2D(M.TEXTURE_2D,0,M.RGBA,M.RGBA,M.UNSIGNED_BYTE,e),M.generateMipmap(M.TEXTURE_2D),M.anisotropyExtension&&M.texParameterf(M.TEXTURE_2D,M.anisotropyExtension.TEXTURE_MAX_ANISOTROPY_EXT,M.anisotropyExtension.maxAnisotropyLevel),M.bindTexture(M.TEXTURE_2D,null),this}enable(e){if(this.id)return M.activeTexture(M.TEXTURE0+(e||0)),M.bindTexture(M.TEXTURE_2D,this.id),this}destroy(){M.bindTexture(M.TEXTURE_2D,null),M.deleteTexture(this.id),this.id=null}},p.texture.Data=class{constructor(e,t,i,r){this.id=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.id),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST);let o=null;if(r){const e=t*i*4;(o=new Uint8Array(e)).set(r.subarray(0,e))}e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,e.UNSIGNED_BYTE,o),e.bindTexture(e.TEXTURE_2D,null),this.GL=e}enable(e){return this.GL.activeTexture(this.GL.TEXTURE0+(e||0)),this.GL.bindTexture(this.GL.TEXTURE_2D,this.id),this}destroy(){this.GL.bindTexture(this.GL.TEXTURE_2D,null),this.GL.deleteTexture(this.id),this.id=null}};class w{constructor(){this.items=[]}add(e){this.items.push(e)}remove(e){this.items=this.items.filter(t=>t!==e)}forEach(e){this.items.forEach(e)}destroy(){this.forEach(e=>e.destroy()),this.items=[]}}class b{constructor(e={}){this.position={altitude:0,...e.position},this.source=e.source,this.anchor=e.anchor||"bottom",this.scale=e.scale||1,this.load()}load(){if(!this.source)return console.log("no marker icon, loading default"),void this.loadDefaultIcon();this.texture=(new p.texture.Image).load(this.source,e=>{if(!e)return console.log(`can't read marker icon ${this.source}`),void this.loadDefaultIcon();this.setTexture(e),this.setBuffers(),y.markers.add(this)})}loadDefaultIcon(){this.texture=(new p.texture.Image).load(V,e=>{e&&(this.setTexture(e),this.setBuffers(),y.markers.add(this))})}setTexture(e){M.pixelStorei(M.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),M.bindTexture(M.TEXTURE_2D,this.texture.id),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_WRAP_S,M.CLAMP_TO_EDGE),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_WRAP_T,M.CLAMP_TO_EDGE),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MIN_FILTER,M.LINEAR),this.size=e.width/20*this.scale}setBuffers(){const e=this.size/2,t={center:[e,e,e,e],top:[0,e,this.size,e],bottom:[this.size,e,0,e],left:[e,0,e,this.size],right:[e,this.size,e,0],top_left:[0,0,this.size,this.size],top_right:[0,this.size,this.size,0],bottom_left:[this.size,-this.size,0,0],bottom_right:[this.size,this.size,0,0]},i=t[this.anchor]||t.center,r=[-i[1],-i[0],0,i[3],-i[0],0,-i[1],i[2],0,i[3],i[2],0,-i[1],i[2],0,i[3],-i[0],0];this.texCoordBuffer=new p.Buffer(2,new Float32Array([0,0,1,0,0,1,1,1,0,1,1,0])),this.vertexBuffer=new p.Buffer(3,new Float32Array(r))}destroy(){y.markers.remove(this),this.texCoordBuffer&&this.texCoordBuffer.destroy(),this.texCoordBuffer&&this.vertexBuffer.destroy(),this.texture&&this.texture.destroy()}}class T{constructor(e,t){this.items=[];for(let i=0;i<t;i++)this.items[i]=new A(e)}get(e){for(let t=0;t<this.items.length;t++)if(!this.items[t].busy)return this.items[t].busy=!0,void e(this.items[t]);setTimeout(()=>{this.get(e)},50)}destroy(){this.items.forEach(e=>e.destroy()),this.items=[]}}class A{constructor(e){this.busy=!1,this.thread=new Worker(e)}postMessage(e){this.thread.postMessage(e)}onMessage(e){this.thread.onmessage=function(t){e(t.data)}}free(){this.thread.onmessage=function(e){},this.busy=!1}destroy(){this.thread.close()}}let y,M;class E{constructor(t={}){y=this,t.style&&(t.style.color||t.style.wallColor)&&(N=e.parse(t.style.color||t.style.wallColor).toArray()),Ae.backgroundColor=e.parse(t.backgroundColor||k).toArray(),Ae.fogColor=e.parse(t.fogColor||U).toArray(),this.attribution=t.attribution||E.ATTRIBUTION,this.minZoom=Math.max(parseFloat(t.minZoom||F),F),this.maxZoom=Math.min(parseFloat(t.maxZoom||I),I),this.maxZoom<this.minZoom&&(this.minZoom=F,this.maxZoom=I),this.bounds=t.bounds,this.position=t.position||{latitude:52.52,longitude:13.41},this.zoom=t.zoom||this.minZoom+(this.maxZoom-this.minZoom)/2,this.rotation=t.rotation||0,this.tilt=t.tilt||0,t.disabled&&this.setDisabled(!0);const i=Math.min(window.navigator.hardwareConcurrency,4),r=new Blob([g],{type:"application/javascript"});this.workers=new T(URL.createObjectURL(r),4*i);let o=t.container;"string"==typeof o&&(o=G.getElementById(t.container)),this.container=G.createElement("DIV"),this.container.className="osmb",0===o.offsetHeight&&(o.style.height="100%",console.warn("Container height should be set. Now defaults to 100%.")),o.appendChild(this.container),this.canvas=G.createElement("CANVAS"),this.canvas.className="osmb-viewport";this.canvas.width=this.width=1*o.offsetWidth,this.canvas.height=this.height=1*o.offsetHeight,this.container.appendChild(this.canvas),this.glx=new p(this.canvas,t.fastMode),M=this.glx.GL,this.features=new J,this.markers=new w,this.events=new C(this.canvas),this._getStateFromUrl(),t.state&&(this._setStateToUrl(),this.events.on("change",e=>{this._setStateToUrl()})),this._attribution=G.createElement("DIV"),this._attribution.className="osmb-attribution",this.container.appendChild(this._attribution),this._updateAttribution(),this.setDate(new Date),Ae.start(),this.emit("load",this)}appendTo(){}on(e,t){this.events.on(e,t)}off(e,t){this.events.off(e,t)}emit(e,t){this.events.emit(e,t)}setDate(e){Me.setDate("string"==typeof e?new Date(e):e)}project(e,t,i){const r=O*Math.cos(this.position.latitude/180*Math.PI),o=[(t-this.position.longitude)*r,-(e-this.position.latitude)*O,i];let n=oe(Ae.viewProjMatrix.data,o);return{x:(n=be(we(n,[1,1,1]),.5))[0]*this.width,y:(1-n[1])*this.height,z:n[2]}}unproject(e,t){const i=p.Matrix.invert(Ae.viewProjMatrix.data);let r=[e/this.width,1-t/this.height];const o=ne((r=P(D(r,2),[-1,-1,-1]))[0],r[1],i);if(void 0===o)return;const n=O*Math.cos(this.position.latitude/180*Math.PI);return{latitude:this.position.latitude-o[1]/O,longitude:this.position.longitude+o[0]/n}}remove(e){e.destroy&&e.destroy()}addOBJ(e,t,i={}){return i.position=t,new K("OBJ",e,i)}addGeoJSON(e,t){return new K("GeoJSON",e,t)}addGeoJSONTiles(e,t={}){return t.fixedZoom=t.fixedZoom||15,this.dataGrid=new Y(e,W,t,2),this.dataGrid}addMapTiles(e){return this.basemapGrid=new Y(e,q,{},4),this.basemapGrid}highlight(e){this.features.setTintCallback(e)}hide(e){this.features.setZScaleCallback(e)}show(){}getTarget(){}screenshot(){}_updateAttribution(){const e=[];this.attribution&&e.push(this.attribution),this._attribution.innerHTML=e.join(" · ")}_getStateFromUrl(){const e=location.search,t={};e&&e.substring(1).replace(/(?:^|&)([^&=]*)=?([^&]*)/g,(e,i,r)=>{i&&(t[i]=r)}),this.setPosition(void 0!==t.lat&&void 0!==t.lon?{latitude:t.lat,longitude:t.lon}:this.position),this.setZoom(void 0!==t.zoom?t.zoom:this.zoom),this.setRotation(void 0!==t.rotation?t.rotation:this.rotation),this.setTilt(void 0!==t.tilt?t.tilt:this.tilt)}_setStateToUrl(){history.replaceState&&!this.stateDebounce&&(this.stateDebounce=setTimeout(()=>{this.stateDebounce=null;const e=[];e.push("lat="+this.position.latitude.toFixed(6)),e.push("lon="+this.position.longitude.toFixed(6)),e.push("zoom="+this.zoom.toFixed(1)),e.push("tilt="+this.tilt.toFixed(1)),e.push("rotation="+this.rotation.toFixed(1)),history.replaceState({},"","?"+e.join("&"))},1e3))}setDisabled(e){this.events.isDisabled=!!e}isDisabled(){return!!this.events.isDisabled}getBounds(){return Ae.getViewQuad().map(e=>ue(e))}setZoom(e,t){e=parseFloat(e),e=Math.max(e,this.minZoom),e=Math.min(e,this.maxZoom),this.zoom!==e&&(this.zoom=e,this.events.emit("zoom",{zoom:e}),this.events.emit("change"))}getZoom(){return this.zoom}setPosition(e){const t=parseFloat(e.latitude),i=parseFloat(e.longitude);isNaN(t)||isNaN(i)||(this.position={latitude:Q(t,-90,90),longitude:Q(i,-180,180)},this.events.emit("change"))}getPosition(){return this.position}setSize(e,t){e===this.width&&t===this.height||(this.width=e,this.height=t,this.events.emit("resize",{width:this.width,height:this.height}))}getSize(){return{width:this.width,height:this.height}}setRotation(e){e=parseFloat(e)%360,this.rotation!==e&&(this.rotation=e,this.events.emit("rotate",{rotation:e}),this.events.emit("change"))}getRotation(){return this.rotation}setTilt(e){e=Q(parseFloat(e),0,R),this.tilt!==e&&(this.tilt=e,this.events.emit("tilt",{tilt:e}),this.events.emit("change"))}getTilt(){return this.tilt}addMarker(e){return new b(e)}destroy(){Ae.destroy(),this.events.destroy(),this.glx.destroy(),this.canvas.parentNode.removeChild(this.canvas),this.features.destroy(),this.markers.destroy(),this.container.innerHTML=""}}function P(e,t){return[e[0]+t[0],e[1]+t[1]]}function D(e,t){return[e[0]*t,e[1]*t]}function B(e){const t=e.target.getBoundingClientRect();return{x:e.x-t.left,y:e.y-t.top}}function S(e,t,i){e.addEventListener(t,i,!1)}E.VERSION=null,E.ATTRIBUTION='<a href="https://osmbuildings.org/">© OSM Buildings</a>',"function"==typeof define?define([],E):"object"==typeof module?module.exports=E:window.OSMBuildings=E;class C{constructor(e){this.window=top||window,this.listeners={},this.isDisabled=!1,this.prevX=0,this.prevY=0,this.startZoom=0,this.prevRotation=0,this.prevTilt=0,this.startDist=0,this.startAngle=0,this.buttons=0,this.addAllListeners(this.window,e)}addAllListeners(e,t){const i=e.document;let r;"ontouchstart"in e?(S(t,"touchstart",e=>{this.onTouchStart(e)}),S(i,"touchmove",e=>{this.onTouchMoveDocument(e)}),S(t,"touchmove",e=>{this.onTouchMove(e)}),S(i,"touchend",e=>{this.onTouchEndDocument(e)}),S(i,"gesturechange",e=>{this.onGestureChangeDocument(e)})):(S(t,"mousedown",e=>{this.onMouseDown(e)}),S(i,"mousemove",e=>{this.onMouseMoveDocument(e)}),S(t,"mousemove",e=>{this.onMouseMove(e)}),S(i,"mouseup",e=>{this.onMouseUpDocument(e)}),S(t,"mouseup",e=>{this.onMouseUp(e)}),S(t,"dblclick",e=>{this.onDoubleClick(e)}),S(t,"mousewheel",e=>{this.onMouseWheel(e)}),S(t,"DOMMouseScroll",e=>{this.onMouseWheel(e)}),S(t,"contextmenu",e=>{this.onContextMenu(e)})),S(window,"resize",e=>{r||(r=setTimeout(()=>{r=null,y.setSize(y.container.offsetWidth,y.container.offsetHeight)},250))})}cancelEvent(e){e.preventDefault&&e.preventDefault(),e.returnValue=!1}onDoubleClick(e){Ae.speedUp(),this.cancelEvent(e),this.emit("doubleclick",{...B(e),buttons:e.buttons}),this.isDisabled||y.setZoom(y.zoom+1,e)}onMouseDown(e){Ae.speedUp(),this.cancelEvent(e),this.startZoom=y.zoom,this.prevRotation=y.rotation,this.prevTilt=y.tilt,this.prevX=e.clientX,this.prevY=e.clientY,this.isMove=!1,1===e.buttons&&e.altKey||2===e.buttons?this.buttons=2:1===e.buttons&&(this.buttons=1),this.emit("pointerdown",{...B(e),buttons:e.buttons})}onMouseMoveDocument(e){1===this.buttons?(Ae.speedUp(),this.moveMap(e),this.isMove=!0):2===this.buttons&&(Ae.speedUp(),this.rotateMap(e),this.isMove=!0),this.prevX=e.clientX,this.prevY=e.clientY}onMouseMove(e){this.emit("pointermove",B(e))}onMouseUpDocument(e){this.buttons&&(1===this.buttons?this.moveMap(e):2===this.buttons&&this.rotateMap(e),this.buttons=0)}onMouseUp(e){if(this.isMove)this.emit("pointerup",{buttons:e.buttons});else{const t=B(e);Ae.Picking.getTarget(t.x,t.y,t=>{this.emit("pointerup",{buttons:e.buttons,target:t})})}}onMouseWheel(e){Ae.speedUp(),this.cancelEvent(e);let t=0;if(e.wheelDeltaY?t=e.wheelDeltaY:e.wheelDelta?t=e.wheelDelta:e.detail&&(t=-e.detail),!this.isDisabled){const i=.2*(t>0?1:t<0?-1:0);y.setZoom(y.zoom+i,e)}}onContextMenu(e){this.cancelEvent(e)}moveMap(e){if(this.isDisabled)return;const t=.86*Math.pow(2,-y.zoom),i=1/Math.cos(y.position.latitude/180*Math.PI),r=e.clientX-this.prevX,o=e.clientY-this.prevY,n=y.rotation*Math.PI/180,a=[Math.cos(n),Math.sin(n)],s=[Math.cos(n-Math.PI/2),Math.sin(n-Math.PI/2)],l=P(D(a,r),D(s,-o)),u={longitude:y.position.longitude-l[0]*t*i,latitude:y.position.latitude+l[1]*t};y.setPosition(u),this.emit("move",u)}rotateMap(e){this.isDisabled||(this.prevRotation+=(e.clientX-this.prevX)*(360/this.window.innerWidth),this.prevTilt-=(e.clientY-this.prevY)*(360/this.window.innerHeight),y.setRotation(this.prevRotation),y.setTilt(this.prevTilt))}emitGestureChange(e){const t=e.touches[0],i=e.touches[1],r=t.clientX-i.clientX,o=t.clientY-i.clientY,n=r*r+o*o,a=Math.atan2(o,r);this.onGestureChangeDocument({rotation:(a-this.startAngle)*(180/Math.PI)%360,scale:Math.sqrt(n/this.startDist)})}onTouchStart(e){Ae.speedUp(),this.cancelEvent(e),this.buttons=1,this.isMove=!1;const t=e.touches[0];if(2===e.touches.length&&!("ongesturechange"in this.window)){const i=e.touches[1],r=t.clientX-i.clientX,o=t.clientY-i.clientY;this.startDist=r*r+o*o,this.startAngle=Math.atan2(o,r)}this.startZoom=y.zoom,this.prevRotation=y.rotation,this.prevTilt=y.tilt,this.prevX=t.clientX,this.prevY=t.clientY,this.emit("pointerdown",{x:e.x,y:e.y,buttons:1})}onTouchMoveDocument(e){if(!this.buttons)return;Ae.speedUp();const t=e.touches[0];e.touches.length>1?(y.setTilt(this.prevTilt+(this.prevY-t.clientY)*(360/this.window.innerHeight)),this.prevTilt=y.tilt,"ongesturechange"in this.window||this.emitGestureChange(e),this.isMove=!0):(this.moveMap(t),this.isMove=!0),this.prevX=t.clientX,this.prevY=t.clientY}onTouchMove(e){1===e.touches.length&&this.emit("pointermove",{...B(e.touches[0]),buttons:1})}onTouchEndDocument(e){if(!this.buttons)return;const t=e.touches[0];if(0===e.touches.length)if(this.buttons=0,this.isMove)this.emit("pointerup",{buttons:1});else{const t=B(e);Ae.Picking.getTarget(t.x,t.y,e=>{this.emit("pointerup",{buttons:1,target:e})})}else 1===e.touches.length&&(this.prevX=t.clientX,this.prevY=t.clientY)}onGestureChangeDocument(e){this.buttons&&(Ae.speedUp(),this.cancelEvent(e),this.isDisabled||(y.setZoom(this.startZoom+(e.scale-1)),y.setRotation(this.prevRotation-e.rotation)),this.emit("gesture",e))}on(e,t){(this.listeners[e]||(this.listeners[e]=[])).push(t)}off(e,t){this.listeners[e]=(this.listeners[e]||[]).filter(e=>e!==t)}emit(e,t){void 0!==this.listeners[e]&&setTimeout(()=>{this.listeners[e].forEach(e=>e(t))},0)}destroy(){this.listeners={}}}const F=15,I=22,R=45,_=256,L=25,N=e.parse("rgb(220, 210, 200)").toArray(),U="#e8e0d8",k="#efe8e0",G=window.document,H=6378137*Math.PI*2,O=H/360,Z=2048,z="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABAAQMAAACQp+OdAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3wwCCAUQLpaUSQAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAAAGUExURebm5v///zFES9kAAAAcSURBVCjPY/gPBQyUMh4wAAH/KAPCoFaoDnYGAAKtZsamTRFlAAAAAElFTkSuQmCC",V="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAACXBIWXMAAA3XAAAN1wFCKJt4AAAAB3RJTUUH4gUHDxACbf+ToAAABKBJREFUeNrt3YFtKjEURFGWBmiE/iuhka0AOgCxWpDte04DP/nxG88zkbJdWMLjdnv+89+77/vmf31+foiGXDgIAAy8QBAAGHiBIAAw9MJAAGDohYEAwNALAwGAwRcEAgCDLwgEAAZfEAgADL4gEAAGH0EgAAw+gkAAGHwEgQAw/AgBAWDwEQQCwPAjBASA4UcICACDjyAQAIYfISAADD9CQAAYfoSAADD4CAIBYPgRAgLA8CMEBIDhRwgIAMOPEBAAhh8hcIqrHzd0ZZLO7Y8WEA0Aw48QiAaA4UcIRAPA8CMEogFg+BECn/kUAMKWTDW3P1pANAAMP0LACgDUGoDbHy0gGgCGHyFgBQBqDcDtjxagAQC1BuD2RwvQAIBaA3D7owVoAECtAbj90QI0AKDWANz+aAEaAFBrAG5/tAANABAAQGYFUP+xBmgAgAAAMiuA+o81QAMABACQWQHUf6wBGgAgAAABAKz/BmD/xzuABgAIAEAAAOu/Adj/8Q6gAQACABAAgAAABAAgAIAjhv14wkeArGTUjwI1ALACAAIAEACAAAAEACAAAAEACABAAAACABAAgAAABAAgAAABAAgAQAAAAgAQAIAAAAQAIAAAAQD8zjbyF+ePg7CCUf8oiAYAVgBAAAACAOjYRv8CPQQys5EfADUAsAIAAgDwBuAdABr7vwYAVgDACmANgFT91wDACgAIAJUKBADQuawEAIRNV6t9GoDbXwMABACQWgGsAaj/GgBQDQC/EwAaALiUBABw1NRV2mMgbn8NACgGgMdA0ADAJSQAgG8tUaE9BuL21wCAYgPQAnD7awBAtQFoAbj9NQCgGgB+MQg0AHDJVANACwANAFwuAgB4Z9m67CNB3P4aAFBsAFoAbn8NAKg2AC0At78GAFQbgBaA218DAKoNQAvA7R8PACGA4bcCANUGoAXg9tcAgGoD0AJw+2sAQLUBaAG4/TUA0ADK37wWQPn21wBAA2jTAtz+5e9fA8DwCwCHAKwAVgEEvwYAaABaAG5/DQDQALQA3P4aABh+AeCQgBXAKoBg1wAADUALwO2vAYDhFwAOD1gBrAIIcA0A0AC0ANz+GgAYfgHgUIEAAEEtABwu+DMH+gAPggJaAwDDLwAcNrACWAUQyBoAGH4B4PCBAAAB7A3AWwCGXwNwGEEAgMAVAA4leAPwHoCg1QDA8AsAhxSsAFYBBKsGAIZfADi0IAAQpHgD8BZg+NEAHGIQAAhOrABWAcOPBuBQgwBAUGIFsAoYfjQAhxwEAIIRK4BVwPCjATj0IAAQhFYArAKGXwPAECAAQPBZAbAKGH4BgBAw/FYADAcCAAScFQCrgOHXADAsCAAQaFYArAKGXwPA8CAAQIBZAciuAoZfABANAcNvBcBQIQAQVFgBSKwChl8DwJAhABBMWAFIrAKGXwAQDQHDbwXA8CEAEEBYAUisAoZfA8BNjABA4GAFILEKGH4BQDQEDL8VAPUcAYBgwQpAYhUw/AKAaAgYfisAajsaALUmIEA0ALQHBACGGSsAiVVAYAgAoiFg+K0AWBUQABhyrAAkVgHBAMEQmPEPj3KeFy7fLVanpR7MAAAAAElFTkSuQmCC";function X(e,t){return e.map(e=>[...e,t])}function Q(e,t,i){return Math.min(i,Math.max(e,t))}class Y{constructor(e,t,i={},r=2){this.source=e,this.tileClass=t,this.tiles={},this.buffer=1,this.fixedZoom=i.fixedZoom,this.bounds=i.bounds||{w:-180,s:-90,e:180,n:90},this.minZoom=Math.max(parseFloat(i.minZoom||y.minZoom),y.minZoom),this.maxZoom=Math.min(parseFloat(i.maxZoom||y.maxZoom),y.maxZoom),this.maxZoom<this.minZoom&&(this.minZoom=y.minZoom,this.maxZoom=y.maxZoom),this.queue=[];for(let e=0;e<r;e++)this.queueNext();this.update()}getURL(e,t,i){const r="abcd"[(e+t)%4];return o=this.source,n={s:r,x:e,y:t,z:i},o.replace(/\{(\w+)\}/g,(e,t)=>n[t]||e);var o,n}getClosestTiles(e,t){return e}mergeTiles(e,t,i){const r={},o={},n=[];let a;if(0===t||t<=this.minZoom){for(a in e)e[a][2]=t;return e}for(a in e){const s=e[a],l=(s[0]<<0)/2,u=(s[1]<<0)/2;if(void 0===r[[l,u]]){const e=ae(l,u,t-1,Ae.viewProjMatrix);r[[l,u]]=e<i}r[[l,u]]||void 0===o[[s[0],s[1]]]&&(o[[s[0],s[1]]]=!0,n.push([s[0],s[1],t]))}let s=[];for(a in r)if(r[a]){const e=a.split(",");s.push([parseInt(e[0]),parseInt(e[1]),t-1])}return s.length>0&&(s=this.mergeTiles(s,t-1,i)),n.concat(s)}getDistance(e,t){const i=e[0]-t[0],r=e[1]-t[1];return i*i+r*r}update(){if(y.zoom<this.minZoom||y.zoom>this.maxZoom)return;const e=Math.round(this.fixedZoom||y.zoom);let t=Ae.getViewQuad(Ae.viewProjMatrix.data),i=fe([y.position.longitude,y.position.latitude],1<<e);for(let i=0;i<4;i++)t[i]=he(t[i],e);let r=function(e){ee(4==e.length,"Error: Quadrilateral with more or less than four vertices");const t=ie(e[0],e[1],e[2]),i=ie(e[0],e[2],e[3]);return t.concat(i)}(t);r=this.fixedZoom?this.getClosestTiles(r,i):this.mergeTiles(r,e,.5*_*_);const o={};r.forEach(t=>{void 0===t[2]&&(t[2]=e),o[t.join(",")]=!0}),this.visibleTiles=o;for(let e in o){const t=e.split(","),i=parseInt(t[0]),r=parseInt(t[1]),o=parseInt(t[2]);this.tiles[e]||(this.tiles[e]=new this.tileClass(i,r,o),this.queue.push(this.tiles[e]))}this.purge(o),this.queue.forEach(e=>{e.distance=this.getDistance([e.x,e.y],i)}),this.queue.sort((e,t)=>t.distance-e.distance),setTimeout(()=>{this.update()},100)}queueNext(){if(!this.queue.length)return void setTimeout(this.queueNext.bind(this),200);const e=this.queue.pop();e.load(this.getURL(e.x,e.y,e.zoom),()=>{this.queueNext()})}purge(e){const t=Math.round(y.zoom);for(let i in this.tiles){let r=this.tiles[i];if(!e[i])if(this.fixedZoom)this.tiles[i].destroy(),delete this.tiles[i];else{if(r.zoom===t+1){if(e[[r.x/2<<0,r.y/2<<0,t].join(",")])continue}r.zoom===t-1&&(e[[2*r.x,2*r.y,t].join(",")]||e[[2*r.x+1,2*r.y,t].join(",")]||e[[2*r.x,2*r.y+1,t].join(",")]||e[[2*r.x+1,2*r.y+1,t].join(",")])||delete this.tiles[i]}}this.queue=this.queue.filter(e=>!!e)}destroy(){for(let e in this.tiles)this.tiles[e].destroy();this.tiles={},this.queue=[]}}class j{constructor(e,t,i){this.x=e,this.y=t,this.zoom=i,this.key=[e,t,i].join(","),this.distance=1/0}load(){}destroy(){}}class q extends j{constructor(e,t,i){super(e,t,i),this.latitude=de(t,i),this.longitude=ce(e,i);const r=le(this.latitude,i),o=[r,r,0,r,0,0,0,r,0,0,0,0];this.vertexBuffer=new p.Buffer(3,new Float32Array(o)),this.texCoordBuffer=new p.Buffer(2,new Float32Array([1,0,1,1,0,0,0,1]))}load(e,t){this.texture=(new p.texture.Image).load(e,e=>{e&&(M.bindTexture(M.TEXTURE_2D,this.texture.id),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_WRAP_S,M.CLAMP_TO_EDGE),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_WRAP_T,M.CLAMP_TO_EDGE),this.isReady=!0),t&&t()})}destroy(){this.vertexBuffer.destroy(),this.texCoordBuffer.destroy(),this.texture&&this.texture.destroy()}}class W extends j{constructor(e,t,i,r){super(e,t,i),this.options=r}load(e,t){this.content=new K("GeoJSON",e,this.options,t)}destroy(){this.content&&this.content.destroy()}}class J extends w{constructor(...e){super(...e),this.tintCallback=(()=>{}),this.zScaleCallback=(()=>{})}setTintCallback(e){this.tintCallback=e,this.forEach(e=>{e.applyTintAndZScale()})}setZScaleCallback(e){this.zScaleCallback=e,this.forEach(e=>{e.applyTintAndZScale()})}}class K{constructor(e,t,i={},r=function(){}){this.type=e,this.url=t,this.options=i,this.callback=r,this.id=i.id,this.color=i.color,this.matrix=new p.Matrix,this.translate(0,0,i.elevation||0),this.scale(i.scale||1),this.rotate(i.rotation||0),this.minZoom=Math.max(parseFloat(i.minZoom||F),y.minZoom),this.maxZoom=Math.min(parseFloat(i.maxZoom||I),y.maxZoom),this.maxZoom<this.minZoom&&(this.minZoom=F,this.maxZoom=I),this.load()}load(){y.workers.get(e=>{e.onMessage(t=>{if("error"===t)return this.callback(),void e.free();"load"!==t?(this.onLoad(t),e.free()):this.callback()}),e.postMessage({type:this.type,url:this.url,options:this.options})})}onLoad(e){this.position=e.position,this.prevX=0,this.prevY=0,this.vertexBuffer=new p.Buffer(3,e.vertices),this.timer=setTimeout(()=>{this.normalBuffer=new p.Buffer(3,e.normals),this.timer=setTimeout(()=>{this.colorBuffer=new p.Buffer(3,e.colors),this.timer=setTimeout(()=>{this.texCoordBuffer=new p.Buffer(2,e.texCoords),this.timer=setTimeout(()=>{this.heightBuffer=new p.Buffer(1,e.heights),this.timer=setTimeout(()=>{this.pickingBuffer=new p.Buffer(3,e.pickingColors),this.timer=setTimeout(()=>{this.items=e.items,this.applyTintAndZScale(),y.features.add(this),this.fade=0},20)},20)},20)},20)},20)},20)}translate(e=0,t=0,i=0){this.matrix.translate(e,t,i)}scale(e){this.matrix.scale(e,e,e)}rotate(e){this.matrix.rotateZ(-e)}getMatrix(){const e=this.position.longitude-y.position.longitude,t=this.position.latitude-y.position.latitude,i=e-this.prevX,r=t-this.prevY,o=O*Math.cos(y.position.latitude/180*Math.PI);return this.matrix.translate(i*o,-r*O,0),this.prevX=e,this.prevY=t,this.matrix}getFade(){if(this.fade>=1)return 1;Ae.speedUp();const e=this.fade;return this.fade+=1/60,e}applyTintAndZScale(){const t=[],i=y.features.tintCallback,r=[],o=y.features.zScaleCallback;this.items.forEach(n=>{const a={id:n.id,properties:n.properties},s=i(a),l=s?[...e.parse(s).toArray(),1]:[0,0,0,0],u=o(a);for(let e=0;e<n.vertexCount;e++)t.push(...l),r.push(u?0:1)}),this.tintBuffer=new p.Buffer(4,new Float32Array(t)),this.zScaleBuffer=new p.Buffer(1,new Float32Array(r))}destroy(){y.features.remove(this),clearTimeout(this.timer),this.vertexBuffer&&this.vertexBuffer.destroy(),this.normalBuffer&&this.normalBuffer.destroy(),this.colorBuffer&&this.colorBuffer.destroy(),this.texCoordBuffer&&this.texCoordBuffer.destroy(),this.heightBuffer&&this.heightBuffer.destroy(),this.pickingBuffer&&this.pickingBuffer.destroy(),this.tintBuffer&&this.tintBuffer.destroy(),this.zScaleBuffer&&this.zScaleBuffer.destroy(),this.items=[]}}class ${constructor(){this.size=5e3,this.minZoom=y.minZoom,this.maxZoom=y.maxZoom,this.matrix=new p.Matrix,this.createGeometry()}createGeometry(){const e=2*this.size/50,t=[0,0,1],i=[...t,...t,...t,...t,...t,...t],r=[],o=[],n=[];for(let t=0;t<50;t++)for(let a=0;a<50;a++){const s=-this.size+t*e,l=-this.size+a*e;r.push(s,l,0,s+e,l+e,0,s+e,l,0,s,l,0,s,l+e,0,s+e,l+e,0),o.push(...i),n.push(1,1,1,1,1,1)}this.vertexBuffer=new p.Buffer(3,new Float32Array(r)),this.normalBuffer=new p.Buffer(3,new Float32Array(o)),this.zScaleBuffer=new p.Buffer(1,new Float32Array(n))}getFade(){return 1}getMatrix(){return this.matrix}destroy(){this.vertexBuffer.destroy(),this.normalBuffer.destroy()}}function ee(e,t){if(!e)throw t}function te(e,t,i){const r=[e[0]<t[0]?1:-1,e[1]<t[1]?1:-1],o=i[0]+(e[0]<t[0]?1:0),n=i[1]+(e[1]<t[1]?1:0),a=(o-e[0])/(t[0]-e[0]),s=(n-e[1])/(t[1]-e[1]);return(a<=0||a>1)&&(s<=0||s>1)?[void 0,void 0]:a<=0||a>1?[i[0],i[1]+r[1]]:s<=0||s>1?[i[0]+r[0],i[1]]:a<s?[i[0]+r[0],i[1]]:[i[0],i[1]+r[1]]}function ie(e,t,i){const r=[e,t,i];if(r.sort((e,t)=>e[1]<t[1]),e=r[0],t=r[1],i=r[2],e[1]==t[1])return re(e,t,i);if(t[1]==i[1])return re(t,i,e);const o=(t[1]-e[1])/(i[1]-e[1]),n=[e[0]+o*(i[0]-e[0]),t[1]];return re(n,t,e).concat(re(n,t,i))}function re(e,t,i){const r=[];if(ee(e[1]===t[1],"not a flat triangle"),ee(i[1]!==e[1],"not a triangle"),ee(e[0]!==t[0],"not a triangle"),e[0]>t[0]){const i=e;e=t,t=i}let o=[i[0]<<0,i[1]<<0],n=o.slice(0);r.push(o.slice(0));const a=i[1]<e[1]?1:-1,s=o[1],l=(e[1]<<0)+a;let u,h;for(let f=s;f*a<l*a;f+=a){do{r.push(o.slice(0)),u=o,o=te(i,e,o)}while(o[1]*a<=f*a);o=u;do{r.push(n.slice(0)),h=n,n=te(i,t,n)}while(n[1]*a<=f*a);n=h;for(let e=o[0];e<=n[0];e++)r.push([e,f])}return r}function oe(e,t){const i=t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+e[12],r=t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+e[13],o=t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+e[14],n=t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+e[15];return[i/n,r/n,o/n]}function ne(e,t,i){const r=oe(i,[e,t,0]),o=ve(oe(i,[e,t,1]),r);if(o[2]>=0)return;const n=we(r,be(o,-r[2]/o[2]));return[n[0],n[1]]}function ae(e,t,i,r){const o=O*Math.cos(y.position.latitude/180*Math.PI),n=ce(e,i),a=de(t,i),s=new p.Matrix;s.translate((n-y.position.longitude)*o,-(a-y.position.latitude)*O,0);const l=le(y.position.latitude,i),u=p.Matrix.multiply(s,r),h=[oe(u,[0,0,0]),oe(u,[l,0,0]),oe(u,[0,l,0]),oe(u,[l,l,0])].map(e=>(e[0]=(e[0]+1)/2*y.width,e[1]=(e[1]+1)/2*y.height,e));return se((f=h)[0],f[1],f[2])+se(f[0],f[2],f[3]);var f}function se(e,t,i){const r=me(pe(e,t)),o=me(pe(e,i)),n=me(pe(t,i)),a=.5*(r+o+n);return Math.sqrt(a*(a-r)*(a-o)*(a-n))}function le(e,t){return H*Math.cos(e/180*Math.PI)/Math.pow(2,t)}function ue(e){const t=O*Math.cos(y.position.latitude/180*Math.PI);return{longitude:y.position.longitude+e[0]/t,latitude:y.position.latitude-e[1]/O}}function he(e,t){const i=ue(e);return fe([i.longitude,i.latitude],1<<t)}function fe(e,t=1){return[(e[0]/360+.5)*t,(1-Math.log(Math.tan(e[1]*Math.PI/180)+1/Math.cos(e[1]*Math.PI/180))/Math.PI)/2*t]}function ce(e,t){return e/Math.pow(2,t)*360-180}function de(e,t){const i=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(i)-Math.exp(-i)))}function me(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])}function ge(e,t){return e[0]*t[0]+e[1]*t[1]}function pe(e,t){return[e[0]-t[0],e[1]-t[1]]}function P(e,t){return[e[0]+t[0],e[1]+t[1]]}function D(e,t){return[e[0]*t,e[1]*t]}function xe(e){const t=me(e);return[e[0]/t,e[1]/t]}function ve(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]}function we(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2]]}function be(e,t){return[e[0]*t,e[1]*t,e[2]*t]}function Te(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}class Ae{constructor(){this.metersPerDegreeLongitude=O*Math.cos(y.position.latitude/180*Math.PI)}static getViewQuad(){return function(e,t,i){const r=p.Matrix.invert(e);let o,n,a,s,l,u=ne(-1,-1,r),h=ne(1,-1,r),f=ne(1,1,r),c=ne(-1,1,r);if(u&&h)return c&&f||(l=ge(o=xe(pe(a=ne(-1,-.9,r),u)),i),c=P(u,D(o,t/l)),l=ge(n=xe(pe(s=ne(1,-.9,r),h)),i),f=P(h,D(n,t/l))),ge(i,pe(c,u))>t&&(l=ge(o=xe(pe(c,u)),i),c=P(u,D(o,t/l))),ge(i,pe(f,h))>t&&(l=ge(n=xe(pe(f,h)),i),f=P(h,D(n,t/l))),[u,h,f,c]}(this.viewProjMatrix.data,this.fogDistance+this.fogBlurDistance,this.viewDirOnMap)}static start(){Ae.effects={shadows:!0},this.metersPerDegreeLongitude=O*Math.cos(y.position.latitude/180*Math.PI),M.depthTextureExtension||(console.warn("Shadows are disabled because your GPU does not support WEBGL_depth_texture"),Ae.effects.shadows=!1),this.setupViewport(),M.cullFace(M.BACK),M.enable(M.CULL_FACE),M.enable(M.DEPTH_TEST),Ae.Picking=new ye,Ae.Horizon=new Ce,Ae.Buildings=new Ee,Ae.Marker=new Ie,Ae.Basemap=new De,Ae.Overlay.init(),Ae.ambientMap=new Se,Ae.blurredAmbientMap=new Fe,Ae.MapShadows=new Pe,Ae.effects.shadows&&(Ae.cameraGBuffer=new Be,Ae.sunGBuffer=new Be),this.speedUp(),this.renderFrame()}static renderFrame(){y.zoom>=y.minZoom&&y.zoom<=y.maxZoom&&requestAnimationFrame(()=>{this.setupViewport(),this.metersPerDegreeLongitude=O*Math.cos(y.position.latitude/180*Math.PI),M.clearColor(this.fogColor[0],this.fogColor[1],this.fogColor[2],0),M.clear(M.COLOR_BUFFER_BIT|M.DEPTH_BUFFER_BIT);const e=[y.width,y.height];if(Ae.effects.shadows){const t=this.getViewQuad();Me.updateView(t),Ae.Horizon.updateGeometry(t),Ae.cameraGBuffer.render(this.viewMatrix,this.projMatrix,e,!0),Ae.sunGBuffer.render(Me.viewMatrix,Me.projMatrix,[Z,Z]),Ae.ambientMap.render(Ae.cameraGBuffer.framebuffer.depthTexture,Ae.cameraGBuffer.framebuffer.renderTexture,e,2),Ae.blurredAmbientMap.render(Ae.ambientMap.framebuffer.renderTexture,e),Ae.Buildings.render(Ae.sunGBuffer.framebuffer),Ae.Basemap.render(),M.enable(M.BLEND),M.blendFuncSeparate(M.ZERO,M.SRC_COLOR,M.ZERO,M.ONE),Ae.MapShadows.render(Me,Ae.sunGBuffer.framebuffer,.5),Ae.Overlay.render(Ae.blurredAmbientMap.framebuffer.renderTexture,e),M.blendFuncSeparate(M.ONE_MINUS_DST_ALPHA,M.DST_ALPHA,M.ONE,M.ONE),M.disable(M.DEPTH_TEST),Ae.Horizon.render(),M.enable(M.DEPTH_TEST),M.disable(M.BLEND),Ae.Marker.render()}else Ae.Buildings.render(),Ae.MarkerRender.render(),M.enable(M.BLEND),M.blendFuncSeparate(M.ONE_MINUS_DST_ALPHA,M.DST_ALPHA,M.ONE,M.ONE),M.disable(M.DEPTH_TEST),Ae.Horizon.render(),M.disable(M.BLEND),M.enable(M.DEPTH_TEST),Ae.Basemap.render();this.isFast?this.renderFrame():setTimeout(()=>{this.renderFrame()},250)})}static setupViewport(){M.canvas.width!==y.width&&(M.canvas.width=y.width),M.canvas.height!==y.height&&(M.canvas.height=y.height);const e=1.3567*Math.pow(2,y.zoom-17),t=y.width,i=y.height;M.viewport(0,0,t,i),this.viewMatrix=(new p.Matrix).rotateZ(y.rotation).rotateX(y.tilt).translate(0,8/e,0).translate(0,0,-1220/e),this.viewDirOnMap=[Math.sin(y.rotation/180*Math.PI),-Math.cos(y.rotation/180*Math.PI)];const r=1024/(2*Math.tan(.125*Math.PI)),o=2*Math.atan(i/2/r)/Math.PI*180;this.nearPlane=1,this.farPlane=3e4,this.projMatrix=(new p.Matrix).translate(0,-i/(2*e),0).scale(1,-1,1).multiply(new p.Matrix.Perspective(o,t/i,this.nearPlane,this.farPlane)).translate(0,-1,0),this.viewProjMatrix=new p.Matrix(p.Matrix.multiply(this.viewMatrix,this.projMatrix)),this.lowerLeftOnMap=ne(-1,-1,p.Matrix.invert(this.viewProjMatrix.data)),void 0!==this.lowerLeftOnMap&&(this.fogDistance=5e3,this.fogBlurDistance=1e4)}static speedUp(){this.isFast=!0,clearTimeout(this.speedTimer),this.speedTimer=setTimeout(()=>{this.isFast=!1},1e3)}static destroy(){Ae.Picking.destroy(),Ae.Horizon.destroy(),Ae.Buildings.destroy(),Ae.Marker.destroy(),Ae.Basemap.destroy(),Ae.MapShadows.destroy(),Ae.cameraGBuffer&&Ae.cameraGBuffer.destroy(),Ae.sunGBuffer&&Ae.sunGBuffer.destroy(),Ae.ambientMap.destroy(),Ae.blurredAmbientMap.destroy(),clearTimeout(this.speedTimer)}}class ye{constructor(){this.size=[512,512],this.shader=new p.Shader({source:i,attributes:["aPosition","aPickingColor","aZScale"],uniforms:["uModelMatrix","uMatrix","uFogDistance","uFade","uIndex"]}),this.framebuffer=new p.Framebuffer(this.size[0],this.size[1])}getTarget(e,t,i){requestAnimationFrame(()=>{const r=this.shader;r.enable(),this.framebuffer.enable(),M.viewport(0,0,this.size[0],this.size[1]),M.clearColor(0,0,0,1),M.clear(M.COLOR_BUFFER_BIT|M.DEPTH_BUFFER_BIT),r.setParam("uFogDistance","1f",Ae.fogDistance);const o=[];y.features.forEach(e=>{if(y.zoom<e.minZoom||y.zoom>e.maxZoom)return;let t=e.getMatrix();t&&(o.push(e.items),r.setParam("uFade","1f",e.getFade()),r.setParam("uIndex","1f",o.length/256),r.setMatrix("uModelMatrix","4fv",t.data),r.setMatrix("uMatrix","4fv",p.Matrix.multiply(t,Ae.viewProjMatrix)),r.setBuffer("aPosition",e.vertexBuffer),r.setBuffer("aPickingColor",e.pickingBuffer),r.setBuffer("aZScale",e.zScaleBuffer),M.drawArrays(M.TRIANGLES,0,e.vertexBuffer.numItems))}),r.disable(),M.viewport(0,0,y.width,y.height);const n=e/y.width*this.size[0]<<0,a=t/y.height*this.size[1]<<0,s=this.framebuffer.getPixel(n,this.size[1]-1-a);if(this.framebuffer.disable(),!s)return void i();const l=s[0]-1,u=(s[1]|s[2]<<8)-1;if(!o[l]||!o[l][u])return void i();const h=o[l][u],f=[],c=h.properties.building||h.id;y.features.forEach(e=>{e.items.forEach(e=>{e.id!==c&&e.properties.building!==c||f.some(t=>t.id===e.id)||f.push({id:e.id,properties:e.properties})})}),i(f)})}destroy(){this.shader.destroy(),this.framebuffer.destroy()}}const Me={setDate:e=>{const i=t(e,y.position.latitude,y.position.longitude);Me.direction=[-Math.sin(i.azimuth)*Math.cos(i.altitude),Math.cos(i.azimuth)*Math.cos(i.altitude),Math.sin(i.altitude)];const r=i.azimuth/(Math.PI/180),o=90-i.altitude/(Math.PI/180);Me.viewMatrix=(new p.Matrix).rotateZ(r).rotateX(o).translate(0,0,-5e3).scale(1,-1,1)},updateView:e=>{Me.projMatrix=function(e,t,i,r,o){const n=oe(t.data,e[0]);let a=n[0],s=n[0],l=n[1],u=n[1];return e.forEach(e=>{const i=oe(t.data,e);a=Math.min(a,i[0]),s=Math.max(s,i[0]),l=Math.max(l,i[1]),u=Math.min(u,i[1])}),new p.Matrix.Ortho(a,s,l,u,i,r)}(X(e,0).concat(X(e,100)),Me.viewMatrix,1e3,7500),Me.viewProjMatrix=new p.Matrix(p.Matrix.multiply(Me.viewMatrix,Me.projMatrix))}};class Ee{constructor(){this.shader=Ae.effects.shadows?new p.Shader({source:o,attributes:["aPosition","aTexCoord","aColor","aNormal","aHeight","aTintColor","aZScale"],uniforms:["uFogDistance","uFogBlurDistance","uLightColor","uLightDirection","uLowerEdgePoint","uMatrix","uModelMatrix","uSunMatrix","uShadowTexIndex","uShadowTexDimensions","uFade","uViewDirOnMap","uWallTexIndex"]}):new p.Shader({source:r,attributes:["aPosition","aTexCoord","aColor","aNormal","aHeight","aTintColor","aZScale"],uniforms:["uModelMatrix","uViewDirOnMap","uMatrix","uNormalTransform","uLightColor","uLightDirection","uLowerEdgePoint","uFogDistance","uFogBlurDistance","uFade","uWallTexIndex"]}),this.wallTexture=new p.texture.Image,this.wallTexture.color([1,1,1]),this.wallTexture.load(z)}render(e){const t=this.shader;if(t.enable(),t.setParam("uFogDistance","1f",Ae.fogDistance),t.setParam("uFogBlurDistance","1f",Ae.fogBlurDistance),t.setParam("uLightColor","3fv",[.5,.5,.5]),t.setParam("uLightDirection","3fv",Me.direction),t.setParam("uLowerEdgePoint","2fv",Ae.lowerLeftOnMap),t.setParam("uViewDirOnMap","2fv",Ae.viewDirOnMap),!Ae.effects.shadows){const e=new Float32Array([1,0,0,0,1,0,0,0,1]);t.setUniformMatrix("uNormalTransform","3fv",e)}t.setTexture("uWallTexIndex",0,this.wallTexture),e&&(t.setParam("uShadowTexDimensions","2fv",[e.width,e.height]),t.setTexture("uShadowTexIndex",1,e.depthTexture)),y.features.forEach(e=>{if(y.zoom<e.minZoom||y.zoom>e.maxZoom)return;const i=e.getMatrix();i&&(t.setParam("uFade","1f",e.getFade()),t.setMatrix("uModelMatrix","4fv",i.data),t.setMatrix("uMatrix","4fv",p.Matrix.multiply(i,Ae.viewProjMatrix)),Ae.effects.shadows&&t.setMatrix("uSunMatrix","4fv",p.Matrix.multiply(i,Me.viewProjMatrix)),t.setBuffer("aPosition",e.vertexBuffer),t.setBuffer("aTexCoord",e.texCoordBuffer),t.setBuffer("aNormal",e.normalBuffer),t.setBuffer("aColor",e.colorBuffer),t.setBuffer("aHeight",e.heightBuffer),t.setBuffer("aTintColor",e.tintBuffer),t.setBuffer("aZScale",e.zScaleBuffer),M.drawArrays(M.TRIANGLES,0,e.vertexBuffer.numItems))}),t.disable()}destroy(){}}class Pe{constructor(){this.shader=new p.Shader({source:s,attributes:["aPosition","aNormal"],uniforms:["uModelMatrix","uViewDirOnMap","uMatrix","uDirToSun","uLowerEdgePoint","uFogDistance","uFogBlurDistance","uShadowTexDimensions","uShadowStrength","uShadowTexIndex","uSunMatrix"]}),this.mapPlane=new $}render(e,t,i){const r=this.mapPlane;if(y.zoom<r.minZoom||y.zoom>r.maxZoom)return;const o=this.shader;let n;o.enable(),M.disable(M.CULL_FACE),o.setParam("uDirToSun","3fv",e.direction),o.setParam("uViewDirOnMap","2fv",Ae.viewDirOnMap),o.setParam("uLowerEdgePoint","2fv",Ae.lowerLeftOnMap),o.setParam("uFogDistance","1f",Ae.fogDistance),o.setParam("uFogBlurDistance","1f",Ae.fogBlurDistance),o.setParam("uShadowTexDimensions","2fv",[t.width,t.height]),o.setParam("uShadowStrength","1f",i),o.setTexture("uShadowTexIndex",0,t.depthTexture),(n=r.getMatrix())&&(o.setMatrix("uModelMatrix","4fv",n.data),o.setMatrix("uMatrix","4fv",p.Matrix.multiply(n,Ae.viewProjMatrix)),o.setMatrix("uSunMatrix","4fv",p.Matrix.multiply(n,e.viewProjMatrix)),o.setBuffer("aPosition",r.vertexBuffer),o.setBuffer("aNormal",r.normalBuffer),M.drawArrays(M.TRIANGLES,0,r.vertexBuffer.numItems),o.disable())}destroy(){this.mapPlane.destroy()}}class De{constructor(){this.shader=new p.Shader({source:n,attributes:["aPosition","aTexCoord"],uniforms:["uViewMatrix","uModelMatrix","uTexIndex","uFogDistance","uFogBlurDistance","uLowerEdgePoint","uViewDirOnMap"]})}render(){const e=y.basemapGrid;if(!e)return;if(y.zoom<e.minZoom||y.zoom>e.maxZoom)return;const t=this.shader;t.enable(),t.setParam("uFogDistance","1f",Ae.fogDistance),t.setParam("uFogBlurDistance","1f",Ae.fogBlurDistance),t.setParam("uLowerEdgePoint","2fv",Ae.lowerLeftOnMap),t.setParam("uViewDirOnMap","2fv",Ae.viewDirOnMap);const i=Math.round(y.zoom);let r;for(let t in e.visibleTiles){if((r=e.tiles[t])&&r.isReady){this.renderTile(r);continue}const o=[r.x/2<<0,r.y/2<<0,i-1].join(",");if(e.tiles[o]&&e.tiles[o].isReady){this.renderTile(e.tiles[o]);continue}const n=[[2*r.x,2*r.y,r.zoom+1].join(","),[2*r.x+1,2*r.y,r.zoom+1].join(","),[2*r.x,2*r.y+1,r.zoom+1].join(","),[2*r.x+1,2*r.y+1,r.zoom+1].join(",")];for(let t=0;t<4;t++)e.tiles[n[t]]&&e.tiles[n[t]].isReady&&this.renderTile(e.tiles[n[t]])}t.disable()}renderTile(e){const t=this.shader,i=O*Math.cos(y.position.latitude/180*Math.PI),r=new p.Matrix;r.translate((e.longitude-y.position.longitude)*i,-(e.latitude-y.position.latitude)*O,0),M.enable(M.POLYGON_OFFSET_FILL),M.polygonOffset(L-e.zoom,L-e.zoom),t.setMatrix("uModelMatrix","4fv",r.data),t.setMatrix("uViewMatrix","4fv",p.Matrix.multiply(r,Ae.viewProjMatrix)),t.setBuffer("aPosition",e.vertexBuffer),t.setBuffer("aTexCoord",e.texCoordBuffer),t.setTexture("uTexIndex",0,e.texture),M.drawArrays(M.TRIANGLE_STRIP,0,e.vertexBuffer.numItems),M.disable(M.POLYGON_OFFSET_FILL)}destroy(){}}class Be{constructor(){this.shader=new p.Shader({source:u,attributes:["aPosition","aNormal","aZScale"],uniforms:["uMatrix","uModelMatrix","uNormalMatrix","uFade","uFogDistance","uFogBlurDistance","uViewDirOnMap","uLowerEdgePoint"]}),this.framebuffer=new p.Framebuffer(128,128,!0),this.mapPlane=new $}render(e,t,i){const r=this.shader,o=this.framebuffer,n=new p.Matrix(p.Matrix.multiply(e,t));o.setSize(i[0],i[1]),r.enable(),o.enable(),M.viewport(0,0,i[0],i[1]),M.clearColor(0,0,0,1),M.clear(M.COLOR_BUFFER_BIT|M.DEPTH_BUFFER_BIT),r.setParam("uViewDirOnMap","2fv",Ae.viewDirOnMap),r.setParam("uLowerEdgePoint","2fv",Ae.lowerLeftOnMap),r.setParam("uFogDistance","1f",Ae.fogDistance),r.setParam("uFogBlurDistance","1f",Ae.fogBlurDistance),y.features.items.concat([this.mapPlane]).forEach(t=>{if(y.zoom<t.minZoom||y.zoom>t.maxZoom)return;const i=t.getMatrix();i&&(r.setParam("uFade","1f",t.getFade()),r.setMatrix("uMatrix","4fv",p.Matrix.multiply(i,n)),r.setMatrix("uModelMatrix","4fv",i.data),r.setMatrix("uNormalMatrix","3fv",p.Matrix.transpose3(p.Matrix.invert3(p.Matrix.multiply(i,e)))),r.setBuffer("aPosition",t.vertexBuffer),r.setBuffer("aNormal",t.normalBuffer),r.setBuffer("aZScale",t.zScaleBuffer),M.drawArrays(M.TRIANGLES,0,t.vertexBuffer.numItems))}),r.disable(),o.disable(),M.viewport(0,0,y.width,y.height)}destroy(){this.shader.destroy(),this.framebuffer.destroy(),this.mapPlane.destroy()}}class Se{constructor(){this.shader=new p.Shader({source:h,attributes:["aPosition","aTexCoord"],uniforms:["uInverseTexSize","uNearPlane","uFarPlane","uDepthTexIndex","uFogTexIndex","uEffectStrength"]}),this.framebuffer=new p.Framebuffer(128,128),this.vertexBuffer=new p.Buffer(3,new Float32Array([-1,-1,1e-5,1,-1,1e-5,1,1,1e-5,-1,-1,1e-5,1,1,1e-5,-1,1,1e-5])),this.texCoordBuffer=new p.Buffer(2,new Float32Array([0,0,1,0,1,1,0,0,1,1,0,1]))}render(e,t,i,r){const o=this.shader,n=this.framebuffer;void 0===r&&(r=1),n.setSize(i[0],i[1]),M.viewport(0,0,i[0],i[1]),o.enable(),n.enable(),M.clearColor(1,0,0,1),M.clear(M.COLOR_BUFFER_BIT|M.DEPTH_BUFFER_BIT),o.setParam("uInverseTexSize","2fv",[1/i[0],1/i[1]]),o.setParam("uEffectStrength","1f",r),o.setParam("uNearPlane","1f",Ae.nearPlane),o.setParam("uFarPlane","1f",Ae.farPlane),o.setBuffer("aPosition",this.vertexBuffer),o.setBuffer("aTexCoord",this.texCoordBuffer),o.setTexture("uDepthTexIndex",0,e),o.setTexture("uFogTexIndex",1,t),M.drawArrays(M.TRIANGLES,0,this.vertexBuffer.numItems),o.disable(),n.disable(),M.viewport(0,0,y.width,y.height)}destroy(){this.shader.destroy(),this.framebuffer.destroy(),this.vertexBuffer.destroy(),this.texCoordBuffer.destroy()}}Ae.Overlay={init:function(){const e=this.createGeometry();this.vertexBuffer=new p.Buffer(3,new Float32Array(e.vertices)),this.texCoordBuffer=new p.Buffer(2,new Float32Array(e.texCoords)),this.shader=new p.Shader({source:l,attributes:["aPosition","aTexCoord"],uniforms:["uMatrix","uTexIndex"]})},createGeometry:function(){const e=[],t=[];return e.push(-1,-1,1e-5,1,-1,1e-5,1,1,1e-5),e.push(-1,-1,1e-5,1,1,1e-5,-1,1,1e-5),t.push(0,0,1,0,1,1),t.push(0,0,1,1,0,1),{vertices:e,texCoords:t}},render:function(e,t){const i=this.shader;i.enable(),M.disable(M.DEPTH_TEST),i.setMatrix("uMatrix","4fv",p.Matrix.identity().data),i.setBuffer("aPosition",this.vertexBuffer),i.setBuffer("aTexCoord",this.texCoordBuffer),i.setTexture("uTexIndex",0,e),M.drawArrays(M.TRIANGLES,0,this.vertexBuffer.numItems),M.enable(M.DEPTH_TEST),i.disable()},destroy:function(){}};class Ce{constructor(){this.HORIZON_HEIGHT=2e3,this.skyShader=new p.Shader({source:c,attributes:["aPosition"],uniforms:["uAbsoluteHeight","uMatrix","uFogColor"]}),this.v1=this.v2=this.v3=this.v4=[!1,!1,!1],this.updateGeometry([[0,0,0],[0,0,0],[0,0,0],[0,0,0]]),this.floorShader=new p.Shader({source:f,attributes:["aPosition"],uniforms:["uColor","uMatrix"]})}updateGeometry(e){let t=[e[3][0],e[3][1],0],i=[e[2][0],e[2][1],0],r=[e[2][0],e[2][1],this.HORIZON_HEIGHT],o=[e[3][0],e[3][1],this.HORIZON_HEIGHT];if(Te(t,this.v1)&&Te(i,this.v2)&&Te(r,this.v3)&&Te(o,this.v4))return;this.v1=t,this.v2=i,this.v3=r,this.v4=o,this.skyVertexBuffer&&this.skyVertexBuffer.destroy();const n=[...t,...i,...r,...t,...r,...o];this.skyVertexBuffer=new p.Buffer(3,new Float32Array(n)),t=[e[0][0],e[0][1],1],i=[e[1][0],e[1][1],1],r=[e[2][0],e[2][1],1],o=[e[3][0],e[3][1],1],this.floorVertexBuffer&&this.floorVertexBuffer.destroy(),this.floorVertexBuffer=new p.Buffer(3,new Float32Array([...t,...i,...r,...o]))}render(){const e=this.skyShader,t=this.floorShader,i=Ae.fogColor;e.enable(),e.setParam("uFogColor","3fv",i),e.setParam("uAbsoluteHeight","1f",10*this.HORIZON_HEIGHT),e.setMatrix("uMatrix","4fv",Ae.viewProjMatrix.data),e.setBuffer("aPosition",this.skyVertexBuffer),M.drawArrays(M.TRIANGLES,0,this.skyVertexBuffer.numItems),e.disable(),t.enable(),t.setParam("uColor","4fv",[...i,1]),t.setMatrix("uMatrix","4fv",Ae.viewProjMatrix.data),t.setBuffer("aPosition",this.floorVertexBuffer),M.drawArrays(M.TRIANGLE_FAN,0,this.floorVertexBuffer.numItems),t.disable()}destroy(){this.skyVertexBuffer.destroy(),this.skyShader.destroy(),this.floorVertexBuffer.destroy(),this.floorShader.destroy()}}class Fe{constructor(){this.shader=new p.Shader({source:d,attributes:["aPosition","aTexCoord"],uniforms:["uInverseTexSize","uTexIndex"]}),this.framebuffer=new p.Framebuffer(128,128),this.vertexBuffer=new p.Buffer(3,new Float32Array([-1,-1,1e-5,1,-1,1e-5,1,1,1e-5,-1,-1,1e-5,1,1,1e-5,-1,1,1e-5])),this.texCoordBuffer=new p.Buffer(2,new Float32Array([0,0,1,0,1,1,0,0,1,1,0,1]))}render(e,t){this.framebuffer.setSize(t[0],t[1]),M.viewport(0,0,t[0],t[1]),this.shader.enable(),this.framebuffer.enable(),M.clearColor(1,0,0,1),M.clear(M.COLOR_BUFFER_BIT|M.DEPTH_BUFFER_BIT),this.shader.setParam("uInverseTexSize","2fv",[1/this.framebuffer.width,1/this.framebuffer.height]),this.shader.setBuffer("aPosition",this.vertexBuffer),this.shader.setBuffer("aTexCoord",this.texCoordBuffer),this.shader.setTexture("uTexIndex",0,e),M.drawArrays(M.TRIANGLES,0,this.vertexBuffer.numItems),this.shader.disable(),this.framebuffer.disable(),M.viewport(0,0,y.width,y.height)}destroy(){this.shader.destroy(),this.framebuffer.destroy(),this.vertexBuffer.destroy(),this.texCoordBuffer.destroy()}}class Ie{constructor(){this.shader=new p.Shader({source:m,attributes:["aPosition","aTexCoord"],uniforms:["uProjMatrix","uViewMatrix","uModelMatrix","uTexIndex"]})}render(){const e=this.shader;e.enable();const t=Ae.metersPerDegreeLongitude;M.enable(M.BLEND),M.blendFunc(M.SRC_ALPHA,M.ONE_MINUS_SRC_ALPHA),y.markers.forEach(i=>{const r=new p.Matrix;r.translate((i.position.longitude-y.position.longitude)*t,-(i.position.latitude-y.position.latitude)*O,i.position.altitude),e.setMatrix("uProjMatrix","4fv",Ae.projMatrix.data),e.setMatrix("uViewMatrix","4fv",Ae.viewMatrix.data),e.setMatrix("uModelMatrix","4fv",r.data),e.setBuffer("aPosition",i.vertexBuffer),e.setBuffer("aTexCoord",i.texCoordBuffer),e.setTexture("uTexIndex",0,i.texture),M.drawArrays(M.TRIANGLES,0,i.vertexBuffer.numItems)}),M.disable(M.BLEND),e.disable()}destroy(){this.shader.destroy()}}E.VERSION="4.0.0"}();