var OSMBuildings=function(a){function b(a,b,c){return Math.min(c,Math.max(a,b))}function c(a,c,d){var e=d-c;return b((a-c)/e,0,1)}function d(a,b,d,e){var f=b.min,g=b.max,h=c(a,f[d],g[d]);return f[e]+(g[e]-f[e])*h}function e(a,b,c){var d=b/360+.5,e=Math.min(1,Math.max(0,.5-Math.log(Math.tan(Math.PI/4+Math.PI/2*a/180))/Math.PI/2));return{x:d*c,y:e*c}}function f(a,b,c){return a/=c,b/=c,{latitude:(2*Math.atan(Math.exp(Math.PI*(1-2*b)))-Math.PI/2)*(180/Math.PI),longitude:360*a-180}}function g(a,b){return a.replace(/\{(\w+)\}/g,function(a,c){return b[c]||a})}function h(a,b,c){a.addEventListener(b,c,!1)}function i(a){a.preventDefault&&a.preventDefault(),a.returnValue=!1}function j(a,b,c){var d=a[0]-b[0],e=a[1]-b[1],f=a[2]-b[2],g=b[0]-c[0],h=b[1]-c[1],i=b[2]-c[2],j=e*i-f*h,k=f*g-d*i,l=d*h-e*g,m=q(j,k,l);return 0===Math.round(5e3*m[2])}function k(a,b){this._url=a,b=b||{},this._tileSize=b.tileSize||B,this._tiles={},this._shader=new T("tileplane")}function l(a,b,c){this.tileX=a,this.tileY=b,this.zoom=c,this._vertexBuffer=M.createBuffer(3,new Float32Array([255,255,0,255,0,0,0,255,0,0,0,0])),this._texCoordBuffer=M.createBuffer(2,new Float32Array([1,1,1,0,0,1,0,0]))}function m(a,b){var c=a[0]-b[0],d=a[1]-b[1];return c*c+d*d}function n(a){var b=a[0],c=b.length;if(16>c)return!1;var d,e=1/0,f=-1/0,g=1/0,h=-1/0;for(d=0;c>d;d++)e=Math.min(e,b[d][0]),f=Math.max(f,b[d][0]),g=Math.min(g,b[d][1]),h=Math.max(h,b[d][1]);var i=f-e,j=h-g,k=i/j;if(.85>k||k>1.15)return!1;var l=[e+i/2,g+j/2],n=(i+j)/4,o=n*n;for(d=0;c>d;d++){var p=m(b[d],l);if(.8>p/o||p/o>1.2)return!1}return!0}function o(a){for(var b=a[0],c=1/0,d=-1/0,e=1/0,f=-1/0,g=0;g<b.length;g++)c=Math.min(c,b[g][0]),d=Math.max(d,b[g][0]),e=Math.min(e,b[g][1]),f=Math.max(f,b[g][1]);return{minX:c,maxX:d,minY:e,maxY:f}}function p(a){return a*z/180}function q(a,b,c){var d=Math.sqrt(a*a+b*b+c*c);return 0===d&&(d=1e-5),[a/d,b/d,c/d]}var r=function(){"use strict";function a(a,e){var f=c(b(a[0],!0)),g=e?{vertices:[],indices:[]}:[];if(!f)return g;var h,j,k,l,m,n,o,p,q,r=80;for(q=0;r>=0&&q<a.length;q++)r-=a[q].length;if(0>r){h=f.next,j=l=h.p[0],k=m=h.p[1];do n=h.p[0],o=h.p[1],j>n&&(j=n),k>o&&(k=o),n>l&&(l=n),o>m&&(m=o),h=h.next;while(h!==f);p=Math.max(l-j,m-k)}return a.length>1&&(f=i(a,f)),d(f,g,j,k,p),g}function b(a,b){var c,d,e,f,g,h=0,i=a.length;for(c=0,d=i-1;i>c;d=c++)e=a[c],f=a[d],h+=(f[0]-e[0])*(e[1]+f[1]);if(b===h>0)for(c=0;i>c;c++)g=y(a[c],g);else for(c=i-1;c>=0;c--)g=y(a[c],g);return g}function c(a,b){b||(b=a);var c,d=a;do if(c=!1,r(d.p,d.next.p)||0===q(d.prev.p,d.p,d.next.p)){if(d.prev.next=d.next,d.next.prev=d.prev,d.prevZ&&(d.prevZ.nextZ=d.nextZ),d.nextZ&&(d.nextZ.prevZ=d.prevZ),d=b=d.prev,d===d.next)return null;c=!0}else d=d.next;while(c||d!==b);return b}function d(a,b,i,j,k,m){if(a){var n=void 0!==b.vertices;m||void 0===i||l(a,i,j,k);for(var o,p,q=a;a.prev!==a.next;)if(o=a.prev,p=a.next,f(a,i,j,k))n?(e(b,o),e(b,a),e(b,p)):(b.push(o.p),b.push(a.p),b.push(p.p)),p.prev=o,o.next=p,a.prevZ&&(a.prevZ.nextZ=a.nextZ),a.nextZ&&(a.nextZ.prevZ=a.prevZ),a=p.next,q=p.next;else if(a=p,a===q){m?1===m?(a=g(a,b),d(a,b,i,j,k,2)):2===m&&h(a,b,i,j,k):d(c(a),b,i,j,k,1);break}}}function e(a,b){b.source&&(b=b.source);var c=b.index;if(null===c){var d=b.p.length,e=a.vertices;b.index=c=e.length/d;for(var f=0;d>f;f++)e.push(b.p[f])}a.indices.push(c)}function f(a,b,c,d){var e=a.prev.p,f=a.p,g=a.next.p,h=e[0],i=f[0],j=g[0],k=e[1],l=f[1],m=g[1],o=h*l-k*i,p=h*m-k*j,q=j*l-m*i,r=o-p-q;if(0>=r)return!1;var s,t,u,v,w,x,y,z=m-k,A=h-j,B=k-l,C=i-h;if(void 0!==b){var D=i>h?j>h?h:j:j>i?i:j,E=l>k?m>k?k:m:m>l?l:m,F=h>i?h>j?h:j:i>j?i:j,G=k>l?k>m?k:m:l>m?l:m,H=n(D,E,b,c,d),I=n(F,G,b,c,d);for(y=a.nextZ;y&&y.z<=I;)if(s=y.p,y=y.nextZ,s!==e&&s!==g&&(t=s[0],u=s[1],v=z*t+A*u-p,v>=0&&(w=B*t+C*u+o,w>=0&&(x=r-v-w,x>=0&&(v&&w||v&&x||w&&x)))))return!1;for(y=a.prevZ;y&&y.z>=H;)if(s=y.p,y=y.prevZ,s!==e&&s!==g&&(t=s[0],u=s[1],v=z*t+A*u-p,v>=0&&(w=B*t+C*u+o,w>=0&&(x=r-v-w,x>=0&&(v&&w||v&&x||w&&x)))))return!1}else for(y=a.next.next;y!==a.prev;)if(s=y.p,y=y.next,t=s[0],u=s[1],v=z*t+A*u-p,v>=0&&(w=B*t+C*u+o,w>=0&&(x=r-v-w,x>=0&&(v&&w||v&&x||w&&x))))return!1;return!0}function g(a,b){var c=!!b.vertices,d=a;do{var f=d.prev,g=d.next.next;if(s(f.p,d.p,d.next.p,g.p)&&u(f,g)&&u(g,f)){c?(e(b,f),e(b,d),e(b,g)):(b.push(f.p),b.push(d.p),b.push(g.p)),f.next=g,g.prev=f;var h=d.prevZ,i=d.nextZ&&d.nextZ.nextZ;h&&(h.nextZ=i),i&&(i.prevZ=h),d=a=g}d=d.next}while(d!==a);return d}function h(a,b,e,f,g){var h=a;do{for(var i=h.next.next;i!==h.prev;){if(p(h,i)){var j=x(h,i);return h=c(h,h.next),j=c(j,j.next),d(h,b,e,f,g),void d(j,b,e,f,g)}i=i.next}h=h.next}while(h!==a)}function i(a,d){for(var e=a.length,f=[],g=1;e>g;g++){var h=c(b(a[g],!1));h&&f.push(o(h))}for(f.sort(w),g=0;g<f.length;g++)j(f[g],d),d=c(d,d.next);return d}function j(a,b){if(b=k(a,b)){var d=x(b,a);c(d,d.next)}}function k(a,b){var c,d,e,f=b,g=a.p,h=g[0],i=g[1],j=-1/0;do{if(d=f.p,e=f.next.p,i<=d[1]&&i>=e[1]){var k=d[0]+(i-d[1])*(e[0]-d[0])/(e[1]-d[1]);h>=k&&k>j&&(j=k,c=d[0]<e[0]?f:f.next)}f=f.next}while(f!==b);if(!c)return null;var l,m,n,o,p,q,r=c.p[0],s=c.p[1],t=h*s-i*r,v=h*i-i*j,w=i-i,x=h-j,y=i-s,z=r-h,A=t-v-(j*s-i*r),B=0>=A?-1:1,C=c,D=1/0;for(f=c.next;f!==C;)l=f.p[0],m=f.p[1],n=h-l,n>=0&&l>=r&&(o=(w*l+x*m-v)*B,o>=0&&(p=(y*l+z*m+t)*B,p>=0&&A*B-o-p>=0&&(q=Math.abs(i-m)/n,D>q&&u(f,a)&&(c=f,D=q)))),f=f.next;return c}function l(a,b,c,d){var e=a;do null===e.z&&(e.z=n(e.p[0],e.p[1],b,c,d)),e.prevZ=e.prev,e.nextZ=e.next,e=e.next;while(e!==a);e.prevZ.nextZ=null,e.prevZ=null,m(e)}function m(a){for(var b,c,d,e,f,g,h,i,j=1;;){for(c=a,a=null,f=null,g=0;c;){for(g++,d=c,h=0,b=0;j>b&&(h++,d=d.nextZ,d);b++);for(i=j;h>0||i>0&&d;)0===h?(e=d,d=d.nextZ,i--):0!==i&&d?c.z<=d.z?(e=c,c=c.nextZ,h--):(e=d,d=d.nextZ,i--):(e=c,c=c.nextZ,h--),f?f.nextZ=e:a=e,e.prevZ=f,f=e;c=d}if(f.nextZ=null,1>=g)return a;j*=2}}function n(a,b,c,d,e){return a=1e3*(a-c)/e,a=16711935&(a|a<<8),a=252645135&(a|a<<4),a=858993459&(a|a<<2),a=1431655765&(a|a<<1),b=1e3*(b-d)/e,b=16711935&(b|b<<8),b=252645135&(b|b<<4),b=858993459&(b|b<<2),b=1431655765&(b|b<<1),a|b<<1}function o(a){var b=a,c=a;do b.p[0]<c.p[0]&&(c=b),b=b.next;while(b!==a);return c}function p(a,b){return!t(a,a.p,b.p)&&u(a,b)&&u(b,a)&&v(a,a.p,b.p)}function q(a,b,c){var d=(b[1]-a[1])*(c[0]-b[0])-(b[0]-a[0])*(c[1]-b[1]);return d>0?1:0>d?-1:0}function r(a,b){return a[0]===b[0]&&a[1]===b[1]}function s(a,b,c,d){return q(a,b,c)!==q(a,b,d)&&q(c,d,a)!==q(c,d,b)}function t(a,b,c){var d=a;do{var e=d.p,f=d.next.p;if(e!==b&&f!==b&&e!==c&&f!==c&&s(e,f,b,c))return!0;d=d.next}while(d!==a);return!1}function u(a,b){return-1===q(a.prev.p,a.p,a.next.p)?-1!==q(a.p,b.p,a.next.p)&&-1!==q(a.p,a.prev.p,b.p):-1===q(a.p,b.p,a.prev.p)||-1===q(a.p,a.next.p,b.p)}function v(a,b,c){var d=a,e=!1,f=(b[0]+c[0])/2,g=(b[1]+c[1])/2;do{var h=d.p,i=d.next.p;h[1]>g!=i[1]>g&&f<(i[0]-h[0])*(g-h[1])/(i[1]-h[1])+h[0]&&(e=!e),d=d.next}while(d!==a);return e}function w(a,b){return a.p[0]-b.p[0]}function x(a,b){var c=new z(a.p),d=new z(b.p),e=a.next,f=b.prev;return c.source=a,d.source=b,a.next=b,b.prev=a,c.next=e,e.prev=c,d.next=c,c.prev=d,f.next=d,d.prev=f,d}function y(a,b){var c=new z(a);return b?(c.next=b.next,c.prev=b,b.next.prev=c,b.next=c):(c.prev=c,c.next=c),c}function z(a){this.p=a,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.source=null,this.index=null}return a}(),s=function(){function a(a,b,c){return 0>c&&(c+=1),c>1&&(c-=1),1/6>c?a+6*(b-a)*c:.5>c?b:2/3>c?a+(b-a)*(2/3-c)*6:a}function b(a,b){return Math.min(b,Math.max(0,a))}var c={aqua:"#00ffff",black:"#000000",blue:"#0000ff",fuchsia:"#ff00ff",gray:"#808080",grey:"#808080",green:"#008000",lime:"#00ff00",maroon:"#800000",navy:"#000080",olive:"#808000",orange:"#ffa500",purple:"#800080",red:"#ff0000",silver:"#c0c0c0",teal:"#008080",white:"#ffffff",yellow:"#ffff00"},d=function(a,b,c,d){this.H=a,this.S=b,this.L=c,this.A=d};return d.parse=function(a){var b,d=0,e=0,f=0,g=1;if(a=(""+a).toLowerCase(),a=c[a]||a,b=a.match(/^#(\w{2})(\w{2})(\w{2})$/))d=parseInt(b[1],16),e=parseInt(b[2],16),f=parseInt(b[3],16);else{if(!(b=a.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/)))return;d=parseInt(b[1],10),e=parseInt(b[2],10),f=parseInt(b[3],10),g=b[4]?parseFloat(b[5]):1}return this.fromRGBA(d,e,f,g)},d.fromRGBA=function(a,b,c,e){"object"==typeof a?(b=a.g/255,c=a.b/255,e=a.a,a=a.r/255):(a/=255,b/=255,c/=255);var f,g,h=Math.max(a,b,c),i=Math.min(a,b,c),j=(h+i)/2,k=h-i;if(k){switch(g=j>.5?k/(2-h-i):k/(h+i),h){case a:f=(b-c)/k+(c>b?6:0);break;case b:f=(c-a)/k+2;break;case c:f=(a-b)/k+4}f*=60}else f=g=0;return new d(f,g,j,e)},d.prototype={toRGBA:function(){var c=b(this.H,360),d=b(this.S,1),e=b(this.L,1),f={a:b(this.A,1)};if(0===d)f.r=e,f.g=e,f.b=e;else{var g=.5>e?e*(1+d):e+d-e*d,h=2*e-g;c/=360,f.r=a(h,g,c+1/3),f.g=a(h,g,c),f.b=a(h,g,c-1/3)}return{r:Math.round(255*f.r),g:Math.round(255*f.g),b:Math.round(255*f.b),a:f.a}},toString:function(){var a=this.toRGBA();return 1===a.a?"#"+((1<<24)+(a.r<<16)+(a.g<<8)+a.b).toString(16).slice(1,7):"rgba("+[a.r,a.g,a.b,a.a.toFixed(2)].join(",")+")"},hue:function(a){return new d(this.H*a,this.S,this.L,this.A)},saturation:function(a){return new d(this.H,this.S*a,this.L,this.A)},lightness:function(a){return new d(this.H,this.S,this.L*a,this.A)},alpha:function(a){return new d(this.H,this.S,this.L,this.A*a)}},d}(this),t=function(a,b){b=b||{},this._listeners={},this._layers=[],this._container=document.getElementById(a),this.minZoom=parseFloat(b.minZoom)||10,this.maxZoom=parseFloat(b.maxZoom)||20,this.maxZoom<this.minZoom&&(this.maxZoom=this.minZoom),this._initState(b),this._initEvents(this._container),this._initRenderer(this._container),this.setDisabled(b.disabled)};t.prototype={_initState:function(a){this._center={},this._size={width:0,height:0},a=u.load(a),this.setCenter(a.center||{latitude:52.52,longitude:13.41}),this.setZoom(a.zoom||this.minZoom),this.setRotation(a.rotation||0),this.setTilt(a.tilt||0),this.on("change",function(){u.save(this)}.bind(this)),u.save(this)},_initEvents:function(b){this._startX=0,this._startY=0,this._startRotation=0,this._startZoom=0,this._hasTouch="ontouchstart"in a,this._dragStartEvent=this._hasTouch?"touchstart":"mousedown",this._dragMoveEvent=this._hasTouch?"touchmove":"mousemove",this._dragEndEvent=this._hasTouch?"touchend":"mouseup",h(b,this._dragStartEvent,this._onDragStart.bind(this)),h(b,"dblclick",this._onDoubleClick.bind(this)),h(document,this._dragMoveEvent,this._onDragMove.bind(this)),h(document,this._dragEndEvent,this._onDragEnd.bind(this)),this._hasTouch?h(b,"gesturechange",this._onGestureChange.bind(this)):(h(b,"mousewheel",this._onMouseWheel.bind(this)),h(b,"DOMMouseScroll",this._onMouseWheel.bind(this))),h(a,"resize",this._onResize.bind(this))},_initRenderer:function(a){var b=document.createElement("CANVAS");b.style.position="absolute",b.style.pointerEvents="none",a.appendChild(b);try{y=b.getContext("experimental-webgl",{antialias:!0,depth:!0,premultipliedAlpha:!1})}catch(c){throw c}h(b,"webglcontextlost",function(a){i(a),clearInterval(this._loop)}.bind(this)),h(b,"webglcontextrestored",this._initGL.bind(this)),this._initGL()},_initGL:function(){this.setSize({width:this._container.offsetWidth,height:this._container.offsetHeight}),y.enable(y.CULL_FACE),y.enable(y.DEPTH_TEST),this._loop=setInterval(this._render.bind(this),17)},_render:function(){requestAnimationFrame(function(){y.clearColor(.5,.5,.5,1),y.clear(y.COLOR_BUFFER_BIT|y.DEPTH_BUFFER_BIT);for(var a=0;a<this._layers.length;a++)this._layers[a].render(this._projection)}.bind(this))},_onDragStart:function(a){if(!(this._isDisabled||void 0!==a.button&&0!==a.button)){if(i(a),void 0!==a.touches){if(this._startRotation=this._rotation,this._startZoom=this._zoom,a.touches.length>1)return;a=a.touches[0]}this._startX=a.clientX,this._startY=a.clientY,this._isDragging=!0}},_onDragMove:function(a){if(!this._isDisabled&&this._isDragging){if(void 0!==a.touches){if(a.touches.length>1)return;a=a.touches[0]}var b=a.clientX-this._startX,c=a.clientY-this._startY,d=this._rotatePoint(b,c,this._rotation*Math.PI/180);this.setCenter(f(this._origin.x-d.x,this._origin.y-d.y,this._worldSize)),this._startX=a.clientX,this._startY=a.clientY}},_onDragEnd:function(a){if(!this._isDisabled&&this._isDragging){if(void 0!==a.touches){if(a.touches.length>1)return;a=a.touches[0]}this._isDragging=!1;var b=a.clientX-this._startX,c=a.clientY-this._startY,d=this._rotatePoint(b,c,this._rotation*Math.PI/180);this.setCenter(f(this._origin.x-d.x,this._origin.y-d.y,this._worldSize))}},_rotatePoint:function(a,b,c){return{x:Math.cos(c)*a-Math.sin(c)*b,y:Math.sin(c)*a+Math.cos(c)*b}},_onGestureChange:function(a){this._isDisabled||(i(a),this.setRotation(this._startRotation-a.rotation),this.setZoom(this._startZoom+(a.scale-1)))},_onDoubleClick:function(a){this._isDisabled||(i(a),this.setZoom(this._zoom+1,a))},_onMouseWheel:function(a){if(!this._isDisabled){i(a);var b=0;a.wheelDeltaY?b=a.wheelDeltaY:a.wheelDelta?b=a.wheelDelta:a.detail&&(b=-a.detail);var c=.2*(b>0?1:0>b?-1:0);this.setZoom(this._zoom+c,a)}},_onResize:function(){clearTimeout(this._resizeTimer),this._resizeTimer=setTimeout(function(){var a=this._container;(this._size.width!==a.offsetWidth||this._size.height!==a.offsetHeight)&&this.setSize({width:a.offsetWidth,height:a.offsetHeight})}.bind(this),250)},_emit:function(a){if(this._listeners[a])for(var b=this._listeners[a],c=0,d=b.length;d>c;c++)b[c]()},addLayer:function(a){this._layers.push(a)},removeLayer:function(a){for(var b=0;b<this._layers.length;b++)if(this._layers[b]===a)return void this._layers[b].splice(b,1)},setDisabled:function(a){this._isDisabled=!!a},on:function(a,b){var c=this._listeners[a]||(this._listeners[a]=[]);return c.push(b),this},_setOrigin:function(a){this._origin=a},off:function(){return this},getZoom:function(){return this._zoom},setZoom:function(a,c){if(a=b(parseFloat(a),this.minZoom,this.maxZoom),this._zoom!==a){if(c){var d=this.getSize(),g=d.width/2-c.clientX,h=d.height/2-c.clientY,i=f(this._origin.x-g,this._origin.y-h,this._worldSize);this._zoom=a,this._worldSize=B*Math.pow(2,a);var j=e(i.latitude,i.longitude,this._worldSize);this._setOrigin({x:j.x+g,y:j.y+h}),this._center=f(this._origin.x,this._origin.y,this._worldSize)}else this._zoom=a,this._worldSize=B*Math.pow(2,a),this._setOrigin(e(this._center.latitude,this._center.longitude,this._worldSize));this._emit("change")}return this},getCenter:function(){return this._center},setCenter:function(a){return a.latitude=b(parseFloat(a.latitude),-90,90),a.longitude=b(parseFloat(a.longitude),-180,180),(this._center.latitude!==a.latitude||this._center.longitude!==a.longitude)&&(this._center=a,this._setOrigin(e(a.latitude,a.longitude,this._worldSize)),this._emit("change")),this},getBounds:function(){var a=e(this._center.latitude,this._center.longitude,this._worldSize),b=this.getSize(),c=b.width/2,d=b.height/2,g=f(a.x-c,a.y-d,this._worldSize),h=f(a.x+c,a.y+d,this._worldSize);return{n:g.latitude,w:g.longitude,s:h.latitude,e:h.longitude}},setSize:function(a){var b=y.canvas;return(a.width!==this._size.width||a.height!==this._size.height)&&(b.width=this._size.width=a.width,b.height=this._size.height=a.height,y.viewport(0,0,a.width,a.height),this._projection=R.perspective(20,a.width,a.height,4e4),this._emit("resize")),this},getSize:function(){return this._size},getOrigin:function(){return this._origin},getRotation:function(){return this._rotation},setRotation:function(a){return a=parseFloat(a)%360,this._rotation!==a&&(this._rotation=a,this._emit("change")),this},getTilt:function(){return this._tilt},setTilt:function(a){return a=b(parseFloat(a),0,70),this._tilt!==a&&(this._tilt=a,this._emit("change")),this},getContext:function(){return y},destroy:function(){var a=y.canvas;a.parentNode.removeChild(a),y=null,this._listeners=null;for(var b=0;b<this._layers.length;b++)this._layers[b].destroy();this._layers=null}};var u={};!function(){function a(a){if(history.replaceState){var b=[],c=a.getCenter();b.push("latitude="+c.latitude.toFixed(5)),b.push("longitude="+c.longitude.toFixed(5)),b.push("zoom="+a.getZoom().toFixed(1)),b.push("tilt="+a.getTilt().toFixed(1)),b.push("rotation="+a.getRotation().toFixed(1)),history.replaceState({},"","?"+b.join("&"))}}u.load=function(a){var b=location.search;if(b){var c={};b=b.substring(1).replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(a,b,d){b&&(c[b]=d)}),void 0!==c.latitude&&void 0!==c.longitude&&(a.center={latitude:parseFloat(c.latitude),longitude:parseFloat(c.longitude)}),void 0!==c.zoom&&(a.zoom=parseFloat(c.zoom)),void 0!==c.rotation&&(a.rotation=parseFloat(c.rotation)),void 0!==c.tilt&&(a.tilt=parseFloat(c.tilt))}return a};var b;u.save=function(c){clearTimeout(b),b=setTimeout(function(){a(c)},1e3)}}();var v,w,x=function(a){a=a||{},K.fixedZoom=16,void 0===a.src?K.src=D.replace("{k}",a.dataKey||C):"string"==typeof a.src&&(K.src=a.src),a.map&&this.addTo(a.map),a.style&&this.setStyle(a.style)};!function(){function a(){K.onMapChange()}function b(){K.onMapResize(),w.onMapResize()}x.VERSION="0.1.5",x.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>',x.prototype={addTo:function(c){return c.addLayer(this),v={},c.on("change",function(){v.zoom=c.getZoom(),v.bounds=c.getBounds(),v.origin=c.getOrigin(),v.rotation=c.getRotation(),v.tilt=c.getTilt(),a()}),c.on("resize",function(){v.size=c.getSize(),v.bounds=c.getBounds(),b()}),v.size=c.getSize(),v.zoom=c.getZoom(),v.bounds=c.getBounds(),v.origin=c.getOrigin(),v.rotation=c.getRotation(),v.tilt=c.getTilt(),w=new S(c.getContext()),a(),b(),this},remove:function(){},render:function(){return w.render(),this},destroy:function(){K.destroy()},setStyle:function(a){var b=a.color||a.wallColor;return b&&(F=s.parse(b).toRGBA()),this},addMesh:function(a){var b=new O(a);return N.add(b),"string"==typeof a&&b.load(a),this}}}();var y,z=Math.PI,A=14.5,B=256,C="anonymous",D="http://{s}.data.osmbuildings.org/0.2/{k}/tile/{z}/{x}/{y}.json",E=10,F=s.parse("rgb(220, 210, 200)").toRGBA(),G={zoomAlpha:{min:{zoom:17,alpha:1},max:{zoom:20,alpha:1}}},H={};!function(){var a={};H.loadJSON=function(b,c){if(a[b])return a[b];var d=new XMLHttpRequest;return d.onreadystatechange=function(){if(4===d.readyState&&(delete a[b],!(!d.status||d.status<200||d.status>299)&&d.responseText)){var e;try{e=JSON.parse(d.responseText)}catch(f){console.error("Could not parse JSON from "+b+"\n"+f.message)}c(e)}},a[b]=d,d.open("GET",b),d.send(null),{abort:function(){d.abort(),delete a[b]}}},H.abortAll=function(){for(var b in a)a[b].abort();a={}}}();var I={tileplane:{src:{vertex:"\nprecision mediump float;\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMatrix;\nvarying vec2 vTexCoord;\nvoid main() {\n  gl_Position = uMatrix * aPosition;\n  vTexCoord = aTexCoord;\n}\n",fragment:"\nprecision mediump float;\nuniform sampler2D uTileImage;\nvarying vec2 vTexCoord;\nvoid main() {\n  gl_FragColor = texture2D(uTileImage, vec2(vTexCoord.x, -vTexCoord.y));\n}\n"},attributes:["aPosition","aTexCoord"],uniforms:["uMatrix","uTileImage"]},"default":{src:{vertex:"\nprecision mediump float;\nattribute vec4 aPosition;\nattribute vec3 aNormal;\nattribute vec3 aColor;\nuniform mat4 uMatrix;\nuniform mat3 uNormalTransform;\nuniform vec3 uLightDirection;\nuniform vec3 uLightColor;\nvarying vec3 vColor;\nvarying vec4 vPosition;\nvoid main() {\n  gl_Position = uMatrix * aPosition;\n  vPosition = aPosition;\n  vec3 transformedNormal = aNormal * uNormalTransform;\n  float intensity = max( dot(transformedNormal, uLightDirection), 0.0) / 1.5;\n  vColor = aColor + uLightColor * intensity;\n}",fragment:"\nprecision mediump float;\nuniform float uAlpha;\nvarying vec4 vPosition;\nvarying vec3 vColor;\nfloat gradientHeight = 90.0;\nfloat maxGradientStrength = 0.3;\nvoid main() {\n  float shading = clamp((gradientHeight-vPosition.z) / (gradientHeight/maxGradientStrength), 0.0, maxGradientStrength);\n  gl_FragColor = vec4(vColor - shading, uAlpha);\n//  float fog = clamp((10.0-vPosition.y)/20.0, 0.0, 0.5);\n//  gl_FragColor = vec4(vColor - shading, uAlpha-fog);\n}\n"},attributes:["aPosition","aColor","aNormal"],uniforms:["uNormalTransform","uMatrix","uAlpha","uLightColor","uLightDirection"]}},J={LAT_SEGMENTS:32,LON_SEGMENTS:32,quad:function(a,b,c,d,e,f){this.addTriangle(a,b,c,d,f),this.addTriangle(a,c,e,d,f)},circle:function(a,b,c,d,e){for(var f,g,h=this.LON_SEGMENTS,i=0;h>i;i++)f=i/h,g=(i+1)/h,this.addTriangle(a,[b[0]+c*Math.sin(f*Math.PI*2),b[1]+c*Math.cos(f*Math.PI*2),d],[b[0],b[1],d],[b[0]+c*Math.sin(g*Math.PI*2),b[1]+c*Math.cos(g*Math.PI*2),d],e)},polygon:function(a,b,c,d){for(var e=r(b),f=0,g=e.length-2;g>f;f+=3)this.addTriangle(a,[e[f][0],e[f][1],c],[e[f+1][0],e[f+1][1],c],[e[f+2][0],e[f+2][1],c],d)},polygon3d:function(a,b,c){var d,e,f,g=b[0],h=g.length;if(4>=h)return this.addTriangle(a,g[0],g[2],g[1],c),void(4===h&&this.addTriangle(a,g[0],g[3],g[2],c));if(j(g[0],g[1],g[2])){for(var i=0,k=b[0].length;k>i;i++)b[0][i]=[b[0][i][2],b[0][i][1],b[0][i][0]];for(d=r(b),e=0,f=d.length-2;f>e;e+=3)this.addTriangle(a,[d[e][2],d[e][1],d[e][0]],[d[e+1][2],d[e+1][1],d[e+1][0]],[d[e+2][2],d[e+2][1],d[e+2][0]],c)}else for(d=r(b),e=0,f=d.length-2;f>e;e+=3)this.addTriangle(a,[d[e][0],d[e][1],d[e][2]],[d[e+1][0],d[e+1][1],d[e+1][2]],[d[e+2][0],d[e+2][1],d[e+2][2]],c)},cylinder:function(a,b,c,d,e,f,g){for(var h,i,j,k,l,m,n=this.LON_SEGMENTS,o=0;n>o;o++)h=o/n,i=(o+1)/n,j=Math.sin(h*Math.PI*2),k=Math.cos(h*Math.PI*2),l=Math.sin(i*Math.PI*2),m=Math.cos(i*Math.PI*2),this.addTriangle(a,[b[0]+c*j,b[1]+c*k,e],[b[0]+d*l,b[1]+d*m,f],[b[0]+c*l,b[1]+c*m,e],g),0!==d&&this.addTriangle(a,[b[0]+d*j,b[1]+d*k,f],[b[0]+d*l,b[1]+d*m,f],[b[0]+c*j,b[1]+c*k,e],g)},pyramid:function(a,b,c,d,e,f){b=b[0];for(var g=0,h=b.length-1;h>g;g++)this.addTriangle(a,[b[g][0],b[g][1],d],[b[g+1][0],b[g+1][1],d],[c[0],c[1],e],f)},_dome:function(){this.LAT_SEGMENTS/2},_sphere:function(a,b,c,d,e,f){for(var g,h,i,j=this.LAT_SEGMENTS,k=0;j>k;k++)g=k*Math.PI/j,h=Math.sin(g),i=Math.cos(g),J.cylinder(a,b,radiusBottom,radiusTop,d,e,f)},Pyramid:function(){},extrusion:function(a,b,c,d,e){for(var f,g,h,i,j,k,l=0,m=b.length;m>l;l++){f=b[l],g=f.length-1,(f[0][0]!==f[g][0]||f[0][1]!==f[g][1])&&(f.push(f[0]),g++);for(var n=0;g>n;n++)h=f[n],i=f[n+1],j=c,k=d,this.quad(a,[h[0],h[1],j],[i[0],i[1],j],[h[0],h[1],k],[i[0],i[1],k],e)}},addTriangle:function(a,b,c,d,e){a.vertices.push(b[0],b[1],b[2],d[0],d[1],d[2],c[0],c[1],c[2]);var f=this.computeNormal(b[0],b[1],b[2],c[0],c[1],c[2],d[0],d[1],d[2]);a.normals.push(f[0],f[1],f[2],f[0],f[1],f[2],f[0],f[1],f[2]),a.colors.push(e.r,e.g,e.b,e.r,e.g,e.b,e.r,e.g,e.b)},computeNormal:function(a,b,c,d,e,f,g,h,i){var j=a-d,k=b-e,l=c-f,m=d-g,n=e-h,o=f-i,p=k*o-l*n,r=l*m-j*o,s=j*n-k*m;return q(p,r,s)}},K={};!function(){function a(a){var c=K.fixedZoom||Math.round(v.zoom),d=v.bounds,g=B<<c,h=e(d.n,d.w,g),i=e(d.s,d.e,g);return K.bounds={zoom:c,minX:h.x/B<<0,minY:h.y/B<<0,maxX:Math.ceil(i.x/B),maxY:Math.ceil(i.y/B)},a?void(f||(f=setTimeout(function(){f=null,b()},a))):void b()}function b(){var a,b,e,f,g=[],i=K.bounds;for(b=i.minY;b<=i.maxY;b++)for(a=i.minX;a<=i.maxX;a++)f=[a,b,i.zoom].join(","),h[f]||g.push({tileX:a,tileY:b,zoom:i.zoom,key:f});if(e=g.length){var j={x:i.minX+(i.maxX-i.minX-1)/2,y:i.minY+(i.maxY-i.minY-1)/2};g.sort(function(a,b){return m(b,j)-m(a,j)});for(var k,l,n=0;e>n;n++)l=g[n],N.add(k=new L(l.tileX,l.tileY,l.zoom)),k.load(d(l.tileX,l.tileY,l.zoom)),h[l.key]=k;c()}}function c(){for(var a in h)h[a].isVisible(1)||(N.remove(h[a]),delete h[a])}function d(a,b,c){var d="abcd"[(a+b)%4];return g(K.src,{s:d,x:a,y:b,z:c})}var f,h={};K.onMapChange=function(){this.src&&a(100)},K.onMapResize=function(){this.src&&a()},K.destroy=function(){clearTimeout(f)}}();var L=function(a,b,c){this.x=a*B,this.y=b*B,this.zoom=c};!function(){function a(a,b){var c=y.createBuffer();return c.itemSize=a,c.numItems=b.length/a,y.bindBuffer(y.ARRAY_BUFFER,c),y.bufferData(y.ARRAY_BUFFER,b,y.STATIC_DRAW),c}L.prototype.load=function(a){this.request=H.loadJSON(a,this.onLoad.bind(this))},L.prototype.onLoad=function(b){this.request=null;var c=P.read(this.x,this.y,this.zoom,b);this.vertexBuffer=a(3,new Float32Array(c.vertices)),this.normalBuffer=a(3,new Float32Array(c.normals)),this.colorBuffer=a(3,new Uint8Array(c.colors)),c=null,b=null,this.isReady=!0},L.prototype.isVisible=function(a){if(!this.isReady)return!1;a=a||0;var b=K.bounds,c=this.x/B,d=this.y/B;return this.zoom===b.zoom&&c>=b.minX-a&&c<=b.maxX+a&&d>=b.minY-a&&d<=b.maxY+a},L.prototype.render=function(a,b){if(this.isVisible()){var c=1/Math.pow(2,this.zoom-v.zoom),d=v.size,e=v.origin,f=R.create();f=R.scale(f,c,c,.65*c),f=R.translate(f,this.x*c-e.x,this.y*c-e.y,0),f=R.rotateZ(f,v.rotation),f=R.rotateX(f,v.tilt),f=R.translate(f,d.width/2,d.height/2,0),f=R.multiply(f,b),y.uniformMatrix4fv(a.uniforms.uMatrix,!1,new Float32Array(f)),y.bindBuffer(y.ARRAY_BUFFER,this.vertexBuffer),y.vertexAttribPointer(a.attributes.aPosition,this.vertexBuffer.itemSize,y.FLOAT,!1,0,0),y.bindBuffer(y.ARRAY_BUFFER,this.normalBuffer),y.vertexAttribPointer(a.attributes.aNormal,this.normalBuffer.itemSize,y.FLOAT,!1,0,0),y.bindBuffer(y.ARRAY_BUFFER,this.colorBuffer),y.vertexAttribPointer(a.attributes.aColor,this.colorBuffer.itemSize,y.UNSIGNED_BYTE,!0,0,0),y.drawArrays(y.TRIANGLES,0,this.vertexBuffer.numItems)}},L.prototype.destroy=function(){y.deleteBuffer(this.vertexBuffer),y.deleteBuffer(this.normalBuffer),y.deleteBuffer(this.colorBuffer),this.request&&this.request.abort()}}(),t.TileLayer=k,k.prototype={_updateTileBounds:function(){var a=this._map.getBounds(),b=this._tileSize,c=this._zoom=Math.round(this._map.getZoom()),d=b<<c,f=e(a.n,a.w,d),g=e(a.s,a.e,d);this._tileBounds={minX:f.x/b<<0,minY:f.y/b<<0,maxX:Math.ceil(g.x/b),maxY:Math.ceil(g.y/b)}},_loadTiles:function(){var a,b,c,d,e=this._tileBounds,f=this._zoom,g=this._tiles,h=[],i=[e.minX+(e.maxX-e.minX-1)/2,e.maxY];for(b=e.minY;b<e.maxY;b++)for(a=e.minX;a<e.maxX;a++)c=[a,b,f].join(","),g[c]||(g[c]=new l(a,b,f),h.push({tile:g[c],dist:m([a,b],i)}));if(d=h.length){h.sort(function(a,b){return a.dist-b.dist});for(var j=0;d>j;j++)h[j].tile.load(this._getURL(h[j].tile.tileX,h[j].tile.tileY,h[j].tile.zoom));this._purge()}},_getURL:function(a,b,c){var d="abcd"[(a+b)%4];return g(this._url,{s:d,x:a,y:b,z:c})},_purge:function(){this._tiles},addTo:function(a){this._map=a,a.addLayer(this),this._updateTileBounds(),this.update(),a.on("change",function(){this._updateTileBounds(),this.update(100)}.bind(this)),a.on("resize",function(){this._updateTileBounds(),this.update()}.bind(this))},remove:function(){this._map.remove(this),this._map=null},update:function(a){return a?void(this._isWaiting||(this._isWaiting=setTimeout(function(){this._isWaiting=null,this._loadTiles()}.bind(this),a))):void this._loadTiles()},render:function(a){var b=this._shader.use(),c=this._tiles;for(var d in c)c[d].isVisible()&&c[d].render(b,a,this._map);b.end()},destroy:function(){clearTimeout(this._isWaiting);for(var a in this._tiles)this._tiles[a].destroy();this._tiles=null}};var M={};M.createTexture=function(a){var b=y.createTexture();return y.bindTexture(y.TEXTURE_2D,b),y.pixelStorei(y.UNPACK_FLIP_Y_WEBGL,!0),y.texImage2D(y.TEXTURE_2D,0,y.RGBA,y.RGBA,y.UNSIGNED_BYTE,a),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,y.LINEAR),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,y.LINEAR_MIPMAP_LINEAR),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,y.CLAMP_TO_EDGE),y.generateMipmap(y.TEXTURE_2D),b},M.createBuffer=function(a,b){var c=y.createBuffer();return c.itemSize=a,c.numItems=b.length/a,y.bindBuffer(y.ARRAY_BUFFER,c),y.bufferData(y.ARRAY_BUFFER,b,y.STATIC_DRAW),b=null,c},l.prototype={load:function(a){var b=this._image=new Image;b.crossOrigin="*",b.onload=this.onLoad.bind(this),b.src=a},onLoad:function(){this._texture=M.createTexture(this._image),this.isReady=!0},render:function(a,b,c){if(this.isVisible()){var d=1/Math.pow(2,this.zoom-c.getZoom()),e=B*d,f=c.getSize(),g=c.getOrigin(),h=R.create();h=R.scale(h,1.005*d,1.005*d,1),h=R.translate(h,this.tileX*e-g.x,this.tileY*e-g.tileY,0),h=R.rotateZ(h,c.getRotation()),h=R.rotateX(h,c.getTilt()),h=R.translate(h,f.width/2,f.height/2,0),h=R.multiply(h,b),y.uniformMatrix4fv(a.uniforms.uMatrix,!1,new Float32Array(h)),y.bindBuffer(y.ARRAY_BUFFER,this._vertexBuffer),y.vertexAttribPointer(a.attributes.aPosition,this._vertexBuffer.itemSize,y.FLOAT,!1,0,0),y.bindBuffer(y.ARRAY_BUFFER,this._texCoordBuffer),y.vertexAttribPointer(a.attributes.aTexCoord,this._texCoordBuffer.itemSize,y.FLOAT,!1,0,0),y.activeTexture(y.TEXTURE0),y.bindTexture(y.TEXTURE_2D,this._texture),y.uniform1i(a.uniforms.uTileImage,0),y.drawArrays(y.TRIANGLE_STRIP,0,this._vertexBuffer.numItems)}},isVisible:function(a){return this.isReady?!0:!1},getMatrix:function(){},destroy:function(){y.deleteBuffer(this._vertexBuffer),y.deleteBuffer(this._texCoordBuffer),this._image.src="",this._texture&&y.deleteTexture(this._texture)}};var N={items:[],add:function(a){this.items.push(a)},remove:function(a){for(var b=this.items,c=0,d=b.length;d>c;c++)if(b[c]===a)return b[c].destroy(),void b.splice(c,1)}},O=function(a){this.zoom=16,"object"==typeof a&&this.onLoad(a)};!function(){function a(a,b){var c=y.createBuffer();return c.itemSize=a,c.numItems=b.length/a,y.bindBuffer(y.ARRAY_BUFFER,c),y.bufferData(y.ARRAY_BUFFER,b,y.STATIC_DRAW),c}O.prototype.load=function(a){this.request=H.loadJSON(a,this.onLoad.bind(this))},O.prototype.onLoad=function(b){this.request=null;var c=B*Math.pow(2,this.zoom),d=e(b.offset.latitude,b.offset.longitude,c);this.x=d.x,this.y=d.y;var f=Q.read(this.x,this.y,this.zoom,b);this.vertexBuffer=a(3,new Float32Array(f.vertices)),this.normalBuffer=a(3,new Float32Array(f.normals)),this.colorBuffer=a(3,new Uint8Array(f.colors)),f=null,b=null,this.isReady=!0},O.prototype.render=function(a,b){if(this.isVisible()){var c=1/Math.pow(2,this.zoom-v.zoom),d=v.size,e=v.origin,f=R.create();f=R.scale(f,c,c,.65*c),f=R.translate(f,this.x*c-e.x,this.y*c-e.y,0),f=R.rotateZ(f,v.rotation),f=R.rotateX(f,v.tilt),f=R.translate(f,d.width/2,d.height/2,0),f=R.multiply(f,b),y.uniformMatrix4fv(a.uniforms.uMatrix,!1,new Float32Array(f)),y.bindBuffer(y.ARRAY_BUFFER,this.vertexBuffer),y.vertexAttribPointer(a.attributes.aPosition,this.vertexBuffer.itemSize,y.FLOAT,!1,0,0),y.bindBuffer(y.ARRAY_BUFFER,this.normalBuffer),y.vertexAttribPointer(a.attributes.aNormal,this.normalBuffer.itemSize,y.FLOAT,!1,0,0),y.bindBuffer(y.ARRAY_BUFFER,this.colorBuffer),y.vertexAttribPointer(a.attributes.aColor,this.colorBuffer.itemSize,y.UNSIGNED_BYTE,!0,0,0),y.drawArrays(y.TRIANGLES,0,this.vertexBuffer.numItems)}},O.prototype.isVisible=function(a,b){return this.isReady?(b=b||0,!0):!1},O.prototype.destroy=function(){y.deleteBuffer(this.vertexBuffer),y.deleteBuffer(this.normalBuffer),y.deleteBuffer(this.colorBuffer),this.request&&this.request.abort()}}();var P={};!function(){function a(a){return a=a.toLowerCase(),"#"===a[0]?a:g[h[a]||a]||null}function b(b){var c,d={};b=b||{},d.height=b.height||(b.levels?b.levels*f:E),d.minHeight=b.minHeight||(b.minLevel?b.minLevel*f:0);var e=b.material?a(b.material):b.wallColor||b.color;d.wallColor=(c=s.parse(e))?c.toRGBA():F;var g=b.roofMaterial?a(b.roofMaterial):b.roofColor;switch(d.roofColor=(c=s.parse(g))?c.toRGBA():F,b.shape){case"cylinder":case"cone":case"dome":case"sphere":d.shape=b.shape,d.isRotational=!0;break;case"pyramid":d.shape=b.shape}switch(b.roofShape){case"cone":case"dome":d.roofShape=b.roofShape,d.isRotational=!0;break;case"pyramid":d.roofShape=b.roofShape}return d.roofShape&&b.roofHeight?(d.roofHeight=b.roofHeight,d.height=Math.max(0,d.height-d.roofHeight)):d.roofHeight=0,d.height+d.roofHeight<=d.minHeight?void 0:(b.relationId&&(d.relationId=b.relationId),d)}function c(a){var b,d,e,f=[];switch(a.type){case"GeometryCollection":for(d=0,e=a.geometries.length;e>d;d++)(b=c(a.geometries[d]))&&f.push.apply(f,b);return f;case"MultiPolygon":for(d=0,e=a.coordinates.length;e>d;d++)(b=c({type:"Polygon",coordinates:a.coordinates[d]}))&&f.push.apply(f,b);return f;case"Polygon":return[a.coordinates];default:return[]}}function d(a,b,c,d){for(var f,g,h,i,j=B*Math.pow(2,c),k=[],l=0,m=d.length;m>l;l++)for(i=d[l],k[l]=[],f=0,g=i.length-1;g>f;f++)h=e(i[f][1],i[f][0],j),k[l][f]=[h.x-a,h.y-b];
return k}var f=3,g={brick:"#cc7755",bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",glass:"#e8f8f8",gold:"#ffcc00",plants:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},h={asphalt:"tar_paper",bitumen:"tar_paper",block:"stone",bricks:"brick",glas:"glass",glassfront:"glass",grass:"plants",masonry:"stone",granite:"stone",panels:"panel",paving_stones:"stone",plastered:"plaster",rooftiles:"roof_tiles",roofingfelt:"tar_paper",sandstone:"stone",sheet:"canvas",sheets:"canvas",shingle:"tar_paper",shingles:"tar_paper",slates:"slate",steel:"metal",tar:"tar_paper",tent:"canvas",thatch:"plants",tile:"roof_tiles",tiles:"roof_tiles"};P.read=function(a,e,f,g){if(!g||"FeatureCollection"!==g.type)return[];for(var h,i,j,k,l,m,p,q,r,s=g.features,t={vertices:[],normals:[],colors:[]},u=0,v=s.length;v>u;u++)if(h=s[u],l=b(h.properties))for(i=c(h.geometry),j=0,k=i.length;k>j;j++){switch(m=d(a,e,f,i[j]),"cone"!==l.roofShape&&"dome"!==l.roofShape||l.shape||!n(m)||(l.shape="cylinder",l.isRotational=!0),p=o(m),r=[p.minX+(p.maxX-p.minX)/2,p.minY+(p.maxY-p.minY)/2],l.isRotational&&(q=(p.maxX-p.minX)/2),l.shape){case"cylinder":J.cylinder(t,r,q,q,l.minHeight,l.height,l.wallColor),J.circle(t,r,q,l.height,l.roofColor);break;case"cone":J.cylinder(t,r,q,0,l.minHeight,l.height,l.wallColor);break;case"sphere":J.cylinder(t,r,q,q/2,l.minHeight,l.height,l.wallColor),J.circle(t,r,q/2,l.height,l.roofColor);break;case"pyramid":J.pyramid(t,m,r,l.minHeight,l.height,l.wallColor);break;default:J.extrusion(t,m,l.minHeight,l.height,l.wallColor),J.polygon(t,m,l.height,l.roofColor)}switch(l.roofShape){case"cone":J.cylinder(t,r,q,0,l.height,l.height+l.roofHeight,l.roofColor);break;case"dome":J.cylinder(t,r,q,q/2,l.height,l.height+l.roofHeight,l.roofColor),J.circle(t,r,q/2,l.height+l.roofHeight,l.roofColor);break;case"pyramid":J.pyramid(t,m,r,l.height,l.height+l.roofHeight,l.roofColor)}}return t}}();var Q={};!function(){function a(a,b,c,d){for(var f,g=B*Math.pow(2,c),h=[],i=0,j=d.length-2;j>i;i+=3)f=e(d[i+1],d[i],g),h[i/3]=[f.x-a,f.y-b,d[i+2]];return h}Q.read=function(b,c,d,e){for(var f,g,h,i,j,k=e.meshes,l={vertices:[],normals:[],colors:[]},m=0,n=k.length;n>m;m++){for(f=k[m],g={r:f.wallColor[0],g:f.wallColor[1],b:f.wallColor[2]},h=0,i=f.walls.length;i>h;h++)j=a(b,c,d,f.walls[h]),J.polygon3d(l,[j],g);for(g={r:f.roofColor[0],g:f.roofColor[1],b:f.roofColor[2]},h=0,i=f.roofs.length;i>h;h++)j=a(b,c,d,f.roofs[h]),J.polygon3d(l,[j],g)}return l}}();var R={create:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},multiply:function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=b[0],t=b[1],u=b[2],v=b[3],w=b[4],x=b[5],y=b[6],z=b[7],A=b[8],B=b[9],C=b[10],D=b[11],E=b[12],F=b[13],G=b[14],H=b[15];return[c*s+d*w+e*A+f*E,c*t+d*x+e*B+f*F,c*u+d*y+e*C+f*G,c*v+d*z+e*D+f*H,g*s+h*w+i*A+j*E,g*t+h*x+i*B+j*F,g*u+h*y+i*C+j*G,g*v+h*z+i*D+j*H,k*s+l*w+m*A+n*E,k*t+l*x+m*B+n*F,k*u+l*y+m*C+n*G,k*v+l*z+m*D+n*H,o*s+p*w+q*A+r*E,o*t+p*x+q*B+r*F,o*u+p*y+q*C+r*G,o*v+p*z+q*D+r*H]},perspective:function(a,b,c,d){return[2/b,0,0,0,0,-2/c,0,0,0,40/d,-2/d,a*(-2/d),-1,1,0,1]},ortho:function(a,b,c){return this.perspective(1,a,b,c)},translate:function(a,b,c,d){return this.multiply(a,[1,0,0,0,0,1,0,0,0,0,1,0,b,c,d,1])},rotateX:function(a,b){var c=p(b),d=Math.cos(c),e=Math.sin(c);return this.multiply(a,[1,0,0,0,0,d,e,0,0,-e,d,0,0,0,0,1])},rotateY:function(a,b){var c=p(b),d=Math.cos(c),e=Math.sin(c);return this.multiply(a,[d,0,-e,0,0,1,0,0,e,0,d,0,0,0,0,1])},rotateZ:function(a,b){var c=p(b),d=Math.cos(c),e=Math.sin(c);return this.multiply(a,[d,-e,0,0,e,d,0,0,0,0,1,0,0,0,0,1])},scale:function(a,b,c,d){return this.multiply(a,[b,0,0,0,0,c,0,0,0,0,d,0,0,0,0,1])},invert:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15],r=b*g-c*f,s=b*h-d*f,t=b*i-e*f,u=c*h-d*g,v=c*i-e*g,w=d*i-e*h,x=j*o-k*n,y=j*p-l*n,z=j*q-m*n,A=k*p-l*o,B=k*q-m*o,C=l*q-m*p,D=r*C-s*B+t*A+u*z-v*y+w*x;return D?(D=1/D,[(g*C-h*B+i*A)*D,(d*B-c*C-e*A)*D,(o*w-p*v+q*u)*D,(l*v-k*w-m*u)*D,(h*z-f*C-i*y)*D,(b*C-d*z+e*y)*D,(p*t-n*w-q*s)*D,(j*w-l*t+m*s)*D,(f*B-g*z+i*x)*D,(c*z-b*B-e*x)*D,(n*v-o*t+q*r)*D,(k*t-j*v-m*r)*D,(g*y-f*A-h*x)*D,(b*A-c*y+d*x)*D,(o*s-n*u-p*r)*D,(j*u-k*s+l*r)*D]):null},invert3:function(a){var b=a[0],c=a[1],d=a[2],e=a[4],f=a[5],g=a[6],h=a[8],i=a[9],j=a[10],k=j*f-g*i,l=-j*e+g*h,m=i*e-f*h,n=b*k+c*l+d*m;return n?(n=1/n,[k*n,(-j*c+d*i)*n,(g*c-d*f)*n,l*n,(j*b-d*h)*n,(-g*b+d*e)*n,m*n,(-i*b+c*h)*n,(f*b-c*e)*n]):null},transpose:function(a){return[a[0],a[3],a[6],a[1],a[4],a[7],a[2],a[5],a[8]]}},S=function(a){y=a,this.shaderPrograms["default"]=new T("default"),this.onMapResize()};S.prototype={projections:{},shaderPrograms:{},clear:function(){y.clear(y.COLOR_BUFFER_BIT|y.DEPTH_BUFFER_BIT)},render:function(){var a,b,c;if(!(v.zoom<A)){y.disable(y.CULL_FACE),y.enable(y.DEPTH_TEST),y.cullFace(y.BACK),a=this.shaderPrograms["default"].use(),y.uniform3fv(a.uniforms.uLightColor,[.5,.5,.5]),y.uniform3fv(a.uniforms.uLightDirection,q(1,1,1)),y.uniform1f(a.uniforms.uAlpha,d(v.zoom,G.zoomAlpha,"zoom","alpha"));var e=R.invert3(R.create());y.uniformMatrix3fv(a.uniforms.uNormalTransform,!1,new Float32Array(R.transpose(e)));var f=N.items;for(b=0,c=f.length;c>b;b++)f[b].render(a,this.projections.perspective);a.end()}},onMapResize:function(){var a=v.size;y.viewport(0,0,a.width,a.height),this.projections.perspective=R.perspective(20,a.width,a.height,4e4),this.projections.ortho=R.ortho(a.width,a.height,4e4)}};var T=function(a){var b=I[a];if(this.id=y.createProgram(),this.name=a,!b.src)throw new Error('missing source for shader "'+a+'"');if(this._attach(y.VERTEX_SHADER,b.src.vertex),this._attach(y.FRAGMENT_SHADER,b.src.fragment),y.linkProgram(this.id),!y.getProgramParameter(this.id,y.LINK_STATUS))throw new Error(y.getProgramParameter(this.id,y.VALIDATE_STATUS)+"\n"+y.getError());this.attributeNames=b.attributes,this.uniformNames=b.uniforms};T.prototype={_attach:function(a,b){var c=y.createShader(a);if(y.shaderSource(c,b),y.compileShader(c),!y.getShaderParameter(c,y.COMPILE_STATUS))throw new Error(y.getShaderInfoLog(c));y.attachShader(this.id,c)},use:function(){y.useProgram(this.id);var a,b,c;if(this.attributeNames)for(this.attributes={},a=0;a<this.attributeNames.length;a++)b=this.attributeNames[a],c=y.getAttribLocation(this.id,b),0>c?console.error('could not locate attribute "'+b+'" in shader "'+this.name+'"'):(y.enableVertexAttribArray(c),this.attributes[b]=c);if(this.uniformNames)for(this.uniforms={},a=0;a<this.uniformNames.length;a++)b=this.uniformNames[a],c=y.getUniformLocation(this.id,b),0>c?console.error('could not locate uniform "'+b+'" in shader "'+this.name+'"'):this.uniforms[b]=c;return this},end:function(){if(y.useProgram(null),this.attributes)for(var a in this.attributes)y.disableVertexAttribArray(this.attributes[a]);this.attributes=null,this.uniforms=null}};var U=function(a,b,c){if(c=c||{},this.width=a,this.height=b,this.texture=new V(a,b,c.texture),this.id=y.createFramebuffer(),y.bindFramebuffer(y.FRAMEBUFFER,this.id),y.framebufferTexture2D(y.FRAMEBUFFER,y.COLOR_ATTACHMENT0,y.TEXTURE_2D,this.texture.id,0),this.renderbuffer=y.createRenderbuffer(),y.bindRenderbuffer(y.RENDERBUFFER,this.renderbuffer),this.renderbuffer.width=this.width,this.renderbuffer.height=this.height,y.renderbufferStorage(y.RENDERBUFFER,y.DEPTH_COMPONENT16,this.width,this.height),y.framebufferRenderbuffer(y.FRAMEBUFFER,y.DEPTH_ATTACHMENT,y.RENDERBUFFER,this.renderbuffer),y.checkFramebufferStatus(y.FRAMEBUFFER)!==y.FRAMEBUFFER_COMPLETE)throw new Error("This combination of framebuffer attachments does not work");y.bindRenderbuffer(y.RENDERBUFFER,null),y.bindFramebuffer(y.FRAMEBUFFER,null),this.texture.end()};U.prototype={use:function(){return this.viewport=y.getParameter(y.VIEWPORT),y.bindFramebuffer(y.FRAMEBUFFER,this.id),y.bindRenderbuffer(y.RENDERBUFFER,this.renderbuffer),y.viewport(0,0,this.width,this.height),this},end:function(){y.bindFramebuffer(y.FRAMEBUFFER,null),y.bindRenderbuffer(y.RENDERBUFFER,null),y.viewport(this.viewport[0],this.viewport[1],this.viewport[2],this.viewport[3])}};var V=function(a,b,c){c=c||{},this.id=y.createTexture(),this.width=a,this.height=b,this.format=c.format||y.RGBA,this.type=c.type||y.UNSIGNED_BYTE;var d=c.filter||c.magFilter||y.LINEAR,e=c.filter||c.minFilter||y.LINEAR;y.bindTexture(y.TEXTURE_2D,this.id),y.pixelStorei(y.UNPACK_FLIP_Y_WEBGL,1),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,d),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,e),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,c.wrap||c.wrapS||y.CLAMP_TO_EDGE),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,c.wrap||c.wrapT||y.CLAMP_TO_EDGE),y.texImage2D(y.TEXTURE_2D,0,this.format,a,b,0,this.format,this.type,null)};return V.prototype={use:function(a){return y.activeTexture(y.TEXTURE0+(a||0)),y.bindTexture(y.TEXTURE_2D,this.id),this},end:function(a){y.activeTexture(y.TEXTURE0+(a||0)),y.bindTexture(y.TEXTURE_2D,null)}},x}(this);