!function(a){function b(a,b,c){a.addEventListener(b,c,!1)}function c(a){a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),a.returnValue=!1}function d(a,b,c){return Math.min(c,Math.max(a,b))}function e(a,b,c){var e=c-b;return d((a-b)/e,0,1)}function f(a,b,c){var d=new glx.Matrix(glx.Matrix.multiply(v.transform,W.perspective)),e=1/Math.pow(2,16-v.zoom),f=(new glx.Matrix).translate(0,0,c).scale(e,e,e*E).translate(a,b,0),g=glx.Matrix.multiply(f,d),h=glx.Matrix.transform(g);return{x:h.x*s,y:t-h.y*t,z:h.z}}function g(a,b,c){var d=b/360+.5,e=Math.min(1,Math.max(0,.5-Math.log(Math.tan(Math.PI/4+Math.PI/2*a/180))/Math.PI/2));return{x:d*c,y:e*c}}function h(a,b,c){return a/=c,b/=c,{latitude:(2*Math.atan(Math.exp(Math.PI*(1-2*b)))-Math.PI/2)*(180/Math.PI),longitude:360*a-180}}function i(a,b){return a.replace(/\{(\w+)\}/g,function(a,c){return b[c]||a})}function j(a,b,c,d,e){d=d||1e3,e=e||1;var f=b+Math.min(c-b,d);b!==f&&(a(b,f),c>b&&setTimeout(function(){j(a,f,c,d,e)},e))}function k(a,b){var c=a[0]-b[0],d=a[1]-b[1];return c*c+d*d}function l(a){for(var b=a[0],c=1/0,d=-(1/0),e=1/0,f=-(1/0),g=0;g<b.length;g++)c=Math.min(c,b[g][0]),d=Math.max(d,b[g][0]),e=Math.min(e,b[g][1]),f=Math.max(f,b[g][1]);return{minX:c,maxX:d,minY:e,maxY:f}}function m(a,b,c,d,e,f,g,h,i){var j=a-d,k=b-e,l=c-f,m=d-g,o=e-h,p=f-i,q=k*p-l*o,r=l*m-j*p,s=j*o-k*m;return n(q,r,s)}function n(a,b,c){var d=Math.sqrt(a*a+b*b+c*c);return 0===d&&(d=1e-5),[a/d,b/d,c/d]}function o(a,b,c){return{x:Math.cos(c)*a-Math.sin(c)*b,y:Math.sin(c)*a+Math.cos(c)*b}}var p,q=function(){"use strict";function a(a,e){var f=c(b(a[0],!0)),g=e?{vertices:[],indices:[]}:[];if(!f)return g;var h,j,k,l,m,n,o,p,q,r=80;for(q=0;r>=0&&q<a.length;q++)r-=a[q].length;if(0>r){h=f.next,j=l=h.p[0],k=m=h.p[1];do n=h.p[0],o=h.p[1],j>n&&(j=n),k>o&&(k=o),n>l&&(l=n),o>m&&(m=o),h=h.next;while(h!==f);p=Math.max(l-j,m-k)}return a.length>1&&(f=i(a,f)),d(f,g,j,k,p),g}function b(a,b){var c,d,e,f,g,h=0,i=a.length;for(c=0,d=i-1;i>c;d=c++)e=a[c],f=a[d],h+=(f[0]-e[0])*(e[1]+f[1]);if(b===h>0)for(c=0;i>c;c++)g=y(a[c],g);else for(c=i-1;c>=0;c--)g=y(a[c],g);return g}function c(a,b){b||(b=a);var c,d=a;do if(c=!1,r(d.p,d.next.p)||0===q(d.prev.p,d.p,d.next.p)){if(d.prev.next=d.next,d.next.prev=d.prev,d.prevZ&&(d.prevZ.nextZ=d.nextZ),d.nextZ&&(d.nextZ.prevZ=d.prevZ),d=b=d.prev,d===d.next)return null;c=!0}else d=d.next;while(c||d!==b);return b}function d(a,b,i,j,k,m){if(a){var n=void 0!==b.vertices;m||void 0===i||l(a,i,j,k);for(var o,p,q=a;a.prev!==a.next;)if(o=a.prev,p=a.next,f(a,i,j,k))n?(e(b,o),e(b,a),e(b,p)):(b.push(o.p),b.push(a.p),b.push(p.p)),p.prev=o,o.next=p,a.prevZ&&(a.prevZ.nextZ=a.nextZ),a.nextZ&&(a.nextZ.prevZ=a.prevZ),a=p.next,q=p.next;else if(a=p,a===q){m?1===m?(a=g(a,b),d(a,b,i,j,k,2)):2===m&&h(a,b,i,j,k):d(c(a),b,i,j,k,1);break}}}function e(a,b){b.source&&(b=b.source);var c=b.index;if(null===c){var d=b.p.length,e=a.vertices;b.index=c=e.length/d;for(var f=0;d>f;f++)e.push(b.p[f])}a.indices.push(c)}function f(a,b,c,d){var e=a.prev.p,f=a.p,g=a.next.p,h=e[0],i=f[0],j=g[0],k=e[1],l=f[1],m=g[1],o=h*l-k*i,p=h*m-k*j,q=j*l-m*i,r=o-p-q;if(0>=r)return!1;var s,t,u,v,w,x,y,z=m-k,A=h-j,B=k-l,C=i-h;if(void 0!==b){var D=i>h?j>h?h:j:j>i?i:j,E=l>k?m>k?k:m:m>l?l:m,F=h>i?h>j?h:j:i>j?i:j,G=k>l?k>m?k:m:l>m?l:m,H=n(D,E,b,c,d),I=n(F,G,b,c,d);for(y=a.nextZ;y&&y.z<=I;)if(s=y.p,y=y.nextZ,s!==e&&s!==g&&(t=s[0],u=s[1],v=z*t+A*u-p,v>=0&&(w=B*t+C*u+o,w>=0&&(x=r-v-w,x>=0&&(v&&w||v&&x||w&&x)))))return!1;for(y=a.prevZ;y&&y.z>=H;)if(s=y.p,y=y.prevZ,s!==e&&s!==g&&(t=s[0],u=s[1],v=z*t+A*u-p,v>=0&&(w=B*t+C*u+o,w>=0&&(x=r-v-w,x>=0&&(v&&w||v&&x||w&&x)))))return!1}else for(y=a.next.next;y!==a.prev;)if(s=y.p,y=y.next,t=s[0],u=s[1],v=z*t+A*u-p,v>=0&&(w=B*t+C*u+o,w>=0&&(x=r-v-w,x>=0&&(v&&w||v&&x||w&&x))))return!1;return!0}function g(a,b){var c=!!b.vertices,d=a;do{var f=d.prev,g=d.next.next;if(s(f.p,d.p,d.next.p,g.p)&&u(f,g)&&u(g,f)){c?(e(b,f),e(b,d),e(b,g)):(b.push(f.p),b.push(d.p),b.push(g.p)),f.next=g,g.prev=f;var h=d.prevZ,i=d.nextZ&&d.nextZ.nextZ;h&&(h.nextZ=i),i&&(i.prevZ=h),d=a=g}d=d.next}while(d!==a);return d}function h(a,b,e,f,g){var h=a;do{for(var i=h.next.next;i!==h.prev;){if(p(h,i)){var j=x(h,i);return h=c(h,h.next),j=c(j,j.next),d(h,b,e,f,g),void d(j,b,e,f,g)}i=i.next}h=h.next}while(h!==a)}function i(a,d){for(var e=a.length,f=[],g=1;e>g;g++){var h=c(b(a[g],!1));h&&f.push(o(h))}for(f.sort(w),g=0;g<f.length;g++)j(f[g],d),d=c(d,d.next);return d}function j(a,b){if(b=k(a,b)){var d=x(b,a);c(d,d.next)}}function k(a,b){var c,d,e,f=b,g=a.p,h=g[0],i=g[1],j=-(1/0);do{if(d=f.p,e=f.next.p,i<=d[1]&&i>=e[1]){var k=d[0]+(i-d[1])*(e[0]-d[0])/(e[1]-d[1]);h>=k&&k>j&&(j=k,c=d[0]<e[0]?f:f.next)}f=f.next}while(f!==b);if(!c)return null;var l,m,n,o,p,q,r=c.p[0],s=c.p[1],t=h*s-i*r,v=h*i-i*j,w=i-i,x=h-j,y=i-s,z=r-h,A=t-v-(j*s-i*r),B=0>=A?-1:1,C=c,D=1/0;for(f=c.next;f!==C;)l=f.p[0],m=f.p[1],n=h-l,n>=0&&l>=r&&(o=(w*l+x*m-v)*B,o>=0&&(p=(y*l+z*m+t)*B,p>=0&&A*B-o-p>=0&&(q=Math.abs(i-m)/n,D>q&&u(f,a)&&(c=f,D=q)))),f=f.next;return c}function l(a,b,c,d){var e=a;do null===e.z&&(e.z=n(e.p[0],e.p[1],b,c,d)),e.prevZ=e.prev,e.nextZ=e.next,e=e.next;while(e!==a);e.prevZ.nextZ=null,e.prevZ=null,m(e)}function m(a){for(var b,c,d,e,f,g,h,i,j=1;;){for(c=a,a=null,f=null,g=0;c;){for(g++,d=c,h=0,b=0;j>b&&(h++,d=d.nextZ,d);b++);for(i=j;h>0||i>0&&d;)0===h?(e=d,d=d.nextZ,i--):0!==i&&d?c.z<=d.z?(e=c,c=c.nextZ,h--):(e=d,d=d.nextZ,i--):(e=c,c=c.nextZ,h--),f?f.nextZ=e:a=e,e.prevZ=f,f=e;c=d}if(f.nextZ=null,1>=g)return a;j*=2}}function n(a,b,c,d,e){return a=1e3*(a-c)/e,a=16711935&(a|a<<8),a=252645135&(a|a<<4),a=858993459&(a|a<<2),a=1431655765&(a|a<<1),b=1e3*(b-d)/e,b=16711935&(b|b<<8),b=252645135&(b|b<<4),b=858993459&(b|b<<2),b=1431655765&(b|b<<1),a|b<<1}function o(a){var b=a,c=a;do b.p[0]<c.p[0]&&(c=b),b=b.next;while(b!==a);return c}function p(a,b){return!t(a,a.p,b.p)&&u(a,b)&&u(b,a)&&v(a,a.p,b.p)}function q(a,b,c){var d=(b[1]-a[1])*(c[0]-b[0])-(b[0]-a[0])*(c[1]-b[1]);return d>0?1:0>d?-1:0}function r(a,b){return a[0]===b[0]&&a[1]===b[1]}function s(a,b,c,d){return q(a,b,c)!==q(a,b,d)&&q(c,d,a)!==q(c,d,b)}function t(a,b,c){var d=a;do{var e=d.p,f=d.next.p;if(e!==b&&f!==b&&e!==c&&f!==c&&s(e,f,b,c))return!0;d=d.next}while(d!==a);return!1}function u(a,b){return-1===q(a.prev.p,a.p,a.next.p)?-1!==q(a.p,b.p,a.next.p)&&-1!==q(a.p,a.prev.p,b.p):-1===q(a.p,b.p,a.prev.p)||-1===q(a.p,a.next.p,b.p)}function v(a,b,c){var d=a,e=!1,f=(b[0]+c[0])/2,g=(b[1]+c[1])/2;do{var h=d.p,i=d.next.p;h[1]>g!=i[1]>g&&f<(i[0]-h[0])*(g-h[1])/(i[1]-h[1])+h[0]&&(e=!e),d=d.next}while(d!==a);return e}function w(a,b){return a.p[0]-b.p[0]}function x(a,b){var c=new z(a.p),d=new z(b.p),e=a.next,f=b.prev;return c.source=a,d.source=b,a.next=b,b.prev=a,c.next=e,e.prev=c,d.next=c,c.prev=d,f.next=d,d.prev=f,d}function y(a,b){var c=new z(a);return b?(c.next=b.next,c.prev=b,b.next.prev=c,b.next=c):(c.prev=c,c.next=c),c}function z(a){this.p=a,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.source=null,this.index=null}return a}(),r=function(a){function b(a,b,c){return 0>c&&(c+=1),c>1&&(c-=1),1/6>c?a+6*(b-a)*c:.5>c?b:2/3>c?a+(b-a)*(2/3-c)*6:a}function c(a,b){return Math.min(b,Math.max(0,a))}var d={aqua:"#00ffff",black:"#000000",blue:"#0000ff",fuchsia:"#ff00ff",gray:"#808080",grey:"#808080",green:"#008000",lime:"#00ff00",maroon:"#800000",navy:"#000080",olive:"#808000",orange:"#ffa500",purple:"#800080",red:"#ff0000",silver:"#c0c0c0",teal:"#008080",white:"#ffffff",yellow:"#ffff00"},e=function(a,b,c,d){this.H=a,this.S=b,this.L=c,this.A=d};return e.parse=function(a){var b,c=0,e=0,f=0,g=1;if(a=(""+a).toLowerCase(),a=d[a]||a,b=a.match(/^#(\w{2})(\w{2})(\w{2})$/))c=parseInt(b[1],16),e=parseInt(b[2],16),f=parseInt(b[3],16);else{if(!(b=a.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/)))return;c=parseInt(b[1],10),e=parseInt(b[2],10),f=parseInt(b[3],10),g=b[4]?parseFloat(b[5]):1}return this.fromRGBA(c,e,f,g)},e.fromRGBA=function(a,b,c,d){"object"==typeof a?(b=a.g/255,c=a.b/255,d=void 0!==a.a?a.a:1,a=a.r/255):(a/=255,b/=255,c/=255,d=void 0!==d?d:1);var f,g,h=Math.max(a,b,c),i=Math.min(a,b,c),j=(h+i)/2,k=h-i;if(k){switch(g=j>.5?k/(2-h-i):k/(h+i),h){case a:f=(b-c)/k+(c>b?6:0);break;case b:f=(c-a)/k+2;break;case c:f=(a-b)/k+4}f*=60}else f=g=0;return new e(f,g,j,d)},e.prototype={toRGBA:function(a){var d=c(this.H,360),e=c(this.S,1),f=c(this.L,1),g={a:c(this.A,1)};if(0===e)g.r=f,g.g=f,g.b=f;else{var h=.5>f?f*(1+e):f+e-f*e,i=2*f-h;d/=360,g.r=b(i,h,d+1/3),g.g=b(i,h,d),g.b=b(i,h,d-1/3)}return a?g:{r:Math.round(255*g.r),g:Math.round(255*g.g),b:Math.round(255*g.b),a:g.a}},toString:function(){var a=this.toRGBA();return 1===a.a?"#"+((1<<24)+(a.r<<16)+(a.g<<8)+a.b).toString(16).slice(1,7):"rgba("+[a.r,a.g,a.b,a.a.toFixed(2)].join(",")+")"},hue:function(a){return new e(this.H*a,this.S,this.L,this.A)},saturation:function(a){return new e(this.H,this.S*a,this.L,this.A)},lightness:function(a){return new e(this.H,this.S,this.L*a,this.A)},alpha:function(a){return new e(this.H,this.S,this.L,this.A*a)}},e}(this),s=0,t=0,u=function(a,b){b=b||{};var c=I.getElementById(a);if(c.classList.add("osmb-container"),s=c.offsetWidth,t=c.offsetHeight,p=new glx.View(c,s,t),W.start({fogColor:b.fogColor,showBackfaces:b.showBackfaces}),Y.initShader(),v.init(b),w.init(c),this.setDisabled(b.disabled),b.style&&this.setStyle(b.style),R.setSource(b.tileSource),P.setSource(b.dataSource,b.dataKey||B),null!==b.attribution&&b.attribution!==!1&&""!==b.attribution){var d=I.createElement("DIV");d.className="osmb-attribution",d.innerHTML=b.attribution||u.ATTRIBUTION,c.appendChild(d)}};u.VERSION="0.1.8",u.ATTRIBUTION="Â© OSM Buildings (http://osmbuildings.org)",u.ATTRIBUTION_HTML='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>',u.prototype={setStyle:function(a){var b=a.color||a.wallColor;return b&&(F=r.parse(b).toRGBA(!0)),this},addOBJ:function(a,b,c){return new T.OBJ(a,b,c)},addGeoJSON:function(a,b){return new T.GeoJSON(a,b)},on:function(a,b){return w.on(a,b),this},off:function(a,b){return w.off(a,b),this},setDisabled:function(a){return w.setDisabled(a),this},isDisabled:function(){return w.isDisabled()},setZoom:function(a){return v.setZoom(a),this},getZoom:function(){return v.zoom},setPosition:function(a){return v.setPosition(a),this},getPosition:function(){return v.position},getBounds:function(){var a=v.bounds,b=A*Math.pow(2,v.zoom),c=h(a.minX,a.minY,b),d=h(a.maxX,a.maxY,b);return{n:c.latitude,w:c.longitude,s:d.latitude,e:d.longitude}},setSize:function(a){return(a.width!==s||a.height!==t)&&(p.canvas.width=s=a.width,p.canvas.height=t=a.height,w.emit("resize")),this},getSize:function(){return{width:s,height:t}},setRotation:function(a){return v.setRotation(a),this},getRotation:function(){return v.rotation},setTilt:function(a){return v.setTilt(a),this},getTilt:function(){return v.tilt},transform:function(a,b,c){var d=v.center,e=g(a,b,A*Math.pow(2,v.zoom));return f(e.x-d.x,e.y-d.y,c)},highlight:function(a,b){_.highlightColor=b?a&&r.parse(b).toRGBA(!0):null,_.highlightID=a?Y.idToColor(a):null},destroy:function(){glx.destroy(p),W.destroy(),R.destroy(),P.destroy()}},"function"==typeof a.define?a.define([],u):"object"==typeof a.exports?a.module.exports=u:a.OSMBuildingsGL=u;var v={};!function(){function a(){var a=v.center,b=s/2,c=t/2;v.bounds={maxY:a.y+c,minX:a.x-b,minY:a.y-c,maxX:a.x+b}}v.center={x:0,y:0},v.zoom=0,v.transform=new glx.Matrix,v.init=function(b){this.minZoom=parseFloat(b.minZoom)||10,this.maxZoom=parseFloat(b.maxZoom)||20,this.maxZoom<this.minZoom&&(this.maxZoom=this.minZoom);var c=y.load();this.setPosition(c.position||b.position||{latitude:52.52,longitude:13.41}),this.setZoom(c.zoom||b.zoom||this.minZoom),this.setRotation(c.rotation||b.rotation||0),this.setTilt(c.tilt||b.tilt||0),w.on("resize",a),b.state&&(y.save(v),w.on("change",function(){y.save(v)}))},v.setZoom=function(b,c){if(b=d(parseFloat(b),this.minZoom,this.maxZoom),this.zoom!==b){var e=Math.pow(2,b-this.zoom);if(this.zoom=b,c){var f=s/2-c.clientX,g=t/2-c.clientY;this.center.x-=f,this.center.y-=g,this.center.x*=e,this.center.y*=e,this.center.x+=f,this.center.y+=g}else this.center.x*=e,this.center.y*=e;a(),w.emit("change")}},v.setPosition=function(a){var b=d(parseFloat(a.latitude),-90,90),c=d(parseFloat(a.longitude),-180,180),e=g(b,c,A*Math.pow(2,this.zoom));this.setCenter(e)},v.setCenter=function(b){(this.center.x!==b.x||this.center.y!==b.y)&&(this.center=b,this.position=h(b.x,b.y,A*Math.pow(2,this.zoom)),a(),w.emit("change"))},v.setRotation=function(b){b=parseFloat(b)%360,this.rotation!==b&&(this.rotation=b,a(),w.emit("change"))},v.setTilt=function(b){b=d(parseFloat(b),0,60),this.tilt!==b&&(this.tilt=b,a(),w.emit("change"))},v.destroy=function(){}}();var w={};!function(){function d(a){D||(c(a),v.setZoom(v.zoom+1,a))}function e(a){D||a.button>1||(c(a),A=v.zoom,B=v.rotation,C=v.tilt,y=u=a.clientX,z=x=a.clientY,E=!0,Y.getTargetID(a.clientX,a.clientY,function(b){var c={x:a.clientX,y:a.clientY};b&&(c.target={id:b}),w.emit("pointerdown",c)}))}function f(a){D||(E&&(0!==a.button||a.altKey?n(a):m(a),u=a.clientX,x=a.clientY),Y.getTargetID(a.clientX,a.clientY,function(b){var c={x:a.clientX,y:a.clientY};b&&(c.target={id:b}),w.emit("pointermove",c)}))}function g(a){D||E&&(0!==a.button||a.altKey?n(a):(Math.abs(a.clientX-y)>5||Math.abs(a.clientY-z)>5)&&m(a),E=!1,Y.getTargetID(a.clientX,a.clientY,function(b){var c={x:a.clientX,y:a.clientY};b&&(c.target={id:b}),w.emit("pointerup",c)}))}function h(a){if(!D){c(a);var b=0;a.wheelDeltaY?b=a.wheelDeltaY:a.wheelDelta?b=a.wheelDelta:a.detail&&(b=-a.detail);var d=.2*(b>0?1:0>b?-1:0);v.setZoom(v.zoom+d,a)}}function i(a){if(!D){c(a),A=v.zoom,B=v.rotation,C=v.tilt,a.touches.length>1&&(a=a.touches[0]),y=u=a.clientX,z=x=a.clientY;var b={x:a.clientX,y:a.clientY};targetID&&(b.target={id:targetID}),w.emit("pointerdown",b)}}function j(a){if(!D){a.touches.length>1&&(a=a.touches[0]),m(a),u=a.clientX,x=a.clientY;var b={x:a.clientX,y:a.clientY};targetID&&(b.target={id:targetID}),w.emit("pointermove",b)}}function k(a){if(!D){a.touches.length>1&&(a=a.touches[0]),(Math.abs(a.clientX-y)>5||Math.abs(a.clientY-z)>5)&&m(a);var b={x:a.clientX,y:a.clientY};targetID&&(b.target={id:targetID}),w.emit("pointerup",b)}}function l(a){D||(c(a),v.setZoom(A+(a.scale-1)),v.setRotation(B-a.rotation))}function m(a){var b=a.clientX-u,c=a.clientY-x,d=o(b,c,v.rotation*Math.PI/180);v.setCenter({x:v.center.x-d.x,y:v.center.y-d.y})}function n(a){B+=(a.clientX-u)*(360/innerWidth),C-=(a.clientY-x)*(360/innerHeight),v.setRotation(B),v.setTilt(C)}var q,r={},u=0,x=0,y=0,z=0,A=0,B=0,C=0,D=!1,E=!1;w.init=function(c){"ontouchstart"in a?(b(c,"touchstart",i),b(I,"touchmove",j),b(I,"touchend",k),b(c,"gesturechange",l)):(b(c,"mousedown",e),b(I,"mousemove",f),b(I,"mouseup",g),b(c,"dblclick",d),b(c,"mousewheel",h),b(c,"DOMMouseScroll",h)),b(a,"resize",function(){clearTimeout(q),q=setTimeout(function(){(c.offsetWidth!==s||c.offsetHeight!==t)&&(p.canvas.width=s=c.offsetWidth,p.canvas.height=t=c.offsetHeight,w.emit("resize"))},250)})},w.on=function(a,b){r[a]||(r[a]=[]),r[a].push(b)},w.off=function(a,b){},w.emit=function(a,b){if(r[a])for(var c=0,d=r[a].length;d>c;c++)r[a][c](b)},w.setDisabled=function(a){D=!!a},w.isDisabled=function(){return!!D},w.destroy=function(){r=null}}();var x={};!function(){var a,b=0;x.setBusy=function(c){b||(a?(clearTimeout(a),a=null):w.emit("busy")),b++},x.setIdle=function(c){b&&(b--,b||(a=setTimeout(function(){a=null,w.emit("idle")},10)))},x.isBusy=function(){return!!b}}();var y={};!function(){function a(a){if(history.replaceState){var b=[],c=a.position;b.push("lat="+c.latitude.toFixed(5)),b.push("lon="+c.longitude.toFixed(5)),b.push("zoom="+a.zoom.toFixed(1)),b.push("tilt="+a.tilt.toFixed(1)),b.push("rotation="+a.rotation.toFixed(1)),history.replaceState({},"","?"+b.join("&"))}}y.load=function(){var a={},b=location.search;if(b){var c={};b=b.substring(1).replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(a,b,d){b&&(c[b]=d)});void 0!==c.lat&&void 0!==c.lon&&(a.position={latitude:parseFloat(c.lat),longitude:parseFloat(c.lon)}),void 0!==c.zoom&&(a.zoom=parseFloat(c.zoom)),void 0!==c.rotation&&(a.rotation=parseFloat(c.rotation)),void 0!==c.tilt&&(a.tilt=parseFloat(c.tilt))}return a};var b;y.save=function(c){clearTimeout(b),b=setTimeout(function(){a(c)},1e3)}}();var z=(Math.PI,15),A=256,B="anonymous",C="http://{s}.data.osmbuildings.org/0.2/{k}/tile/{z}/{x}/{y}.json",D=10,E=.7,F=r.parse("rgb(220, 210, 200)").toRGBA(!0),G=r.parse("#f08000").toRGBA(!0),H=r.parse("#f0f8ff").toRGBA(!0),I=a.document,J=6378137,K=J*Math.PI*2,L={};!function(){function a(a,c){if(b[a])return b[a];var d=new XMLHttpRequest;return d.onreadystatechange=function(){4===d.readyState&&(delete b[a],!d.status||d.status<200||d.status>299||c(d))},b[a]=d,d.open("GET",a),d.send(null),{abort:function(){b[a]&&(d.abort(),delete b[a])}}}var b={};L.getText=function(b,c){return a(b,function(a){void 0!==a.responseText&&c(a.responseText)})},L.getXML=function(b,c){return a(b,function(a){void 0!==a.responseXML&&c(a.responseXML)})},L.getJSON=function(b,c){return a(b,function(a){if(a.responseText){var d;try{d=JSON.parse(a.responseText)}catch(e){console.warn("Could not parse JSON from "+b+"\n"+e.message)}c(d)}})},L.abortAll=function(){for(var a in b)b[a].abort();b={}},L.destroy=function(){this.abortAll(),b=null}}();var M={interaction:{vertex:"#ifdef GL_ES\n  precision mediump float;\n#endif\nattribute vec4 aPosition;\nattribute vec3 aColor;\nuniform mat4 uMMatrix;\nuniform mat4 uMatrix;\nuniform float uFogRadius;\nvarying vec4 vColor;\nvoid main() {\n  gl_Position = uMatrix * aPosition;\n  vec4 mPosition = vec4(uMMatrix * aPosition);\n  float distance = length(mPosition);\n  if (distance > uFogRadius) {\n    vColor = vec4(0.0, 0.0, 0.0, 0.0);\n  } else {\n    vColor = vec4(aColor, 1.0);\n  }\n}\n",fragment:"#ifdef GL_ES\n  precision mediump float;\n#endif\nvarying vec4 vColor;\nvoid main() {\n  gl_FragColor = vColor;\n}\n"},depth:{vertex:"#ifdef GL_ES\n  precision mediump float;\n#endif\nattribute vec4 aPosition;\nuniform mat4 uMatrix;\nvarying vec4 vPosition;\nvoid main() {\n//  if (aHidden == 1.0) {\n//    gl_Position = vec4(0.0);\n//    vPosition = vec4(0.0);\n//  }\n  gl_Position = uMatrix * aPosition;\n  vPosition = aPosition;\n}\n",fragment:"#ifdef GL_ES\n  precision mediump float;\n#endif\nvarying vec4 vPosition;\nvoid main() {\n	gl_FragColor = vec4(vPosition.xyz, length(vPosition));\n}\n"},skydome:{vertex:"#ifdef GL_ES\n  precision mediump float;\n#endif\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMatrix;\nvarying vec2 vTexCoord;\nvarying float vFogIntensity;\nfloat gradientHeight = 10.0;\nfloat gradientStrength = 1.0;\nvoid main() {\n  gl_Position = uMatrix * aPosition;\n  vTexCoord = aTexCoord;\n  vFogIntensity = clamp((gradientHeight-aPosition.z) / (gradientHeight/gradientStrength), 0.0, gradientStrength);\n}\n",fragment:"#ifdef GL_ES\n  precision mediump float;\n#endif\nuniform sampler2D uTileImage;\nuniform vec3 uFogColor;\nvarying vec2 vTexCoord;\nvarying float vFogIntensity;\nvoid main() {\n  vec3 color = vec3(texture2D(uTileImage, vec2(vTexCoord.x, -vTexCoord.y)));\n  gl_FragColor = vec4(mix(color, uFogColor, vFogIntensity), 1.0);\n}\n"},buildings:{vertex:"#ifdef GL_ES\n  precision mediump float;\n#endif\nattribute vec4 aPosition;\nattribute vec3 aNormal;\nattribute vec3 aColor;\nattribute vec3 aIDColor;\nuniform mat4 uMatrix;\nuniform mat4 uMMatrix;\nuniform mat3 uNormalTransform;\nuniform vec3 uLightDirection;\nuniform vec3 uLightColor;\nuniform vec3 uFogColor;\nuniform float uFogRadius;\nuniform vec3 uHighlightColor;\nuniform vec3 uHighlightID;\nvarying vec3 vColor;\nfloat fogBlur = 200.0;\nfloat gradientHeight = 90.0;\nfloat gradientStrength = 0.4;\nvoid main() {\n  vec4 glPosition = uMatrix * aPosition;\n  gl_Position = glPosition;\n  //*** highlight object ******************************************************\n  vec3 color = aColor;\n  if (uHighlightID.r == aIDColor.r && uHighlightID.g == aIDColor.g && uHighlightID.b == aIDColor.b) {\n    color = mix(aColor, uHighlightColor, 0.5);\n  }\n  //*** light intensity, defined by light direction on surface ****************\n  vec3 transformedNormal = aNormal * uNormalTransform;\n  float lightIntensity = max( dot(transformedNormal, uLightDirection), 0.0) / 1.5;\n  color = color + uLightColor * lightIntensity;\n  //*** vertical shading ******************************************************\n  float verticalShading = clamp((gradientHeight-aPosition.z) / (gradientHeight/gradientStrength), 0.0, gradientStrength);\n  //*** fog *******************************************************************\n  vec4 mPosition = uMMatrix * aPosition;\n  float distance = length(mPosition);\n  float fogIntensity = (distance - uFogRadius) / fogBlur + 1.1; // <- shifts blur in/out\n  fogIntensity = clamp(fogIntensity, 0.0, 1.0);\n  //***************************************************************************\n  vColor = mix(vec3(color - verticalShading), uFogColor, fogIntensity);\n}\n",fragment:"#ifdef GL_ES\n  precision mediump float;\n#endif\nvarying vec3 vColor;\nvoid main() {\n  gl_FragColor = vec4(vColor, 1.0);\n}\n"},basemap:{vertex:"#ifdef GL_ES\n  precision mediump float;\n#endif\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMMatrix;\nuniform mat4 uMatrix;\nuniform float uFogRadius;\nvarying vec2 vTexCoord;\nvarying float vFogIntensity;\nfloat fogBlur = 200.0;\nvoid main() {\n  vec4 glPosition = uMatrix * aPosition;\n  gl_Position = glPosition;\n  vTexCoord = aTexCoord;\n  //*** fog *******************************************************************\n  vec4 mPosition = uMMatrix * aPosition;\n  float distance = length(mPosition);\n  // => (distance - (uFogRadius - fogBlur)) / (uFogRadius - (uFogRadius - fogBlur));\n  float fogIntensity = (distance - uFogRadius) / fogBlur + 1.1; // <- shifts blur in/out\n  vFogIntensity = clamp(fogIntensity, 0.0, 1.0);\n  //vFogIntensity = 0.0;\n}\n",fragment:"#ifdef GL_ES\n  precision mediump float;\n#endif\nuniform sampler2D uTileImage;\nuniform vec3 uFogColor;\nvarying vec2 vTexCoord;\nvarying float vFogIntensity;\nvoid main() {\n  vec3 color = vec3(texture2D(uTileImage, vec2(vTexCoord.x, -vTexCoord.y)));\n  gl_FragColor = vec4(mix(color, uFogColor, vFogIntensity), 1.0);\n}\n"}},N={};!function(){function a(a,b,c){var d=a[0]-b[0],e=a[1]-b[1],f=a[2]-b[2],g=b[0]-c[0],h=b[1]-c[1],i=b[2]-c[2],j=e*i-f*h,k=f*g-d*i,l=d*h-e*g,m=n(j,k,l);return 0===Math.round(5e3*m[2])}var b=16,c=24;N.quad=function(a,b,c,d,e){return this.addTriangle(a,b,c,d),this.addTriangle(a,c,e,d),6},N.circle=function(a,b,d,e){for(var f,g,h=0;c>h;h++)f=h/c,g=(h+1)/c,this.addTriangle(a,[b[0]+d*Math.sin(f*Math.PI*2),b[1]+d*Math.cos(f*Math.PI*2),e],[b[0],b[1],e],[b[0]+d*Math.sin(g*Math.PI*2),b[1]+d*Math.cos(g*Math.PI*2),e]);return 3*c},N.polygon=function(a,b,c){for(var d=q(b),e=0,f=d.length-2;f>e;e+=3)this.addTriangle(a,[d[e][0],d[e][1],c],[d[e+1][0],d[e+1][1],c],[d[e+2][0],d[e+2][1],c]);return d.length},N.polygon3d=function(b,c){var d,e,f,g=c[0],h=g.length;if(4>=h){var i=0;return i+=this.addTriangle(b,g[0],g[2],g[1]),4===h&&(i+=this.addTriangle(b,g[0],g[3],g[2])),i}if(a(g[0],g[1],g[2])){for(var j=0,k=c[0].length;k>j;j++)c[0][j]=[c[0][j][2],c[0][j][1],c[0][j][0]];for(d=q(c),e=0,f=d.length-2;f>e;e+=3)this.addTriangle(b,[d[e][2],d[e][1],d[e][0]],[d[e+1][2],d[e+1][1],d[e+1][0]],[d[e+2][2],d[e+2][1],d[e+2][0]]);return d.length}for(d=q(c),e=0,f=d.length-2;f>e;e+=3)this.addTriangle(b,[d[e][0],d[e][1],d[e][2]],[d[e+1][0],d[e+1][1],d[e+1][2]],[d[e+2][0],d[e+2][1],d[e+2][2]]);return d.length},N.cylinder=function(a,b,d,e,f,g){for(var h,i,j,k,l,m,n=0,o=c,p=2*Math.PI,q=0;o>q;q++)h=q/o*p,i=(q+1)/o*p,j=Math.sin(h),k=Math.cos(h),l=Math.sin(i),m=Math.cos(i),n+=this.addTriangle(a,[b[0]+d*j,b[1]+d*k,f],[b[0]+e*l,b[1]+e*m,g],[b[0]+d*l,b[1]+d*m,f]),0!==e&&(n+=this.addTriangle(a,[b[0]+e*j,b[1]+e*k,g],[b[0]+e*l,b[1]+e*m,g],[b[0]+d*j,b[1]+d*k,f]));return n},N.dome=function(a,c,d,e,f){for(var g,h,i,j,k,l,m,n,o,p,q=0,r=f-e,s=b/2,t=Math.PI/2,u=0;s>u;u++)g=u/s*t-t,h=(u+1)/s*t-t,i=Math.sin(g),j=Math.cos(g),k=Math.sin(h),l=Math.cos(h),m=j*d,n=l*d,o=e-i*r,p=e-k*r,q+=this.cylinder(a,c,n,m,p,o);return q},N.pyramid=function(a,b,c,d,e){b=b[0];for(var f=0,g=0,h=b.length-1;h>g;g++)f+=this.addTriangle(a,[b[g][0],b[g][1],d],[b[g+1][0],b[g+1][1],d],[c[0],c[1],e]);return f},N.extrusion=function(a,b,c,d){for(var e,f,g,h,i,j,k=0,l=0,m=b.length;m>l;l++){e=b[l],f=e.length-1,(e[0][0]!==e[f][0]||e[0][1]!==e[f][1])&&(e.push(e[0]),f++);for(var n=0;f>n;n++)g=e[n],h=e[n+1],i=c,j=d,k+=this.quad(a,[g[0],g[1],i],[h[0],h[1],i],[g[0],g[1],j],[h[0],h[1],j])}return k},N.addTriangle=function(a,b,c,d){a.vertices.push(b[0],b[1],b[2],d[0],d[1],d[2],c[0],c[1],c[2]);var e=m(b[0],b[1],b[2],c[0],c[1],c[2],d[0],d[1],d[2]);return a.normals.push(e[0],e[1],e[2],e[0],e[1],e[2],e[0],e[1],e[2]),3}}();var O={Index:{items:[],add:function(a){this.items.push(a)},remove:function(a){for(var b=this.items,c=0,d=b.length;d>c;c++)if(b[c]===a)return void b.splice(c,1)},destroy:function(){this.items=null}}},P={};!function(){function a(a){return a?(h&&clearTimeout(h),void(h=setTimeout(function(){h=null,c()},a))):void c()}function b(){j=Math.round(q||v.zoom);var a=Z.radius,b=Math.pow(2,j-v.zoom)/A,c=v.center;l=(c.x-a)*b<<0,m=(c.y-a)*b<<0,n=Math.ceil((c.x+a)*b),o=Math.ceil((c.y+a)*b)}function c(){if(!(v.zoom<z)){b();var a,c,e,g,h=[],i=[l+(n-l-1)/2,o];for(c=m;o>c;c++)for(a=l;n>a;a++)e=[a,c,j].join(","),p[e]||(p[e]=new Q(a,c,j),h.push({tile:p[e],dist:k([a,c],i)}));if(g=h.length){h.sort(function(a,b){return a.dist-b.dist});for(var q,r=0;g>r;r++)q=h[r].tile,q.load(f(q.tileX,q.tileY,q.zoom));d()}}}function d(){for(var a in p)e(p[a],1)||(p[a].destroy(),delete p[a])}function e(a,b){b=b||0;var c=a.tileX,d=a.tileY;return a.zoom===j&&c>=l-b&&n+b>=c&&d>=m-b&&o+b>=d}function f(a,b,c){var d="abcd"[(a+b)%4];return i(g,{s:d,x:a,y:b,z:c})}var g,h,j,l,m,n,o,p={},q=16;P.setSource=function(b,c){(void 0===b||b===!1||""===b)&&(b=C.replace("{k}",c)),b&&(g=b,w.on("change",function(){a(500)}),w.on("resize",a),a())},P.destroy=function(){clearTimeout(h);for(var a in p)p[a].destroy();p=null}}();var Q=function(a,b,c){this.tileX=a,this.tileY=b,this.zoom=c};Q.prototype={load:function(a){this.mesh=new T.GeoJSON(a)},destroy:function(){this.mesh&&(this.mesh.destroy(),this.mesh=null)}};var R={};!function(){function a(a){return a?void(h||(h=setTimeout(function(){h=null,c()},a))):void c()}function b(){j=Math.round(v.zoom);var a=Z.radius,b=Math.pow(2,j-v.zoom)/A,c=v.center;l=(c.x-a)*b<<0,m=(c.y-a)*b<<0,n=Math.ceil((c.x+a)*b),o=Math.ceil((c.y+a)*b)}function c(){b();var a,c,e,g,h=[],i=[l+(n-l-1)/2,o];for(c=m;o>c;c++)for(a=l;n>a;a++)e=[a,c,j].join(","),p[e]||(p[e]=new S(a,c,j),h.push({tile:p[e],dist:k([a,c],i)}));if(g=h.length){h.sort(function(a,b){return a.dist-b.dist});for(var q,r=0;g>r;r++)q=h[r].tile,q.load(f(q.tileX,q.tileY,q.zoom));d()}}function d(){for(var a in p)e(p[a],1)||(p[a].destroy(),delete p[a])}function e(a,b){b=b||0;var c=a.tileX,d=a.tileY;return a.zoom===j&&c>=l-b&&n+b>=c&&d>=m-b&&o+b>=d}function f(a,b,c){var d="abcd"[(a+b)%4];return i(g,{s:d,x:a,y:b,z:c})}var g,h,j,l,m,n,o,p={};R.setSource=function(b){b&&(g=b,w.on("change",function(){a(500)}),w.on("resize",a),a())},R.getTiles=function(){return p},R.destroy=function(){clearTimeout(h);for(var a in p)p[a].destroy();p=null}}();var S=function(a,b,c){this.tileX=a,this.tileY=b,this.zoom=c;for(var d=4,e=255/d,f=1/d,g=[],h=[],i=0;d>i;i++)for(var j=0;d>j;j++)g.push((i+1)*e,(j+1)*e,0,(i+1)*e,(j+0)*e,0,(i+0)*e,(j+1)*e,0,(i+0)*e,(j+0)*e,0),h.push((i+1)*f,(j+1)*f,(i+1)*f,(j+0)*f,(i+0)*f,(j+1)*f,(i+0)*f,(j+0)*f);this.vertexBuffer=new glx.Buffer(3,new Float32Array(g)),this.texCoordBuffer=new glx.Buffer(2,new Float32Array(h))};S.prototype={load:function(a){x.setBusy(),this.texture=new glx.texture.Image(a,function(a){x.setIdle(),a&&(this.isReady=!0)}.bind(this))},getMatrix:function(){if(this.isReady){var a=new glx.Matrix,b=1/Math.pow(2,this.zoom-v.zoom),c=v.center;return a.scale(1.005*b,1.005*b,1),a.translate(this.tileX*A*b-c.x,this.tileY*A*b-c.y,0),a}},destroy:function(){this.vertexBuffer.destroy(),this.texCoordBuffer.destroy(),this.texture&&this.texture.destroy(),x.setIdle()}};var T={};T.GeoJSON=function(){function a(a,b,c){var d=a[0],e=d.length;if(16>e)return!1;var f=b.maxX-b.minX,g=b.maxY-b.minY,h=f/g;if(.85>h||h>1.15)return!1;for(var i,j=(f+g)/4,l=j*j,m=0;e>m;m++)if(i=k(d[m],c),.75>i/l||i/l>1.25)return!1;return!0}function b(a,b){if(b=b||{},this._id=b.id,b.color&&(this._color=r.parse(b.color).toRGBA(!0)),this.scale=b.scale||1,this.rotation=b.rotation||0,this.elevation=b.elevation||0,this.position={},this._data={vertices:[],normals:[],colors:[],idColors:[]},x.setBusy(),"object"==typeof a){var c=a;this._onLoad(c)}else this._request=L.getJSON(a,function(a){this._request=null,this._onLoad(a)}.bind(this))}var c=16,d=A<<c,e=150,f=66;return b.prototype={_onLoad:function(a){if(a&&a.features.length){var b=a.features[0].geometry.coordinates[0][0];this.position={latitude:b[1],longitude:b[0]},j(function(b,c){var e=a.features.slice(b,c),f={type:"FeatureCollection",features:e},g=U.parse(this.position,d,f);this._addItems(g),c===a.features.length&&this._onReady()}.bind(this),0,a.features.length,e,f)}},_addItems:function(b){for(var c,d,e,f,g,h,i,j,k=0,m=b.length;m>k;k++){switch(c=b[k],e=Y.idToColor(this._id||c.id),f=l(c.geometry),g=[f.minX+(f.maxX-f.minX)/2,f.minY+(f.maxY-f.minY)/2],!c.shape&&a(c.geometry,f,g)&&(c.shape="cylinder",c.isRotational=!0),c.isRotational&&(h=(f.maxX-f.minX)/2),c.shape){case"cylinder":i=N.cylinder(this._data,g,h,h,c.minHeight,c.height);break;case"cone":i=N.cylinder(this._data,g,h,0,c.minHeight,c.height);break;case"dome":i=N.dome(this._data,g,h,c.minHeight,c.height);break;case"sphere":i=N.cylinder(this._data,g,h,h,c.minHeight,c.height);break;case"pyramid":i=N.pyramid(this._data,c.geometry,g,c.minHeight,c.height);break;default:i=N.extrusion(this._data,c.geometry,c.minHeight,c.height)}for(d=this._color||c.wallColor||F,j=0;i>j;j++)this._data.colors.push(d.r,d.g,d.b),this._data.idColors.push(e.r/255,e.g/255,e.b/255);switch(c.roofShape){case"cone":i=N.cylinder(this._data,g,h,0,c.height,c.height+c.roofHeight);break;case"dome":i=N.dome(this._data,g,h,c.height,c.height+(c.roofHeight||h));break;case"pyramid":i=N.pyramid(this._data,c.geometry,g,c.height,c.height+c.roofHeight);break;default:"cylinder"===c.shape?i=N.circle(this._data,g,h,c.height):void 0===c.shape&&(i=N.polygon(this._data,c.geometry,c.height))}for(d=this._color||c.roofColor||F,j=0;i>j;j++)this._data.colors.push(d.r,d.g,d.b),this._data.idColors.push(e.r/255,e.g/255,e.b/255)}},_onReady:function(){this.vertexBuffer=new glx.Buffer(3,new Float32Array(this._data.vertices)),this.normalBuffer=new glx.Buffer(3,new Float32Array(this._data.normals)),this.colorBuffer=new glx.Buffer(3,new Float32Array(this._data.colors)),this.idColorBuffer=new glx.Buffer(3,new Float32Array(this._data.idColors)),this._data=null,O.Index.add(this),this._isReady=!0,x.setIdle()},getMatrix:function(){var a=new glx.Matrix;this.elevation&&a.translate(0,0,this.elevation);var b=1/Math.pow(2,c-v.zoom)*this.scale;a.scale(b,b,b*E),this.rotation&&a.rotateZ(-this.rotation);var d=g(this.position.latitude,this.position.longitude,A*Math.pow(2,v.zoom)),e=v.center;return a.translate(d.x-e.x,d.y-e.y,0),a},destroy:function(){this._request&&this._request.abort(),this._isReady&&(O.Index.remove(this),this.vertexBuffer.destroy(),this.normalBuffer.destroy(),this.colorBuffer.destroy(),this.idColorBuffer.destroy())}},b}(),T.OBJ=function(){function a(a,b,c){c=c||{},this._id=c.id,c.color&&(this._color=r.parse(c.color).toRGBA(!0)),this.replaces=c.replaces||[],this.scale=c.scale||1,this.rotation=c.rotation||0,this.elevation=c.elevation||0,this.position=b,this._inMeters=A/(Math.cos(this.position.latitude*Math.PI/180)*K),this._vertices=[],this._normals=[],this._colors=[],this._idColors=[],x.setBusy(),this._request=L.getText(a,function(b){this._request=null;var c;(c=b.match(/^mtllib\s+(.*)$/m))?this._request=L.getText(a.replace(/[^\/]+$/,"")+c[1],function(a){this._request=null,this._onLoad(b,a)}.bind(this)):this._onLoad(b,null);
}.bind(this))}return a.prototype={_onLoad:function(a,b){var c=new V.parse(a,b);this._addItems(c),this._onReady()},_addItems:function(a){for(var b,c,d,e,f,g=0,h=a.length;h>g;g++)for(b=a[g],this._vertices.push.apply(this._vertices,b.vertices),this._normals.push.apply(this._normals,b.normals),c=this._color||b.color||F,d=Y.idToColor(this._id||b.id),e=0,f=b.vertices.length-2;f>e;e+=3)this._colors.push(c.r,c.g,c.b),this._idColors.push(d.r/255,d.g/255,d.b/255)},_onReady:function(){this.vertexBuffer=new glx.Buffer(3,new Float32Array(this._vertices)),this.normalBuffer=new glx.Buffer(3,new Float32Array(this._normals)),this.colorBuffer=new glx.Buffer(3,new Float32Array(this._colors)),this.idColorBuffer=new glx.Buffer(3,new Float32Array(this._idColors)),this._vertices=null,this._normals=null,this._colors=null,this._idColors=null,O.Index.add(this),this._isReady=!0,x.setIdle()},getMatrix:function(){var a=new glx.Matrix;this.elevation&&a.translate(0,0,this.elevation);var b=Math.pow(2,v.zoom)*this._inMeters*this.scale;a.scale(b,b,b),this.rotation&&a.rotateZ(-this.rotation);var c=g(this.position.latitude,this.position.longitude,A*Math.pow(2,v.zoom)),d=v.center;return a.translate(c.x-d.x,c.y-d.y,0),a},destroy:function(){this._request&&this._request.abort(),this._isReady&&(O.Index.remove(this),this.vertexBuffer.destroy(),this.normalBuffer.destroy(),this.colorBuffer.destroy(),this.idColorBuffer.destroy())}},a}();var U={};!function(){function a(a){return a=a.toLowerCase(),"#"===a[0]?a:f[h[a]||a]||null}function b(b,f,g,h){var i,j,k,l=h.properties,m={};if(l){switch(m.height=l.height||(l.levels?l.levels*e:D),m.minHeight=l.minHeight||(l.minLevel?l.minLevel*e:0),j=l.material?a(l.material):l.wallColor||l.color,m.wallColor=(i=r.parse(j))?i.toRGBA(!0):F,k=l.roofMaterial?a(l.roofMaterial):l.roofColor,m.roofColor=(i=r.parse(k))?i.toRGBA(!0):F,l.shape){case"cylinder":case"cone":case"dome":case"sphere":m.shape=l.shape,m.isRotational=!0;break;case"pyramid":m.shape=l.shape}switch(l.roofShape){case"cone":case"dome":m.roofShape=l.roofShape,m.isRotational=!0;break;case"pyramid":m.roofShape=l.roofShape}m.roofShape&&l.roofHeight?(m.roofHeight=l.roofHeight,m.height=Math.max(0,m.height-m.roofHeight)):m.roofHeight=0,m.id=l.relationId||h.id||l.id;for(var n=c(h.geometry),o=Object.create(m),p=0,q=n.length;q>p;p++)o.geometry=d(f,g,n[p]),b.push(o)}}function c(a){var b,d,e,f;switch(a.type){case"GeometryCollection":var g=[];for(b=0,d=a.geometries.length;d>b;b++)(f=c(a.geometries[b]))&&g.push.apply(g,f);return g;case"MultiPolygon":var h=[];for(b=0,d=a.coordinates.length;d>b;b++)(f=c({type:"Polygon",coordinates:a.coordinates[b]}))&&h.push.apply(g,f);return h;case"Polygon":e=a.coordinates;break;default:return[]}var i=[];for(b=0,d=e.length;d>b;b++)i[b]=e[b];return[i]}function d(a,b,c){for(var d,e,f,h,i=[],j=0,k=c.length;k>j;j++)for(h=c[j],i[j]=[],d=0,e=h.length-1;e>d;d++)f=g(h[d][1],h[d][0],b),i[j][d]=[f.x-a.x,f.y-a.y];return i}var e=3,f={brick:"#cc7755",bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",glass:"#e8f8f8",gold:"#ffcc00",plants:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},h={asphalt:"tar_paper",bitumen:"tar_paper",block:"stone",bricks:"brick",glas:"glass",glassfront:"glass",grass:"plants",masonry:"stone",granite:"stone",panels:"panel",paving_stones:"stone",plastered:"plaster",rooftiles:"roof_tiles",roofingfelt:"tar_paper",sandstone:"stone",sheet:"canvas",sheets:"canvas",shingle:"tar_paper",shingles:"tar_paper",slates:"slate",steel:"metal",tar:"tar_paper",tent:"canvas",thatch:"plants",tile:"roof_tiles",tiles:"roof_tiles"};U.parse=function(a,c,d){var e=[];if(d&&"FeatureCollection"===d.type&&d.features.length)for(var f=d.features,h=g(a.latitude,a.longitude,c),i=0,j=f.length;j>i;i++)b(e,h,c,f[i]);return e}}();var V=function(){this.vertices=[]};"undefined"!=typeof module&&(module.exports=V),V.prototype={parseMaterials:function(a){var b,c,d,e=a.split(/[\r\n]/g),f={},g=null;for(c=0,d=e.length;d>c;c++)switch(b=e[c].trim().split(/\s+/),b[0]){case"newmtl":this.storeMaterial(f,g),g={id:b[1],color:{}};break;case"Kd":g.color.r=parseFloat(b[1]),g.color.g=parseFloat(b[2]),g.color.b=parseFloat(b[3]);break;case"d":g.color.a=parseFloat(b[1])}return this.storeMaterial(f,g),a=null,f},storeMaterial:function(a,b){null!==b&&(a[b.id]=b.color)},parseModel:function(a,b){var c,d,e,f,g,h=a.split(/[\r\n]/g),i=[],j=[];for(d=0,e=h.length;e>d;d++)switch(c=h[d].trim().split(/\s+/),c[0]){case"g":case"o":this.storeMesh(i,f,g,j),f=c[1],j=[];break;case"usemtl":this.storeMesh(i,f,g,j),b[c[1]]&&(g=b[c[1]]),j=[];break;case"v":this.vertices.push([parseFloat(c[1]),parseFloat(c[2]),parseFloat(c[3])]);break;case"f":j.push([parseFloat(c[1])-1,parseFloat(c[2])-1,parseFloat(c[3])-1])}return this.storeMesh(i,f,g,j),a=null,i},storeMesh:function(a,b,c,d){if(d.length){var e=this.createGeometry(d);a.push({id:b,color:c,vertices:e.vertices,normals:e.normals})}},createGeometry:function(a){for(var b,c,d,e,f,g,h,i={vertices:[],normals:[]},j=0,k=a.length;k>j;j++)b=this.vertices[a[j][0]],c=this.vertices[a[j][1]],d=this.vertices[a[j][2]],e=[c[0]-b[0],c[1]-b[1],c[2]-b[2]],f=[d[0]-b[0],d[1]-b[1],d[2]-b[2]],g=[e[1]*f[2]-e[2]*f[1],e[2]*f[0]-e[0]*f[2],e[0]*f[1]-e[1]*f[0]],h=Math.sqrt(g[0]*g[0]+g[1]*g[1]+g[2]*g[2]),g[0]/=h,g[1]/=h,g[2]/=h,i.vertices.push(b[0],b[2],b[1],c[0],c[2],c[1],d[0],d[2],d[1]),i.normals.push(g[0],g[1],g[2],g[0],g[1],g[2],g[0],g[1],g[2]);return i}},V.parse=function(a,b){var c=new V,d=b?c.parseMaterials(b):{};return c.parseModel(a,d)};var W={start:function(a){this.fogColor=a.fogColor?r.parse(a.fogColor).toRGBA(!0):H,this.layers={},this.layers.skydome=Z.initShader(),this.layers.basemap=$.initShader(),this.layers.buildings=_.initShader({showBackfaces:a.showBackfaces}),this.resize(),w.on("resize",this.resize.bind(this)),p.cullFace(p.BACK),p.enable(p.CULL_FACE),p.enable(p.DEPTH_TEST),this.loop=setInterval(function(){requestAnimationFrame(function(){v.transform=(new glx.Matrix).rotateZ(v.rotation).rotateX(v.tilt);var a=new glx.Matrix(glx.Matrix.multiply(v.transform,this.perspective));p.clearColor(this.fogColor.r,this.fogColor.g,this.fogColor.b,1),p.clear(p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT),this.layers.skydome.render(a),this.layers.buildings.render(a),this.layers.basemap.render(a)}.bind(this))}.bind(this),17)},stop:function(){clearInterval(this.loop)},resize:function(){var a=1024,b=45;this.perspective=(new glx.Matrix).translate(0,-t/2,-1220).scale(1,-1,1).multiply(new glx.Matrix.Perspective(b*t/a,s/t,.1,5e3)).translate(0,-1,0),p.viewport(0,0,s,t)},destroy:function(){this.stop();for(var a in this.layers)this.layers[a].destroy()}},X={};!function(){var a;X.initShader=function(){return a=new glx.Shader({vertexShader:M.depth.vertex,fragmentShader:M.depth.fragment,attributes:["aPosition"],uniforms:["uMatrix"]}),this},X.render=function(b){if(!(v.zoom<z)){a.enable(),p.clearColor(0,0,0,1),p.clear(p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT);for(var c,d,e,f=O.Index.items,g=0,h=f.length;h>g;g++)c=f[g],(d=c.getMatrix())&&(e=glx.Matrix.multiply(d,b),p.uniformMatrix4fv(a.uniforms.uMatrix,!1,e),c.vertexBuffer.enable(),p.vertexAttribPointer(a.attributes.aPosition,c.vertexBuffer.itemSize,p.FLOAT,!1,0,0),p.drawArrays(p.TRIANGLES,0,c.vertexBuffer.numItems));a.disable()}}}();var Y={idMapping:[null],viewportSize:1024,initShader:function(){return this.shader=new glx.Shader({vertexShader:M.interaction.vertex,fragmentShader:M.interaction.fragment,attributes:["aPosition","aColor"],uniforms:["uMMatrix","uMatrix","uFogRadius"]}),this.framebuffer=new glx.Framebuffer(this.viewportSize,this.viewportSize),this},getTargetID:function(a,b,c){if(!(v.zoom<z)){var d=new glx.Matrix(glx.Matrix.multiply(v.transform,W.perspective)),e=this.shader,f=this.framebuffer;p.viewport(0,0,this.viewportSize,this.viewportSize),e.enable(),f.enable(),p.clearColor(0,0,0,1),p.clear(p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT),p.uniform1f(e.uniforms.uFogRadius,Z.radius);for(var g,h,i,j=O.Index.items,k=0,l=j.length;l>k;k++)g=j[k],(h=g.getMatrix())&&(p.uniformMatrix4fv(e.uniforms.uMMatrix,!1,h.data),i=glx.Matrix.multiply(h,d),p.uniformMatrix4fv(e.uniforms.uMatrix,!1,i),g.vertexBuffer.enable(),p.vertexAttribPointer(e.attributes.aPosition,g.vertexBuffer.itemSize,p.FLOAT,!1,0,0),g.idColorBuffer.enable(),p.vertexAttribPointer(e.attributes.aColor,g.idColorBuffer.itemSize,p.FLOAT,!1,0,0),p.drawArrays(p.TRIANGLES,0,g.vertexBuffer.numItems));var m=f.getData();e.disable(),f.disable(),p.viewport(0,0,s,t),a=a/s*this.viewportSize<<0,b=b/t*this.viewportSize<<0;var n=4*((this.viewportSize-b)*this.viewportSize+a),o=m[n]|m[n+1]<<8|m[n+2]<<16;c(this.idMapping[o])}},idToColor:function(a){var b=this.idMapping.indexOf(a);return-1===b&&(this.idMapping.push(a),b=this.idMapping.length-1),{r:255&b,g:b>>8&255,b:b>>16&255}}},Z={};!function(){function a(a){for(var b,c,d,e,f,g,j,k,l,m,n,o,p,q,r,s,t,u={vertices:[],texCoords:[]},v=Math.sin,w=Math.cos,x=Math.PI,y=0;i>y;y++)for(p=y/i,b=2*p*x,c=w(b)*a,d=v(b)*a,q=(y+1)/i,e=2*q*x,f=w(e)*a,g=v(e)*a,t=0;h>t;t++)j=t*x/(2*h),k=(t+1)*x/(2*h),l=[c*w(j),d*w(j),a*v(j)],m=[f*w(j),g*w(j),a*v(j)],n=[f*w(k),g*w(k),a*v(k)],o=[c*w(k),d*w(k),a*v(k)],u.vertices.push.apply(u.vertices,l),u.vertices.push.apply(u.vertices,m),u.vertices.push.apply(u.vertices,n),u.vertices.push.apply(u.vertices,l),u.vertices.push.apply(u.vertices,n),u.vertices.push.apply(u.vertices,o),r=1-(t+1)/h,s=1-t/h,u.texCoords.push(p,s,q,s,q,r,p,s,q,r,p,r);return u}var b,c,d,e,f,g=500,h=8,i=24;Z.initShader=function(){var h="skydome.jpg",i=a(g);return this.resize(),w.on("resize",this.resize.bind(this)),b=new glx.Shader({vertexShader:M.skydome.vertex,fragmentShader:M.skydome.fragment,attributes:["aPosition","aTexCoord"],uniforms:["uMatrix","uTileImage","uFogColor"]}),c=new glx.Buffer(3,new Float32Array(i.vertices)),d=new glx.Buffer(2,new Float32Array(i.texCoords)),x.setBusy(),e=new glx.texture.Image(h,function(a){x.setIdle(),a&&(f=!0)}),this},Z.resize=function(){this.radius=Math.sqrt(s*s+t*t)/1},Z.render=function(a){if(f){b.enable(),p.uniform3fv(b.uniforms.uFogColor,[W.fogColor.r,W.fogColor.g,W.fogColor.b]);var h=new glx.Matrix,i=this.radius/g;h.scale(i,i,i);var j=glx.Matrix.multiply(h,a);p.uniformMatrix4fv(b.uniforms.uMatrix,!1,j),c.enable(),p.vertexAttribPointer(b.attributes.aPosition,c.itemSize,p.FLOAT,!1,0,0),d.enable(),p.vertexAttribPointer(b.attributes.aTexCoord,d.itemSize,p.FLOAT,!1,0,0),e.enable(0),p.uniform1i(b.uniforms.uTileImage,0),p.drawArrays(p.TRIANGLES,0,c.numItems),b.disable()}}}();var $={};!function(){var a;$.initShader=function(){return a=new glx.Shader({vertexShader:M.basemap.vertex,fragmentShader:M.basemap.fragment,attributes:["aPosition","aTexCoord"],uniforms:["uMMatrix","uMatrix","uTileImage","uFogRadius","uFogColor"]}),this},$.render=function(b){var c,d,e,f=R.getTiles();a.enable(),p.uniform1f(a.uniforms.uFogRadius,Z.radius),p.uniform3fv(a.uniforms.uFogColor,[W.fogColor.r,W.fogColor.g,W.fogColor.b]);for(var g in f)c=f[g],(d=c.getMatrix())&&(p.uniformMatrix4fv(a.uniforms.uMMatrix,!1,d.data),e=glx.Matrix.multiply(d,b),p.uniformMatrix4fv(a.uniforms.uMatrix,!1,e),c.vertexBuffer.enable(),p.vertexAttribPointer(a.attributes.aPosition,c.vertexBuffer.itemSize,p.FLOAT,!1,0,0),c.texCoordBuffer.enable(),p.vertexAttribPointer(a.attributes.aTexCoord,c.texCoordBuffer.itemSize,p.FLOAT,!1,0,0),c.texture.enable(0),p.uniform1i(a.uniforms.uTileImage,0),p.drawArrays(p.TRIANGLE_STRIP,0,c.vertexBuffer.numItems));a.disable()}}();var _={};!function(){var a;_.initShader=function(b){return a=new glx.Shader({vertexShader:M.buildings.vertex,fragmentShader:M.buildings.fragment,attributes:["aPosition","aColor","aNormal","aIDColor"],uniforms:["uMMatrix","uMatrix","uNormalTransform","uAlpha","uLightColor","uLightDirection","uFogRadius","uFogColor","uHighlightColor","uHighlightID"]}),this.showBackfaces=b.showBackfaces,this},_.render=function(b){if(!(v.zoom<z)){a.enable(),this.showBackfaces&&p.disable(p.CULL_FACE),p.uniform3fv(a.uniforms.uLightColor,[.5,.5,.5]),p.uniform3fv(a.uniforms.uLightDirection,n(1,1,1));var c=glx.Matrix.invert3((new glx.Matrix).data);p.uniformMatrix3fv(a.uniforms.uNormalTransform,!1,glx.Matrix.transpose(c)),p.uniform1f(a.uniforms.uFogRadius,Z.radius),p.uniform3fv(a.uniforms.uFogColor,[W.fogColor.r,W.fogColor.g,W.fogColor.b]),this.highlightColor||(this.highlightColor=G),p.uniform3fv(a.uniforms.uHighlightColor,[this.highlightColor.r,this.highlightColor.g,this.highlightColor.b]),this.highlightID||(this.highlightID={r:0,g:0,b:0}),p.uniform3fv(a.uniforms.uHighlightID,[this.highlightID.r/255,this.highlightID.g/255,this.highlightID.b/255]);for(var d,e,f,g=O.Index.items,h=0,i=g.length;i>h;h++)d=g[h],(e=d.getMatrix())&&(p.uniformMatrix4fv(a.uniforms.uMMatrix,!1,e.data),f=glx.Matrix.multiply(e,b),p.uniformMatrix4fv(a.uniforms.uMatrix,!1,f),d.vertexBuffer.enable(),p.vertexAttribPointer(a.attributes.aPosition,d.vertexBuffer.itemSize,p.FLOAT,!1,0,0),d.normalBuffer.enable(),p.vertexAttribPointer(a.attributes.aNormal,d.normalBuffer.itemSize,p.FLOAT,!1,0,0),d.colorBuffer.enable(),p.vertexAttribPointer(a.attributes.aColor,d.colorBuffer.itemSize,p.FLOAT,!1,0,0),d.idColorBuffer.enable(),p.vertexAttribPointer(a.attributes.aIDColor,d.idColorBuffer.itemSize,p.FLOAT,!1,0,0),p.drawArrays(p.TRIANGLES,0,d.vertexBuffer.numItems));this.showBackfaces&&p.enable(p.CULL_FACE),a.disable()}}}()}(this);