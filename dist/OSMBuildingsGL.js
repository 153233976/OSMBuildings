!function(a){function b(a,b,c){var d=b/360+.5,e=Math.min(1,Math.max(0,.5-Math.log(Math.tan(Math.PI/4+Math.PI/2*a/180))/Math.PI/2));return{x:d*c,y:e*c}}function c(a,b){return a.replace(/\{(\w+)\}/g,function(a,c){return b[c]||a})}function d(a,b,c,e,f){e=e||1e3,f=f||1;var g=b+Math.min(c-b,e);b!==g&&(a(b,g),c>b&&setTimeout(function(){d(a,g,c,e,f)},f))}function e(a,b){var c=a[0]-b[0],d=a[1]-b[1];return c*c+d*d}function f(a,b,c,d,e,f,h,i,j){var k=a-d,l=b-e,m=c-f,n=d-h,o=e-i,p=f-j,q=l*p-m*o,r=m*n-k*p,s=k*o-l*n;return g(q,r,s)}function g(a,b,c){var d=Math.sqrt(a*a+b*b+c*c);return 0===d&&(d=1e-5),[a/d,b/d,c/d]}var h=function(){"use strict";function a(a,e){var f=c(b(a[0],!0)),g=e?{vertices:[],indices:[]}:[];if(!f)return g;var h,j,k,l,m,n,o,p,q,r=80;for(q=0;r>=0&&q<a.length;q++)r-=a[q].length;if(0>r){h=f.next,j=l=h.p[0],k=m=h.p[1];do n=h.p[0],o=h.p[1],j>n&&(j=n),k>o&&(k=o),n>l&&(l=n),o>m&&(m=o),h=h.next;while(h!==f);p=Math.max(l-j,m-k)}return a.length>1&&(f=i(a,f)),d(f,g,j,k,p),g}function b(a,b){var c,d,e,f,g,h=0,i=a.length;for(c=0,d=i-1;i>c;d=c++)e=a[c],f=a[d],h+=(f[0]-e[0])*(e[1]+f[1]);if(b===h>0)for(c=0;i>c;c++)g=y(a[c],g);else for(c=i-1;c>=0;c--)g=y(a[c],g);return g}function c(a,b){b||(b=a);var c,d=a;do if(c=!1,r(d.p,d.next.p)||0===q(d.prev.p,d.p,d.next.p)){if(d.prev.next=d.next,d.next.prev=d.prev,d.prevZ&&(d.prevZ.nextZ=d.nextZ),d.nextZ&&(d.nextZ.prevZ=d.prevZ),d=b=d.prev,d===d.next)return null;c=!0}else d=d.next;while(c||d!==b);return b}function d(a,b,i,j,k,m){if(a){var n=void 0!==b.vertices;m||void 0===i||l(a,i,j,k);for(var o,p,q=a;a.prev!==a.next;)if(o=a.prev,p=a.next,f(a,i,j,k))n?(e(b,o),e(b,a),e(b,p)):(b.push(o.p),b.push(a.p),b.push(p.p)),p.prev=o,o.next=p,a.prevZ&&(a.prevZ.nextZ=a.nextZ),a.nextZ&&(a.nextZ.prevZ=a.prevZ),a=p.next,q=p.next;else if(a=p,a===q){m?1===m?(a=g(a,b),d(a,b,i,j,k,2)):2===m&&h(a,b,i,j,k):d(c(a),b,i,j,k,1);break}}}function e(a,b){b.source&&(b=b.source);var c=b.index;if(null===c){var d=b.p.length,e=a.vertices;b.index=c=e.length/d;for(var f=0;d>f;f++)e.push(b.p[f])}a.indices.push(c)}function f(a,b,c,d){var e=a.prev.p,f=a.p,g=a.next.p,h=e[0],i=f[0],j=g[0],k=e[1],l=f[1],m=g[1],o=h*l-k*i,p=h*m-k*j,q=j*l-m*i,r=o-p-q;if(0>=r)return!1;var s,t,u,v,w,x,y,z=m-k,A=h-j,B=k-l,C=i-h;if(void 0!==b){var D=i>h?j>h?h:j:j>i?i:j,E=l>k?m>k?k:m:m>l?l:m,F=h>i?h>j?h:j:i>j?i:j,G=k>l?k>m?k:m:l>m?l:m,H=n(D,E,b,c,d),I=n(F,G,b,c,d);for(y=a.nextZ;y&&y.z<=I;)if(s=y.p,y=y.nextZ,s!==e&&s!==g&&(t=s[0],u=s[1],v=z*t+A*u-p,v>=0&&(w=B*t+C*u+o,w>=0&&(x=r-v-w,x>=0&&(v&&w||v&&x||w&&x)))))return!1;for(y=a.prevZ;y&&y.z>=H;)if(s=y.p,y=y.prevZ,s!==e&&s!==g&&(t=s[0],u=s[1],v=z*t+A*u-p,v>=0&&(w=B*t+C*u+o,w>=0&&(x=r-v-w,x>=0&&(v&&w||v&&x||w&&x)))))return!1}else for(y=a.next.next;y!==a.prev;)if(s=y.p,y=y.next,t=s[0],u=s[1],v=z*t+A*u-p,v>=0&&(w=B*t+C*u+o,w>=0&&(x=r-v-w,x>=0&&(v&&w||v&&x||w&&x))))return!1;return!0}function g(a,b){var c=!!b.vertices,d=a;do{var f=d.prev,g=d.next.next;if(s(f.p,d.p,d.next.p,g.p)&&u(f,g)&&u(g,f)){c?(e(b,f),e(b,d),e(b,g)):(b.push(f.p),b.push(d.p),b.push(g.p)),f.next=g,g.prev=f;var h=d.prevZ,i=d.nextZ&&d.nextZ.nextZ;h&&(h.nextZ=i),i&&(i.prevZ=h),d=a=g}d=d.next}while(d!==a);return d}function h(a,b,e,f,g){var h=a;do{for(var i=h.next.next;i!==h.prev;){if(p(h,i)){var j=x(h,i);return h=c(h,h.next),j=c(j,j.next),d(h,b,e,f,g),void d(j,b,e,f,g)}i=i.next}h=h.next}while(h!==a)}function i(a,d){for(var e=a.length,f=[],g=1;e>g;g++){var h=c(b(a[g],!1));h&&f.push(o(h))}for(f.sort(w),g=0;g<f.length;g++)j(f[g],d),d=c(d,d.next);return d}function j(a,b){if(b=k(a,b)){var d=x(b,a);c(d,d.next)}}function k(a,b){var c,d,e,f=b,g=a.p,h=g[0],i=g[1],j=-(1/0);do{if(d=f.p,e=f.next.p,i<=d[1]&&i>=e[1]){var k=d[0]+(i-d[1])*(e[0]-d[0])/(e[1]-d[1]);h>=k&&k>j&&(j=k,c=d[0]<e[0]?f:f.next)}f=f.next}while(f!==b);if(!c)return null;var l,m,n,o,p,q,r=c.p[0],s=c.p[1],t=h*s-i*r,v=h*i-i*j,w=i-i,x=h-j,y=i-s,z=r-h,A=t-v-(j*s-i*r),B=0>=A?-1:1,C=c,D=1/0;for(f=c.next;f!==C;)l=f.p[0],m=f.p[1],n=h-l,n>=0&&l>=r&&(o=(w*l+x*m-v)*B,o>=0&&(p=(y*l+z*m+t)*B,p>=0&&A*B-o-p>=0&&(q=Math.abs(i-m)/n,D>q&&u(f,a)&&(c=f,D=q)))),f=f.next;return c}function l(a,b,c,d){var e=a;do null===e.z&&(e.z=n(e.p[0],e.p[1],b,c,d)),e.prevZ=e.prev,e.nextZ=e.next,e=e.next;while(e!==a);e.prevZ.nextZ=null,e.prevZ=null,m(e)}function m(a){for(var b,c,d,e,f,g,h,i,j=1;;){for(c=a,a=null,f=null,g=0;c;){for(g++,d=c,h=0,b=0;j>b&&(h++,d=d.nextZ,d);b++);for(i=j;h>0||i>0&&d;)0===h?(e=d,d=d.nextZ,i--):0!==i&&d?c.z<=d.z?(e=c,c=c.nextZ,h--):(e=d,d=d.nextZ,i--):(e=c,c=c.nextZ,h--),f?f.nextZ=e:a=e,e.prevZ=f,f=e;c=d}if(f.nextZ=null,1>=g)return a;j*=2}}function n(a,b,c,d,e){return a=1e3*(a-c)/e,a=16711935&(a|a<<8),a=252645135&(a|a<<4),a=858993459&(a|a<<2),a=1431655765&(a|a<<1),b=1e3*(b-d)/e,b=16711935&(b|b<<8),b=252645135&(b|b<<4),b=858993459&(b|b<<2),b=1431655765&(b|b<<1),a|b<<1}function o(a){var b=a,c=a;do b.p[0]<c.p[0]&&(c=b),b=b.next;while(b!==a);return c}function p(a,b){return!t(a,a.p,b.p)&&u(a,b)&&u(b,a)&&v(a,a.p,b.p)}function q(a,b,c){var d=(b[1]-a[1])*(c[0]-b[0])-(b[0]-a[0])*(c[1]-b[1]);return d>0?1:0>d?-1:0}function r(a,b){return a[0]===b[0]&&a[1]===b[1]}function s(a,b,c,d){return q(a,b,c)!==q(a,b,d)&&q(c,d,a)!==q(c,d,b)}function t(a,b,c){var d=a;do{var e=d.p,f=d.next.p;if(e!==b&&f!==b&&e!==c&&f!==c&&s(e,f,b,c))return!0;d=d.next}while(d!==a);return!1}function u(a,b){return-1===q(a.prev.p,a.p,a.next.p)?-1!==q(a.p,b.p,a.next.p)&&-1!==q(a.p,a.prev.p,b.p):-1===q(a.p,b.p,a.prev.p)||-1===q(a.p,a.next.p,b.p)}function v(a,b,c){var d=a,e=!1,f=(b[0]+c[0])/2,g=(b[1]+c[1])/2;do{var h=d.p,i=d.next.p;h[1]>g!=i[1]>g&&f<(i[0]-h[0])*(g-h[1])/(i[1]-h[1])+h[0]&&(e=!e),d=d.next}while(d!==a);return e}function w(a,b){return a.p[0]-b.p[0]}function x(a,b){var c=new z(a.p),d=new z(b.p),e=a.next,f=b.prev;return c.source=a,d.source=b,a.next=b,b.prev=a,c.next=e,e.prev=c,d.next=c,c.prev=d,f.next=d,d.prev=f,d}function y(a,b){var c=new z(a);return b?(c.next=b.next,c.prev=b,b.next.prev=c,b.next=c):(c.prev=c,c.next=c),c}function z(a){this.p=a,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.source=null,this.index=null}return a}(),i=function(a){function b(a,b,c){return 0>c&&(c+=1),c>1&&(c-=1),1/6>c?a+6*(b-a)*c:.5>c?b:2/3>c?a+(b-a)*(2/3-c)*6:a}function c(a,b){return Math.min(b,Math.max(0,a))}var d={aqua:"#00ffff",black:"#000000",blue:"#0000ff",fuchsia:"#ff00ff",gray:"#808080",grey:"#808080",green:"#008000",lime:"#00ff00",maroon:"#800000",navy:"#000080",olive:"#808000",orange:"#ffa500",purple:"#800080",red:"#ff0000",silver:"#c0c0c0",teal:"#008080",white:"#ffffff",yellow:"#ffff00"},e=function(a,b,c,d){this.H=a,this.S=b,this.L=c,this.A=d};return e.parse=function(a){var b,c=0,e=0,f=0,g=1;if(a=(""+a).toLowerCase(),a=d[a]||a,b=a.match(/^#(\w{2})(\w{2})(\w{2})$/))c=parseInt(b[1],16),e=parseInt(b[2],16),f=parseInt(b[3],16);else{if(!(b=a.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/)))return;c=parseInt(b[1],10),e=parseInt(b[2],10),f=parseInt(b[3],10),g=b[4]?parseFloat(b[5]):1}return this.fromRGBA(c,e,f,g)},e.fromRGBA=function(a,b,c,d){"object"==typeof a?(b=a.g/255,c=a.b/255,d=void 0!==a.a?a.a:1,a=a.r/255):(a/=255,b/=255,c/=255,d=void 0!==d?d:1);var f,g,h=Math.max(a,b,c),i=Math.min(a,b,c),j=(h+i)/2,k=h-i;if(k){switch(g=j>.5?k/(2-h-i):k/(h+i),h){case a:f=(b-c)/k+(c>b?6:0);break;case b:f=(c-a)/k+2;break;case c:f=(a-b)/k+4}f*=60}else f=g=0;return new e(f,g,j,d)},e.prototype={toRGBA:function(a){var d=c(this.H,360),e=c(this.S,1),f=c(this.L,1),g={a:c(this.A,1)};if(0===e)g.r=f,g.g=f,g.b=f;else{var h=.5>f?f*(1+e):f+e-f*e,i=2*f-h;d/=360,g.r=b(i,h,d+1/3),g.g=b(i,h,d),g.b=b(i,h,d-1/3)}return a?g:{r:Math.round(255*g.r),g:Math.round(255*g.g),b:Math.round(255*g.b),a:g.a}},toString:function(){var a=this.toRGBA();return 1===a.a?"#"+((1<<24)+(a.r<<16)+(a.g<<8)+a.b).toString(16).slice(1,7):"rgba("+[a.r,a.g,a.b,a.a.toFixed(2)].join(",")+")"},hue:function(a){return new e(this.H*a,this.S,this.L,this.A)},saturation:function(a){return new e(this.H,this.S*a,this.L,this.A)},lightness:function(a){return new e(this.H,this.S,this.L*a,this.A)},alpha:function(a){return new e(this.H,this.S,this.L,this.A*a)}},e}(this);!function(a){function b(a,b){var c=a[0]-b[0],d=a[1]-b[1];return c*c+d*d}function c(a,b,c){return Math.min(c,Math.max(a,b))}function d(a,b,c){return{x:Math.cos(c)*a-Math.sin(c)*b,y:Math.sin(c)*a+Math.cos(c)*b}}function e(a,b,c){a.addEventListener(b,c,!1)}function f(a){a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),a.returnValue=!1}var g=function(a){var b,c={};return c.View=function(a,c,d){var e=x.createElement("CANVAS");e.style.position="absolute",e.width=c,e.height=d,a.appendChild(e);var f={antialias:!0,depth:!0,premultipliedAlpha:!1};try{b=e.getContext("webgl",f)}catch(g){}if(!b)try{b=e.getContext("experimental-webgl",f)}catch(g){}if(!b)throw new Error("WebGL not supported");return e.addEventListener("webglcontextlost",function(a){console.warn("context lost")}),e.addEventListener("webglcontextrestored",function(a){console.warn("context restored")}),b.viewport(0,0,c,d),b.cullFace(b.BACK),b.enable(b.CULL_FACE),b.enable(b.DEPTH_TEST),b.clearColor(.5,.5,.5,1),b},c.start=function(a){return setInterval(function(){requestAnimationFrame(a)},17)},c.stop=function(a){clearInterval(a)},c.destroy=function(a){a.canvas.parentNode.removeChild(a.canvas),a.canvas=null},"function"==typeof define?define([],c):"object"==typeof exports?module.exports=c:a.glx=c,c.util={},c.util.nextPowerOf2=function(a){return a--,a|=a>>1,a|=a>>2,a|=a>>4,a|=a>>8,a|=a>>16,a++,a},c.util.calcNormal=function(a,b,c,d,e,f,g,h,i){var j=a-d,k=b-e,l=c-f,m=d-g,n=e-h,o=f-i,p=k*o-l*n,q=l*m-j*o,r=j*n-k*m;return this.calcUnit(p,q,r)},c.util.calcUnit=function(a,b,c){var d=Math.sqrt(a*a+b*b+c*c);return 0===d&&(d=1e-5),[a/d,b/d,c/d]},c.Buffer=function(a,c){this.id=b.createBuffer(),this.itemSize=a,this.numItems=c.length/a,b.bindBuffer(b.ARRAY_BUFFER,this.id),b.bufferData(b.ARRAY_BUFFER,c,b.STATIC_DRAW),c=null},c.Buffer.prototype={enable:function(){b.bindBuffer(b.ARRAY_BUFFER,this.id)},destroy:function(){b.deleteBuffer(this.id)}},c.Framebuffer=function(a,b){this.setSize(a,b)},c.Framebuffer.prototype={setSize:function(a,d){this.frameBuffer=b.createFramebuffer(),b.bindFramebuffer(b.FRAMEBUFFER,this.frameBuffer),this.width=a,this.height=d;var e=c.util.nextPowerOf2(Math.max(this.width,this.height));if(this.renderBuffer=b.createRenderbuffer(),b.bindRenderbuffer(b.RENDERBUFFER,this.renderBuffer),b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,e,e),this.renderTexture&&this.renderTexture.destroy(),this.renderTexture=new c.texture.Data(e),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,this.renderBuffer),b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,this.renderTexture.id,0),b.checkFramebufferStatus(b.FRAMEBUFFER)!==b.FRAMEBUFFER_COMPLETE)throw new Error("This combination of framebuffer attachments does not work");b.bindRenderbuffer(b.RENDERBUFFER,null),b.bindFramebuffer(b.FRAMEBUFFER,null)},enable:function(){b.bindFramebuffer(b.FRAMEBUFFER,this.frameBuffer),b.bindRenderbuffer(b.RENDERBUFFER,this.renderBuffer)},disable:function(){b.bindFramebuffer(b.FRAMEBUFFER,null),b.bindRenderbuffer(b.RENDERBUFFER,null)},getData:function(){var a=new Uint8Array(this.width*this.height*4);return b.readPixels(0,0,this.width,this.height,b.RGBA,b.UNSIGNED_BYTE,a),a},destroy:function(){this.renderTexture&&this.renderTexture.destroy()}},c.Shader=function(a){if(this.id=b.createProgram(),this.attach(b.VERTEX_SHADER,a.vertexShader),this.attach(b.FRAGMENT_SHADER,a.fragmentShader),b.linkProgram(this.id),!b.getProgramParameter(this.id,b.LINK_STATUS))throw new Error(b.getProgramParameter(this.id,b.VALIDATE_STATUS)+"\n"+b.getError());this.attributeNames=a.attributes,this.uniformNames=a.uniforms},c.Shader.prototype={locateAttribute:function(a){var c=b.getAttribLocation(this.id,a);return 0>c?void console.error('unable to locate attribute "'+a+'" in shader'):(b.enableVertexAttribArray(c),void(this.attributes[a]=c))},locateUniform:function(a){var c=b.getUniformLocation(this.id,a);return 0>c?void console.error('unable to locate uniform "'+a+'" in shader'):void(this.uniforms[a]=c)},attach:function(a,c){var d=b.createShader(a);if(b.shaderSource(d,c),b.compileShader(d),!b.getShaderParameter(d,b.COMPILE_STATUS))throw new Error(b.getShaderInfoLog(d));b.attachShader(this.id,d)},enable:function(){b.useProgram(this.id);var a;if(this.attributeNames)for(this.attributes={},a=0;a<this.attributeNames.length;a++)this.locateAttribute(this.attributeNames[a]);if(this.uniformNames)for(this.uniforms={},a=0;a<this.uniformNames.length;a++)this.locateUniform(this.uniformNames[a]);return this},disable:function(){if(this.attributes)for(var a in this.attributes)b.disableVertexAttribArray(this.attributes[a]);this.attributes=null,this.uniforms=null},destroy:function(){}},c.Matrix=function(a){a?this.data=new Float32Array(a):this.identity()},function(){function a(a){return a*Math.PI/180}function b(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=b[9],n=b[10],o=b[11],p=b[12],q=b[13],r=b[14],s=b[15],t=c[0],u=c[1],v=c[2],w=c[3],x=c[4],y=c[5],z=c[6],A=c[7],B=c[8],C=c[9],D=c[10],E=c[11],F=c[12],G=c[13],H=c[14],I=c[15];a[0]=d*t+e*x+f*B+g*F,a[1]=d*u+e*y+f*C+g*G,a[2]=d*v+e*z+f*D+g*H,a[3]=d*w+e*A+f*E+g*I,a[4]=h*t+i*x+j*B+k*F,a[5]=h*u+i*y+j*C+k*G,a[6]=h*v+i*z+j*D+k*H,a[7]=h*w+i*A+j*E+k*I,a[8]=l*t+m*x+n*B+o*F,a[9]=l*u+m*y+n*C+o*G,a[10]=l*v+m*z+n*D+o*H,a[11]=l*w+m*A+n*E+o*I,a[12]=p*t+q*x+r*B+s*F,a[13]=p*u+q*y+r*C+s*G,a[14]=p*v+q*z+r*D+s*H,a[15]=p*w+q*A+r*E+s*I}c.Matrix.prototype={identity:function(){return this.data=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this},multiply:function(a){return b(this.data,this.data,a.data),this},translate:function(a,c,d){return b(this.data,this.data,[1,0,0,0,0,1,0,0,0,0,1,0,a,c,d,1]),this},rotateX:function(c){var d=a(c),e=Math.cos(d),f=Math.sin(d);return b(this.data,this.data,[1,0,0,0,0,e,f,0,0,-f,e,0,0,0,0,1]),this},rotateY:function(c){var d=a(c),e=Math.cos(d),f=Math.sin(d);return b(this.data,this.data,[e,0,-f,0,0,1,0,0,f,0,e,0,0,0,0,1]),this},rotateZ:function(c){var d=a(c),e=Math.cos(d),f=Math.sin(d);return b(this.data,this.data,[e,-f,0,0,f,e,0,0,0,0,1,0,0,0,0,1]),this},scale:function(a,c,d){return b(this.data,this.data,[a,0,0,0,0,c,0,0,0,0,d,0,0,0,0,1]),this}},c.Matrix.multiply=function(a,c){var d=new Float32Array(16);return b(d,a.data,c.data),d},c.Matrix.Perspective=function(a,b,d,e){var f=1/Math.tan(a*(Math.PI/180)/2),g=1/(d-e);return new c.Matrix([f/b,0,0,0,0,f,0,0,0,0,(e+d)*g,-1,0,0,2*e*d*g,0])},c.Matrix.invert3=function(a){var b=a[0],c=a[1],d=a[2],e=a[4],f=a[5],g=a[6],h=a[8],i=a[9],j=a[10],k=j*f-g*i,l=-j*e+g*h,m=i*e-f*h,n=b*k+c*l+d*m;return n?(n=1/n,[k*n,(-j*c+d*i)*n,(g*c-d*f)*n,l*n,(j*b-d*h)*n,(-g*b+d*e)*n,m*n,(-i*b+c*h)*n,(f*b-c*e)*n]):null},c.Matrix.transpose=function(a){return new Float32Array([a[0],a[3],a[6],a[1],a[4],a[7],a[2],a[5],a[8]])},c.Matrix.transform=function(a){var b=a[12],c=a[13],d=a[14],e=a[15];return{x:(b/e+1)/2,y:(c/e+1)/2,z:(d/e+1)/2}},c.Matrix.invert=function(a){var b=new Float32Array(16),c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=s*D-t*C+u*B+v*A-w*z+x*y;if(E)return E=1/E,b[0]=(h*D-i*C+j*B)*E,b[1]=(e*C-d*D-f*B)*E,b[2]=(p*x-q*w+r*v)*E,b[3]=(m*w-l*x-n*v)*E,b[4]=(i*A-g*D-j*z)*E,b[5]=(c*D-e*A+f*z)*E,b[6]=(q*u-o*x-r*t)*E,b[7]=(k*x-m*u+n*t)*E,b[8]=(g*C-h*A+j*y)*E,b[9]=(d*A-c*C-f*y)*E,b[10]=(o*w-p*u+r*s)*E,b[11]=(l*u-k*w-n*s)*E,b[12]=(h*z-g*B-i*y)*E,b[13]=(c*B-d*z+e*y)*E,b[14]=(p*t-o*v-q*s)*E,b[15]=(k*v-l*t+m*s)*E,b}}(),c.texture={},c.texture.Image=function(a,c){this.id=b.createTexture(),b.bindTexture(b.TEXTURE_2D,this.id),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR_MIPMAP_NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0),b.bindTexture(b.TEXTURE_2D,null);var d=new Image;d.crossOrigin="*",d.onload=function(){var a=b.getParameter(b.MAX_TEXTURE_SIZE);if(d.width>a||d.height>a){var e=a,f=a,g=d.width/d.height;1>g?e=Math.round(f*g):f=Math.round(e/g);var h=x.createElement("CANVAS");h.width=e,h.height=f;var i=h.getContext("2d");i.drawImage(d,0,0,h.width,h.height),d=h}this.id?(b.bindTexture(b.TEXTURE_2D,this.id),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,d),b.generateMipmap(b.TEXTURE_2D),b.bindTexture(b.TEXTURE_2D,null)):d=null,c&&c(d)}.bind(this),d.onerror=function(){c&&c()},d.src=a},c.texture.Image.prototype={enable:function(a){this.id&&(b.bindTexture(b.TEXTURE_2D,this.id),b.activeTexture(b.TEXTURE0+(a||0)))},disable:function(){b.bindTexture(b.TEXTURE_2D,null)},destroy:function(){b.bindTexture(b.TEXTURE_2D,null),b.deleteTexture(this.id),this.id=null}},c.texture.Data=function(a,c,d){this.id=b.createTexture(),b.bindTexture(b.TEXTURE_2D,this.id),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);var e=null;if(c){var f=a*a*4;e=new Uint8Array(f),e.set(c.subarray(0,f))}b.texImage2D(b.TEXTURE_2D,0,b.RGBA,a,a,0,b.RGBA,b.UNSIGNED_BYTE,e),b.bindTexture(b.TEXTURE_2D,null)},c.texture.Data.prototype={enable:function(a){b.bindTexture(b.TEXTURE_2D,this.id),b.activeTexture(b.TEXTURE0+(a||0))},disable:function(){b.bindTexture(b.TEXTURE_2D,null)},destroy:function(){b.bindTexture(b.TEXTURE_2D,null),b.deleteTexture(this.id)}},c.mesh={},c.mesh.addQuad=function(a,b,c,d,e,f){this.addTriangle(a,b,c,d,f),this.addTriangle(a,d,e,b,f)},c.mesh.addTriangle=function(a,b,d,e,f){a.vertices.push(b[0],b[1],b[2],d[0],d[1],d[2],e[0],e[1],e[2]);var g=c.util.calcNormal(b[0],b[1],b[2],d[0],d[1],d[2],e[0],e[1],e[2]);a.normals.push(g[0],g[1],g[2],g[0],g[1],g[2],g[0],g[1],g[2]),a.colors.push(f[0],f[1],f[2],f[3],f[0],f[1],f[2],f[3],f[0],f[1],f[2],f[3])},c.mesh.Triangle=function(a,b){var d={vertices:[],normals:[],colors:[]},e=[-a/2,-a/2,0],f=[a/2,-a/2,0],g=[a/2,a/2,0];c.mesh.addTriangle(d,e,f,g,b),this.vertexBuffer=new c.Buffer(3,new Float32Array(d.vertices)),this.normalBuffer=new c.Buffer(3,new Float32Array(d.normals)),this.colorBuffer=new c.Buffer(4,new Float32Array(d.colors)),this.transform=new c.Matrix},c.mesh.Plane=function(a,b){var d={vertices:[],normals:[],colors:[]},e=[-a/2,-a/2,0],f=[a/2,-a/2,0],g=[a/2,a/2,0],h=[-a/2,a/2,0];c.mesh.addQuad(d,e,f,g,h,b),this.vertexBuffer=new c.Buffer(3,new Float32Array(d.vertices)),this.normalBuffer=new c.Buffer(3,new Float32Array(d.normals)),this.colorBuffer=new c.Buffer(4,new Float32Array(d.colors)),this.transform=new c.Matrix},c.mesh.Cube=function(a,b){var d={vertices:[],normals:[],colors:[]},e=[-a/2,-a/2,-a/2],f=[a/2,-a/2,-a/2],g=[a/2,a/2,-a/2],h=[-a/2,a/2,-a/2],i=[-a/2,-a/2,a/2],j=[a/2,-a/2,a/2],k=[a/2,a/2,a/2],l=[-a/2,a/2,a/2];c.mesh.addQuad(d,e,f,g,h,b),c.mesh.addQuad(d,i,j,k,l,b),c.mesh.addQuad(d,e,f,j,i,b),c.mesh.addQuad(d,f,g,k,j,b),c.mesh.addQuad(d,g,h,l,k,b),c.mesh.addQuad(d,h,e,i,l,b),this.vertexBuffer=new c.Buffer(3,new Float32Array(d.vertices)),this.normalBuffer=new c.Buffer(3,new Float32Array(d.normals)),this.colorBuffer=new c.Buffer(4,new Float32Array(d.colors)),this.transform=new c.Matrix},c}(this),h=function(a,b){this.container="string"==typeof a?x.getElementById(a):a,this.container.classList.add("glmap-container"),this.width=this.container.offsetWidth,this.height=this.container.offsetHeight,this.context=g.View(this.container,this.width,this.height),this.minZoom=parseFloat(b.minZoom)||10,this.maxZoom=parseFloat(b.maxZoom)||20,this.maxZoom<this.minZoom&&(this.maxZoom=this.minZoom),this.center={x:0,y:0},this.zoom=0,this.viewMatrix=new g.Matrix,this.listeners={},this.restoreState(b),b.state&&(this.persistState(),this.on("change",function(){this.persistState()}.bind(this))),this.interaction=new i(this,this.container),b.disabled&&this.setDisabled(!0),this.attribution=b.attribution?[b.attribution]:[],this.attributionDiv=x.createElement("DIV"),this.attributionDiv.className="glmap-attribution",this.container.appendChild(this.attributionDiv),this.updateAttribution(),j.init(this),j.render()};h.TILE_SIZE=256,h.prototype={updateAttribution:function(){this.attributionDiv.innerHTML=j.getAttribution(this.attribution).join(" &middot; ")},restoreState:function(a){var b=location.search,c={};b&&b.substring(1).replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(a,b,d){b&&(c[b]=d)});var d;void 0!==c.lat&&void 0!==c.lon&&(d={latitude:parseFloat(c.lat),longitude:parseFloat(c.lon)}),this.setPosition(d||a.position||{latitude:52.52,longitude:13.41});var e;void 0!==c.zoom&&(e=void 0!==c.zoom?parseFloat(c.zoom):null),this.setZoom(e||a.zoom||this.minZoom);var f;void 0!==c.rotation&&(f=parseFloat(c.rotation)),this.setRotation(f||a.rotation||0);var g;void 0!==c.tilt&&(g=parseFloat(c.tilt)),this.setTilt(g||a.tilt||0)},persistState:function(){history.replaceState&&(this.stateDebounce||(this.stateDebounce=setTimeout(function(){this.stateDebounce=null;var a=[];a.push("lat="+this.position.latitude.toFixed(5)),a.push("lon="+this.position.longitude.toFixed(5)),a.push("zoom="+this.zoom.toFixed(1)),a.push("tilt="+this.tilt.toFixed(1)),a.push("rotation="+this.rotation.toFixed(1)),history.replaceState({},"","?"+a.join("&"))}.bind(this),1e3)))},setCenter:function(a){(this.center.x!==a.x||this.center.y!==a.y)&&(this.center=a,this.position=this.unproject(a.x,a.y,h.TILE_SIZE*Math.pow(2,this.zoom)),this.emit("change"))},emit:function(a,b){if(this.listeners[a]){var c=this.listeners[a];c.timer||(c.timer=setTimeout(function(){for(var a=0,d=c.fn.length;d>a;a++)c.fn[a](b);c.timer=null}.bind(this),17))}},getContext:function(){return this.context},on:function(a,b){return this.listeners[a]||(this.listeners[a]={fn:[]}),this.listeners[a].fn.push(b),this},off:function(a,b){},setDisabled:function(a){return this.interaction.disabled=!!a,this},isDisabled:function(){return!!this.interaction.disabled},project:function(a,b,c){var d=b/360+.5,e=Math.min(1,Math.max(0,.5-Math.log(Math.tan(Math.PI/4+Math.PI/2*a/180))/Math.PI/2));return{x:d*c,y:e*c}},unproject:function(a,b,c){return a/=c,b/=c,{latitude:(2*Math.atan(Math.exp(Math.PI*(1-2*b)))-Math.PI/2)*(180/Math.PI),longitude:360*a-180}},transform:function(a,b,c){var d=this.project(a,b,h.TILE_SIZE*Math.pow(2,this.zoom)),e=d.x-this.center.x,f=d.y-this.center.y,i=new g.Matrix(g.Matrix.multiply(this.viewMatrix,j.perspective)),k=1/Math.pow(2,16-this.zoom),l=(new g.Matrix).translate(0,0,c).scale(k,k,k*t).translate(e,f,0),m=g.Matrix.multiply(l,i),n=g.Matrix.transform(m);return{x:n.x*this.width,y:this.height-n.y*this.height,z:n.z}},getBounds:function(){var a=this.width/2,b=this.height/2,c=this.rotation*Math.PI/180,d=Math.cos(c)*a-Math.sin(c)*b,e=Math.sin(c)*a+Math.cos(c)*b,f=this.center,g=h.TILE_SIZE*Math.pow(2,this.zoom),i=this.unproject(f.x-d,f.y-e,g),j=this.unproject(f.x+d,f.y+e,g);return{n:i.latitude,w:i.longitude,s:j.latitude,e:j.longitude}},setZoom:function(a,b){if(a=c(parseFloat(a),this.minZoom,this.maxZoom),this.zoom!==a){var d=Math.pow(2,a-this.zoom);if(this.zoom=a,b){var e=this.container.offsetWidth/2-b.clientX,f=this.container.offsetHeight/2-b.clientY;this.center.x-=e,this.center.y-=f,this.center.x*=d,this.center.y*=d,this.center.x+=e,this.center.y+=f}else this.center.x*=d,this.center.y*=d;this.emit("change")}return this},getZoom:function(){return this.zoom},setPosition:function(a){var b=c(parseFloat(a.latitude),-90,90),d=c(parseFloat(a.longitude),-180,180),e=this.project(b,d,h.TILE_SIZE*Math.pow(2,this.zoom));return this.setCenter(e),this},getPosition:function(){return this.position},setSize:function(a){return(a.width!==this.width||a.height!==this.height)&&(this.context.canvas.width=this.width=a.width,this.context.canvas.height=this.height=a.height,this.emit("resize")),this},getSize:function(){return{width:this.width,height:this.height}},setRotation:function(a){return a=parseFloat(a)%360,this.rotation!==a&&(this.rotation=a,this.emit("change")),this},getRotation:function(){return this.rotation},setTilt:function(a){return a=c(parseFloat(a),0,60),this.tilt!==a&&(this.tilt=a,this.emit("change")),this},getTilt:function(){return this.tilt},getPerspective:function(){return j.perspective},addLayer:function(a){return j.add(a),this.updateAttribution(),this},removeLayer:function(a){j.remove(a),this.updateAttribution()},destroy:function(){this.listeners=null,this.interaction.destroy()}},"function"==typeof a.define?a.define([],h):"object"==typeof a.exports?a.module.exports=h:a.GLMap=h;var i=function(b,c){this.map=b,"ontouchstart"in a?(e(c,"touchstart",this.onTouchStart.bind(this)),e(x,"touchmove",this.onTouchMove.bind(this)),e(x,"touchend",this.onTouchEnd.bind(this)),e(c,"gesturechange",this.onGestureChange.bind(this))):(e(c,"mousedown",this.onMouseDown.bind(this)),e(x,"mousemove",this.onMouseMove.bind(this)),e(x,"mouseup",this.onMouseUp.bind(this)),e(c,"dblclick",this.onDoubleClick.bind(this)),e(c,"mousewheel",this.onMouseWheel.bind(this)),e(c,"DOMMouseScroll",this.onMouseWheel.bind(this)));var d;e(a,"resize",function(){d||(d=setTimeout(function(){d=null,b.emit("resize")},250))})};i.prototype={prevX:0,prevY:0,startX:0,startY:0,startZoom:0,prevRotation:0,prevTilt:0,disabled:!1,pointerIsDown:!1,onDoubleClick:function(a){this.disabled||(f(a),this.map.setZoom(this.map.zoom+1,a))},onMouseDown:function(a){this.disabled||a.button>1||(f(a),this.startZoom=this.map.zoom,this.prevRotation=this.map.rotation,this.prevTilt=this.map.tilt,this.startX=this.prevX=a.clientX,this.startY=this.prevY=a.clientY,this.pointerIsDown=!0,this.map.emit("pointerdown",{x:a.clientX,y:a.clientY}))},onMouseMove:function(a){this.disabled||(this.pointerIsDown&&(0!==a.button||a.altKey?this.rotateMap(a):this.moveMap(a),this.prevX=a.clientX,this.prevY=a.clientY),this.map.emit("pointermove",{x:a.clientX,y:a.clientY}))},onMouseUp:function(a){this.disabled||this.pointerIsDown&&(0!==a.button||a.altKey?this.rotateMap(a):(Math.abs(a.clientX-this.startX)>5||Math.abs(a.clientY-this.startY)>5)&&this.moveMap(a),this.pointerIsDown=!1,this.map.emit("pointerup",{x:a.clientX,y:a.clientY}))},onMouseWheel:function(a){if(!this.disabled){f(a);var b=0;a.wheelDeltaY?b=a.wheelDeltaY:a.wheelDelta?b=a.wheelDelta:a.detail&&(b=-a.detail);var c=.2*(b>0?1:0>b?-1:0);this.map.setZoom(this.map.zoom+c,a)}},onTouchStart:function(a){this.disabled||(f(a),this.startZoom=this.map.zoom,this.prevRotation=this.map.rotation,this.prevTilt=this.map.tilt,a.touches.length>1&&(a=a.touches[0]),this.startX=this.prevX=a.clientX,this.startY=this.prevY=a.clientY,this.map.emit("pointerdown",{x:a.clientX,y:a.clientY}))},onTouchMove:function(a){this.disabled||(a.touches.length>1&&(a=a.touches[0]),this.moveMap(a),this.prevX=a.clientX,this.prevY=a.clientY,this.map.emit("pointermove",{x:a.clientX,y:a.clientY}))},onTouchEnd:function(a){this.disabled||(a.touches.length>1&&(a=a.touches[0]),(Math.abs(a.clientX-this.startX)>5||Math.abs(a.clientY-this.startY)>5)&&this.moveMap(a),this.map.emit("pointerup",{x:a.clientX,y:a.clientY}))},onGestureChange:function(a){this.disabled||(f(a),this.map.setZoom(this.startZoom+(a.scale-1)),this.map.setRotation(this.prevRotation-a.rotation))},moveMap:function(a){var b=a.clientX-this.prevX,c=a.clientY-this.prevY,e=d(b,c,this.map.rotation*Math.PI/180);this.map.setCenter({x:this.map.center.x-e.x,y:this.map.center.y-e.y})},rotateMap:function(a){this.prevRotation+=(a.clientX-this.prevX)*(360/innerWidth),this.prevTilt-=(a.clientY-this.prevY)*(360/innerHeight),this.map.setRotation(this.prevRotation),this.map.setTilt(this.prevTilt)},destroy:function(){}};var j={init:function(a){this.map=a},items:[],add:function(a){this.items.push(a)},remove:function(a){for(var b=0;b<this.items.length;b++)if(this.items[b]===a)return void this.items.splice(b,1)},getAttribution:function(a){a=a||[];for(var b=0;b<this.items.length;b++)this.items[b].attribution&&a.push(this.items[b].attribution);return a},render:function(a){var b=this.map.context;this.resize(),this.map.on("resize",this.resize.bind(this)),b.cullFace(b.BACK),b.enable(b.CULL_FACE),b.enable(b.DEPTH_TEST),this.map.on("contextlost",function(){}.bind(this)),this.map.on("contextrestored",function(){}.bind(this)),this.loop=setInterval(function(){requestAnimationFrame(function(){this.map.viewMatrix=(new g.Matrix).rotateZ(this.map.rotation).rotateX(this.map.tilt);var a=new g.Matrix(g.Matrix.multiply(this.map.viewMatrix,this.perspective));b.clearColor(.5,.5,.5,1),b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT);for(var c=0;c<this.items.length;c++)this.items[c].render(a)}.bind(this))}.bind(this),17)},stop:function(){clearInterval(this.loop)},resize:function(){var a=1024,b=45;this.perspective=(new g.Matrix).translate(0,-this.map.height/2,-1220).scale(1,-1,1).multiply(new g.Matrix.Perspective(b*this.map.height/a,this.map.width/this.map.height,.1,5e3)).translate(0,-1,0),this.map.context.viewport(0,0,this.map.width,this.map.height)},destroy:function(){this.stop();for(var a=0;a<this.items.length;a++)this.items[a].destroy&&this.items[a].destroy();this.items=null}};h.TileLayer=function(a,b){this.source=a,b=b||{},this.attribution=b.attribution,this.minZoom=parseFloat(b.minZoom)||0,this.maxZoom=parseFloat(b.maxZoom)||18,this.maxZoom<this.minZoom&&(this.maxZoom=this.minZoom),this.buffer=b.buffer||1,this.shader=new g.Shader({vertexShader:"precision mediump float;attribute vec4 aPosition;attribute vec2 aTexCoord;uniform mat4 uMatrix;varying vec2 vTexCoord;void main() {  gl_Position = uMatrix * aPosition;  vTexCoord = aTexCoord;}",fragmentShader:"precision mediump float;uniform sampler2D uTileImage;varying vec2 vTexCoord;void main() {  gl_FragColor = texture2D(uTileImage, vec2(vTexCoord.x, -vTexCoord.y));}",attributes:["aPosition","aTexCoord"],uniforms:["uMatrix","uTileImage"]}),this.tiles={}},h.TileLayer.prototype={addTo:function(a){this.map=a,this.map.addLayer(this),this.map.on("change",function(){this.update(2e3)}.bind(this)),this.map.on("resize",this.update.bind(this)),this.update()},remove:function(){clearTimeout(this.isWaiting),this.map.removeLayer(this),this.map=null},update:function(a){return this.map.zoom<this.minZoom||this.map.zoom>this.maxZoom?void 0:a?void(this.isWaiting||(this.isWaiting=setTimeout(function(){this.isWaiting=null,this.loadTiles()}.bind(this),a))):void this.loadTiles()},getURL:function(a,b,c){var d={s:"abcd"[(a+b)%4],x:a,y:b,z:c};return this.source.replace(/\{(\w+)\}/g,function(a,b){return d[b]||a})},updateBounds:function(){var a=Math.round(this.map.zoom),b=1500,c=Math.pow(2,a-this.map.zoom)/h.TILE_SIZE,d=this.map.center;this.minX=(d.x-b)*c<<0,this.minY=(d.y-b)*c<<0,this.maxX=Math.ceil((d.x+b)*c),this.maxY=Math.ceil((d.y+b)*c)},loadTiles:function(){this.updateBounds();var a,c,d,e,f=Math.round(this.map.zoom),g=[],i=[this.map.center.x/h.TILE_SIZE<<0,this.map.center.y/h.TILE_SIZE<<0];for(c=this.minY;c<this.maxY;c++)for(a=this.minX;a<this.maxX;a++)d=[a,c,f].join(","),this.tiles[d]||(this.tiles[d]=new h.Tile(a,c,f),g.push({tile:this.tiles[d],dist:b([a,c],i)}));if(e=g.length){g.sort(function(a,b){return a.dist-b.dist});for(var j,k=0;e>k;k++)j=g[k].tile,j.load(this.getURL(j.x,j.y,j.zoom));this.purge()}},purge:function(){for(var a in this.tiles)this.isVisible(this.tiles[a],this.buffer)||(this.tiles[a].destroy(),delete this.tiles[a])},isVisible:function(a,b){b=b||0;var c=a.x,d=a.y,e=Math.round(this.map.zoom);return a.zoom===e&&c>=this.minX-b&&c<=this.maxX+b&&d>=this.minY-b&&d<=this.maxY+b},render:function(a){var b,c,d=this.map.getContext(),e=Math.round(this.map.zoom),f=1/Math.pow(2,e-this.map.zoom),i=this.map.center;this.shader.enable();for(var j in this.tiles)b=this.tiles[j],b.isLoaded&&(c=new g.Matrix,c.scale(1.005*f,1.005*f,1),c.translate(b.x*h.TILE_SIZE*f-i.x,b.y*h.TILE_SIZE*f-i.y,0),d.uniformMatrix4fv(this.shader.uniforms.uMatrix,!1,g.Matrix.multiply(c,a)),b.vertexBuffer.enable(),d.vertexAttribPointer(this.shader.attributes.aPosition,b.vertexBuffer.itemSize,d.FLOAT,!1,0,0),b.texCoordBuffer.enable(),d.vertexAttribPointer(this.shader.attributes.aTexCoord,b.texCoordBuffer.itemSize,d.FLOAT,!1,0,0),b.texture.enable(0),d.uniform1i(this.shader.uniforms.uTileImage,0),d.drawArrays(d.TRIANGLE_STRIP,0,b.vertexBuffer.numItems));
this.shader.disable()},destroy:function(){for(var a in this.tiles)this.tiles[a].destroy();this.tiles=null,this.remove()}},h.Tile=function(a,b,c){this.x=a,this.y=b,this.zoom=c;for(var d=4,e=255/d,f=1/d,h=[],i=[],j=0;d>j;j++)for(var k=0;d>k;k++)h.push((j+1)*e,(k+1)*e,0,(j+1)*e,(k+0)*e,0,(j+0)*e,(k+1)*e,0,(j+0)*e,(k+0)*e,0),i.push((j+1)*f,(k+1)*f,(j+1)*f,(k+0)*f,(j+0)*f,(k+1)*f,(j+0)*f,(k+0)*f);this.vertexBuffer=new g.Buffer(3,new Float32Array(h)),this.texCoordBuffer=new g.Buffer(2,new Float32Array(i))},h.Tile.prototype={load:function(a){this.texture=new g.texture.Image(a,function(a){a&&(this.isLoaded=!0)}.bind(this))},destroy:function(){this.vertexBuffer.destroy(),this.texCoordBuffer.destroy(),this.texture&&this.texture.destroy()}}}(this);var j,k=function(a){var b,c={};return c.setContext=function(a){b=a},c.View=function(a,c,d){var e=x.createElement("CANVAS");e.style.position="absolute",e.width=c,e.height=d,a.appendChild(e);var f={antialias:!0,depth:!0,premultipliedAlpha:!1};try{b=e.getContext("webgl",f)}catch(g){}if(!b)try{b=e.getContext("experimental-webgl",f)}catch(g){}if(!b)throw new Error("WebGL not supported");return e.addEventListener("webglcontextlost",function(a){console.warn("context lost")}),e.addEventListener("webglcontextrestored",function(a){console.warn("context restored")}),b.viewport(0,0,c,d),b.cullFace(b.BACK),b.enable(b.CULL_FACE),b.enable(b.DEPTH_TEST),b.clearColor(.5,.5,.5,1),b},c.start=function(a){return setInterval(function(){requestAnimationFrame(a)},17)},c.stop=function(a){clearInterval(a)},c.destroy=function(a){a.canvas.parentNode.removeChild(a.canvas),a.canvas=null},"function"==typeof define?define([],c):"object"==typeof exports?module.exports=c:a.glx=c,c.util={},c.util.nextPowerOf2=function(a){return a--,a|=a>>1,a|=a>>2,a|=a>>4,a|=a>>8,a|=a>>16,a++,a},c.util.calcNormal=function(a,b,c,d,e,f,g,h,i){var j=a-d,k=b-e,l=c-f,m=d-g,n=e-h,o=f-i,p=k*o-l*n,q=l*m-j*o,r=j*n-k*m;return this.calcUnit(p,q,r)},c.util.calcUnit=function(a,b,c){var d=Math.sqrt(a*a+b*b+c*c);return 0===d&&(d=1e-5),[a/d,b/d,c/d]},c.Buffer=function(a,c){this.id=b.createBuffer(),this.itemSize=a,this.numItems=c.length/a,b.bindBuffer(b.ARRAY_BUFFER,this.id),b.bufferData(b.ARRAY_BUFFER,c,b.STATIC_DRAW),c=null},c.Buffer.prototype={enable:function(){b.bindBuffer(b.ARRAY_BUFFER,this.id)},destroy:function(){b.deleteBuffer(this.id)}},c.Framebuffer=function(a,b){this.setSize(a,b)},c.Framebuffer.prototype={setSize:function(a,d){this.frameBuffer=b.createFramebuffer(),b.bindFramebuffer(b.FRAMEBUFFER,this.frameBuffer),this.width=a,this.height=d;var e=c.util.nextPowerOf2(Math.max(this.width,this.height));if(this.renderBuffer=b.createRenderbuffer(),b.bindRenderbuffer(b.RENDERBUFFER,this.renderBuffer),b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,e,e),this.renderTexture&&this.renderTexture.destroy(),this.renderTexture=new c.texture.Data(e),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,this.renderBuffer),b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,this.renderTexture.id,0),b.checkFramebufferStatus(b.FRAMEBUFFER)!==b.FRAMEBUFFER_COMPLETE)throw new Error("This combination of framebuffer attachments does not work");b.bindRenderbuffer(b.RENDERBUFFER,null),b.bindFramebuffer(b.FRAMEBUFFER,null)},enable:function(){b.bindFramebuffer(b.FRAMEBUFFER,this.frameBuffer),b.bindRenderbuffer(b.RENDERBUFFER,this.renderBuffer)},disable:function(){b.bindFramebuffer(b.FRAMEBUFFER,null),b.bindRenderbuffer(b.RENDERBUFFER,null)},getData:function(){var a=new Uint8Array(this.width*this.height*4);return b.readPixels(0,0,this.width,this.height,b.RGBA,b.UNSIGNED_BYTE,a),a},destroy:function(){this.renderTexture&&this.renderTexture.destroy()}},c.Shader=function(a){if(this.id=b.createProgram(),this.attach(b.VERTEX_SHADER,a.vertexShader),this.attach(b.FRAGMENT_SHADER,a.fragmentShader),b.linkProgram(this.id),!b.getProgramParameter(this.id,b.LINK_STATUS))throw new Error(b.getProgramParameter(this.id,b.VALIDATE_STATUS)+"\n"+b.getError());this.attributeNames=a.attributes,this.uniformNames=a.uniforms},c.Shader.prototype={locateAttribute:function(a){var c=b.getAttribLocation(this.id,a);return 0>c?void console.error('unable to locate attribute "'+a+'" in shader'):(b.enableVertexAttribArray(c),void(this.attributes[a]=c))},locateUniform:function(a){var c=b.getUniformLocation(this.id,a);return 0>c?void console.error('unable to locate uniform "'+a+'" in shader'):void(this.uniforms[a]=c)},attach:function(a,c){var d=b.createShader(a);if(b.shaderSource(d,c),b.compileShader(d),!b.getShaderParameter(d,b.COMPILE_STATUS))throw new Error(b.getShaderInfoLog(d));b.attachShader(this.id,d)},enable:function(){b.useProgram(this.id);var a;if(this.attributeNames)for(this.attributes={},a=0;a<this.attributeNames.length;a++)this.locateAttribute(this.attributeNames[a]);if(this.uniformNames)for(this.uniforms={},a=0;a<this.uniformNames.length;a++)this.locateUniform(this.uniformNames[a]);return this},disable:function(){if(this.attributes)for(var a in this.attributes)b.disableVertexAttribArray(this.attributes[a]);this.attributes=null,this.uniforms=null},destroy:function(){}},c.Matrix=function(a){a?this.data=new Float32Array(a):this.identity()},function(){function a(a){return a*Math.PI/180}function b(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=b[9],n=b[10],o=b[11],p=b[12],q=b[13],r=b[14],s=b[15],t=c[0],u=c[1],v=c[2],w=c[3],x=c[4],y=c[5],z=c[6],A=c[7],B=c[8],C=c[9],D=c[10],E=c[11],F=c[12],G=c[13],H=c[14],I=c[15];a[0]=d*t+e*x+f*B+g*F,a[1]=d*u+e*y+f*C+g*G,a[2]=d*v+e*z+f*D+g*H,a[3]=d*w+e*A+f*E+g*I,a[4]=h*t+i*x+j*B+k*F,a[5]=h*u+i*y+j*C+k*G,a[6]=h*v+i*z+j*D+k*H,a[7]=h*w+i*A+j*E+k*I,a[8]=l*t+m*x+n*B+o*F,a[9]=l*u+m*y+n*C+o*G,a[10]=l*v+m*z+n*D+o*H,a[11]=l*w+m*A+n*E+o*I,a[12]=p*t+q*x+r*B+s*F,a[13]=p*u+q*y+r*C+s*G,a[14]=p*v+q*z+r*D+s*H,a[15]=p*w+q*A+r*E+s*I}c.Matrix.prototype={identity:function(){return this.data=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this},multiply:function(a){return b(this.data,this.data,a.data),this},translate:function(a,c,d){return b(this.data,this.data,[1,0,0,0,0,1,0,0,0,0,1,0,a,c,d,1]),this},rotateX:function(c){var d=a(c),e=Math.cos(d),f=Math.sin(d);return b(this.data,this.data,[1,0,0,0,0,e,f,0,0,-f,e,0,0,0,0,1]),this},rotateY:function(c){var d=a(c),e=Math.cos(d),f=Math.sin(d);return b(this.data,this.data,[e,0,-f,0,0,1,0,0,f,0,e,0,0,0,0,1]),this},rotateZ:function(c){var d=a(c),e=Math.cos(d),f=Math.sin(d);return b(this.data,this.data,[e,-f,0,0,f,e,0,0,0,0,1,0,0,0,0,1]),this},scale:function(a,c,d){return b(this.data,this.data,[a,0,0,0,0,c,0,0,0,0,d,0,0,0,0,1]),this}},c.Matrix.multiply=function(a,c){var d=new Float32Array(16);return b(d,a.data,c.data),d},c.Matrix.Perspective=function(a,b,d,e){var f=1/Math.tan(a*(Math.PI/180)/2),g=1/(d-e);return new c.Matrix([f/b,0,0,0,0,f,0,0,0,0,(e+d)*g,-1,0,0,2*e*d*g,0])},c.Matrix.invert3=function(a){var b=a[0],c=a[1],d=a[2],e=a[4],f=a[5],g=a[6],h=a[8],i=a[9],j=a[10],k=j*f-g*i,l=-j*e+g*h,m=i*e-f*h,n=b*k+c*l+d*m;return n?(n=1/n,[k*n,(-j*c+d*i)*n,(g*c-d*f)*n,l*n,(j*b-d*h)*n,(-g*b+d*e)*n,m*n,(-i*b+c*h)*n,(f*b-c*e)*n]):null},c.Matrix.transpose=function(a){return new Float32Array([a[0],a[3],a[6],a[1],a[4],a[7],a[2],a[5],a[8]])},c.Matrix.transform=function(a){var b=a[12],c=a[13],d=a[14],e=a[15];return{x:(b/e+1)/2,y:(c/e+1)/2,z:(d/e+1)/2}},c.Matrix.invert=function(a){var b=new Float32Array(16),c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=s*D-t*C+u*B+v*A-w*z+x*y;if(E)return E=1/E,b[0]=(h*D-i*C+j*B)*E,b[1]=(e*C-d*D-f*B)*E,b[2]=(p*x-q*w+r*v)*E,b[3]=(m*w-l*x-n*v)*E,b[4]=(i*A-g*D-j*z)*E,b[5]=(c*D-e*A+f*z)*E,b[6]=(q*u-o*x-r*t)*E,b[7]=(k*x-m*u+n*t)*E,b[8]=(g*C-h*A+j*y)*E,b[9]=(d*A-c*C-f*y)*E,b[10]=(o*w-p*u+r*s)*E,b[11]=(l*u-k*w-n*s)*E,b[12]=(h*z-g*B-i*y)*E,b[13]=(c*B-d*z+e*y)*E,b[14]=(p*t-o*v-q*s)*E,b[15]=(k*v-l*t+m*s)*E,b}}(),c.texture={},c.texture.Image=function(a,c){this.id=b.createTexture(),b.bindTexture(b.TEXTURE_2D,this.id),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR_MIPMAP_NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0),b.bindTexture(b.TEXTURE_2D,null);var d=new Image;d.crossOrigin="*",d.onload=function(){var a=b.getParameter(b.MAX_TEXTURE_SIZE);if(d.width>a||d.height>a){var e=a,f=a,g=d.width/d.height;1>g?e=Math.round(f*g):f=Math.round(e/g);var h=x.createElement("CANVAS");h.width=e,h.height=f;var i=h.getContext("2d");i.drawImage(d,0,0,h.width,h.height),d=h}this.id?(b.bindTexture(b.TEXTURE_2D,this.id),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,d),b.generateMipmap(b.TEXTURE_2D),b.bindTexture(b.TEXTURE_2D,null)):d=null,c&&c(d)}.bind(this),d.onerror=function(){c&&c()},d.src=a},c.texture.Image.prototype={enable:function(a){this.id&&(b.bindTexture(b.TEXTURE_2D,this.id),b.activeTexture(b.TEXTURE0+(a||0)))},disable:function(){b.bindTexture(b.TEXTURE_2D,null)},destroy:function(){b.bindTexture(b.TEXTURE_2D,null),b.deleteTexture(this.id),this.id=null}},c.texture.Data=function(a,c,d){this.id=b.createTexture(),b.bindTexture(b.TEXTURE_2D,this.id),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);var e=null;if(c){var f=a*a*4;e=new Uint8Array(f),e.set(c.subarray(0,f))}b.texImage2D(b.TEXTURE_2D,0,b.RGBA,a,a,0,b.RGBA,b.UNSIGNED_BYTE,e),b.bindTexture(b.TEXTURE_2D,null)},c.texture.Data.prototype={enable:function(a){b.bindTexture(b.TEXTURE_2D,this.id),b.activeTexture(b.TEXTURE0+(a||0))},disable:function(){b.bindTexture(b.TEXTURE_2D,null)},destroy:function(){b.bindTexture(b.TEXTURE_2D,null),b.deleteTexture(this.id)}},c.mesh={},c.mesh.addQuad=function(a,b,c,d,e,f){this.addTriangle(a,b,c,d,f),this.addTriangle(a,d,e,b,f)},c.mesh.addTriangle=function(a,b,d,e,f){a.vertices.push(b[0],b[1],b[2],d[0],d[1],d[2],e[0],e[1],e[2]);var g=c.util.calcNormal(b[0],b[1],b[2],d[0],d[1],d[2],e[0],e[1],e[2]);a.normals.push(g[0],g[1],g[2],g[0],g[1],g[2],g[0],g[1],g[2]),a.colors.push(f[0],f[1],f[2],f[3],f[0],f[1],f[2],f[3],f[0],f[1],f[2],f[3])},c.mesh.Triangle=function(a,b){var d={vertices:[],normals:[],colors:[]},e=[-a/2,-a/2,0],f=[a/2,-a/2,0],g=[a/2,a/2,0];c.mesh.addTriangle(d,e,f,g,b),this.vertexBuffer=new c.Buffer(3,new Float32Array(d.vertices)),this.normalBuffer=new c.Buffer(3,new Float32Array(d.normals)),this.colorBuffer=new c.Buffer(4,new Float32Array(d.colors)),this.transform=new c.Matrix},c.mesh.Plane=function(a,b){var d={vertices:[],normals:[],colors:[]},e=[-a/2,-a/2,0],f=[a/2,-a/2,0],g=[a/2,a/2,0],h=[-a/2,a/2,0];c.mesh.addQuad(d,e,f,g,h,b),this.vertexBuffer=new c.Buffer(3,new Float32Array(d.vertices)),this.normalBuffer=new c.Buffer(3,new Float32Array(d.normals)),this.colorBuffer=new c.Buffer(4,new Float32Array(d.colors)),this.transform=new c.Matrix},c.mesh.Cube=function(a,b){var d={vertices:[],normals:[],colors:[]},e=[-a/2,-a/2,-a/2],f=[a/2,-a/2,-a/2],g=[a/2,a/2,-a/2],h=[-a/2,a/2,-a/2],i=[-a/2,-a/2,a/2],j=[a/2,-a/2,a/2],k=[a/2,a/2,a/2],l=[-a/2,a/2,a/2];c.mesh.addQuad(d,e,f,g,h,b),c.mesh.addQuad(d,i,j,k,l,b),c.mesh.addQuad(d,e,f,j,i,b),c.mesh.addQuad(d,f,g,k,j,b),c.mesh.addQuad(d,g,h,l,k,b),c.mesh.addQuad(d,h,e,i,l,b),this.vertexBuffer=new c.Buffer(3,new Float32Array(d.vertices)),this.normalBuffer=new c.Buffer(3,new Float32Array(d.normals)),this.colorBuffer=new c.Buffer(4,new Float32Array(d.colors)),this.transform=new c.Matrix},c}(this),l=function(a){a=a||{},a.style&&this.setStyle(a.style),this.fogColor=a.fogColor?i.parse(a.fogColor).toRGBA(!0):w,this.showBackfaces=a.showBackfaces};l.VERSION="1.0.0",l.ATTRIBUTION="© OSM Buildings (http://osmbuildings.org)",l.prototype={attribution:l.ATTRIBUTION,addTo:function(a){return j=a,j.addLayer(this),k.setContext(j.getContext()),J.initShader(),K.initShader({fogColor:this.fogColor}),L.initShader({showBackfaces:this.showBackfaces,fogColor:this.fogColor}),this},render:function(a){var b=j.getContext();b.cullFace(b.BACK),b.enable(b.CULL_FACE),b.enable(b.DEPTH_TEST),K.render(a),L.render(a)},setStyle:function(a){var b=a.color||a.wallColor;return b&&(u=i.parse(b).toRGBA(!0)),this},addOBJ:function(a,b,c){return new G.OBJ(a,b,c)},addGeoJSON:function(a,b){return new G.GeoJSON(a,b)},addGeoJSONTiles:function(a,b){E.setSource(a,b.dataKey||q)},highlight:function(a,b){L.highlightColor=b?a&&i.parse(b).toRGBA(!0):null,L.highlightID=a?J.idToColor(a):null},getTarget:function(a,b,c){J.getTargetID(a,b,c)},destroy:function(){J.destroy(),K.destroy(),L.destroy(),E.destroy()}},"function"==typeof a.define?a.define([],l):"object"==typeof a.exports?a.module.exports=l:a.OSMBuildingsGL=l;var m={};!function(){var a={};m.on=function(b,c){a[b]||(a[b]={fn:[]}),a[b].fn.push(c)},m.off=function(a,b){},m.emit=function(b,c){if(a[b]){var d=a[b];d.timer||(d.timer=setTimeout(function(){d.timer=null;for(var a=0,b=d.fn.length;b>a;a++)d.fn[a](c)},17))}},m.destroy=function(){a=null}}();var n={};!function(){var a,b=0;n.setBusy=function(c){b||(a?(clearTimeout(a),a=null):m.emit("busy")),b++},n.setIdle=function(c){b&&(b--,b||(a=setTimeout(function(){a=null,m.emit("idle")},33)))},n.isBusy=function(){return!!b}}();var o=(Math.PI,15),p=256,q="anonymous",r="http://{s}.data.osmbuildings.org/0.2/{k}/tile/{z}/{x}/{y}.json",s=10,t=.7,u=i.parse("rgb(220, 210, 200)").toRGBA(!0),v=i.parse("#f08000").toRGBA(!0),w=i.parse("#f0f8ff").toRGBA(!0),x=a.document,y=6378137,z=y*Math.PI*2,A={};!function(){function a(a,c){if(b[a])return b[a];var d=new XMLHttpRequest;return d.onreadystatechange=function(){4===d.readyState&&(delete b[a],!d.status||d.status<200||d.status>299||c(d))},b[a]=d,d.open("GET",a),d.send(null),{abort:function(){b[a]&&(d.abort(),delete b[a])}}}var b={};A.getText=function(b,c){return a(b,function(a){void 0!==a.responseText&&c(a.responseText)})},A.getXML=function(b,c){return a(b,function(a){void 0!==a.responseXML&&c(a.responseXML)})},A.getJSON=function(b,c){return a(b,function(a){if(a.responseText){var d;try{d=JSON.parse(a.responseText)}catch(e){console.warn("Could not parse JSON from "+b+"\n"+e.message)}c(d)}})},A.abortAll=function(){for(var a in b)b[a].abort();b={}},A.destroy=function(){this.abortAll(),b=null}}();var B={interaction:{vertex:"#ifdef GL_ES\n  precision mediump float;\n#endif\nattribute vec4 aPosition;\nattribute vec3 aColor;\nuniform mat4 uMMatrix;\nuniform mat4 uMatrix;\nuniform float uFogRadius;\nvarying vec4 vColor;\nvoid main() {\n  gl_Position = uMatrix * aPosition;\n  vec4 mPosition = vec4(uMMatrix * aPosition);\n  float distance = length(mPosition);\n  if (distance > uFogRadius) {\n    vColor = vec4(0.0, 0.0, 0.0, 0.0);\n  } else {\n    vColor = vec4(aColor, 1.0);\n  }\n}\n",fragment:"#ifdef GL_ES\n  precision mediump float;\n#endif\nvarying vec4 vColor;\nvoid main() {\n  gl_FragColor = vColor;\n}\n"},skydome:{vertex:"#ifdef GL_ES\n  precision mediump float;\n#endif\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMatrix;\nvarying vec2 vTexCoord;\nvarying float vFogIntensity;\nfloat gradientHeight = 10.0;\nfloat gradientStrength = 1.0;\nvoid main() {\n  gl_Position = uMatrix * aPosition;\n  vTexCoord = aTexCoord;\n  vFogIntensity = clamp((gradientHeight-aPosition.z) / (gradientHeight/gradientStrength), 0.0, gradientStrength);\n}\n",fragment:"#ifdef GL_ES\n  precision mediump float;\n#endif\nuniform sampler2D uTileImage;\nuniform vec3 uFogColor;\nvarying vec2 vTexCoord;\nvarying float vFogIntensity;\nvoid main() {\n  vec3 color = vec3(texture2D(uTileImage, vec2(vTexCoord.x, -vTexCoord.y)));\n  gl_FragColor = vec4(mix(color, uFogColor, vFogIntensity), 1.0);\n}\n"},buildings:{vertex:"#ifdef GL_ES\n  precision mediump float;\n#endif\nattribute vec4 aPosition;\nattribute vec3 aNormal;\nattribute vec3 aColor;\nattribute vec3 aIDColor;\nuniform mat4 uMatrix;\nuniform mat4 uMMatrix;\nuniform mat3 uNormalTransform;\nuniform vec3 uLightDirection;\nuniform vec3 uLightColor;\nuniform vec3 uFogColor;\nuniform float uFogRadius;\nuniform vec3 uHighlightColor;\nuniform vec3 uHighlightID;\nvarying vec3 vColor;\nfloat fogBlur = 200.0;\nfloat gradientHeight = 90.0;\nfloat gradientStrength = 0.4;\nvoid main() {\n  vec4 glPosition = uMatrix * aPosition;\n  gl_Position = glPosition;\n  //*** highlight object ******************************************************\n  vec3 color = aColor;\n  if (uHighlightID.r == aIDColor.r && uHighlightID.g == aIDColor.g && uHighlightID.b == aIDColor.b) {\n    color = mix(aColor, uHighlightColor, 0.5);\n  }\n  //*** light intensity, defined by light direction on surface ****************\n  vec3 transformedNormal = aNormal * uNormalTransform;\n  float lightIntensity = max( dot(transformedNormal, uLightDirection), 0.0) / 1.5;\n  color = color + uLightColor * lightIntensity;\n  //*** vertical shading ******************************************************\n  float verticalShading = clamp((gradientHeight-aPosition.z) / (gradientHeight/gradientStrength), 0.0, gradientStrength);\n  //*** fog *******************************************************************\n  vec4 mPosition = uMMatrix * aPosition;\n  float distance = length(mPosition);\n  float fogIntensity = (distance - uFogRadius) / fogBlur + 1.1; // <- shifts blur in/out\n  fogIntensity = clamp(fogIntensity, 0.0, 1.0);\n  //***************************************************************************\n  vColor = mix(vec3(color - verticalShading), uFogColor, fogIntensity);\n}\n",fragment:"#ifdef GL_ES\n  precision mediump float;\n#endif\nvarying vec3 vColor;\nvoid main() {\n  gl_FragColor = vec4(vColor, 1.0);\n}\n"}},C={};!function(){function a(a,b,c){var d=a[0]-b[0],e=a[1]-b[1],f=a[2]-b[2],h=b[0]-c[0],i=b[1]-c[1],j=b[2]-c[2],k=e*j-f*i,l=f*h-d*j,m=d*i-e*h,n=g(k,l,m);return 0===Math.round(5e3*n[2])}var b=16,c=24;C.quad=function(a,b,c,d,e){return this.addTriangle(a,b,c,d),this.addTriangle(a,c,e,d),6},C.circle=function(a,b,d,e){for(var f,g,h=0;c>h;h++)f=h/c,g=(h+1)/c,this.addTriangle(a,[b[0]+d*Math.sin(f*Math.PI*2),b[1]+d*Math.cos(f*Math.PI*2),e],[b[0],b[1],e],[b[0]+d*Math.sin(g*Math.PI*2),b[1]+d*Math.cos(g*Math.PI*2),e]);return 3*c},C.polygon=function(a,b,c){for(var d=h(b),e=0,f=d.length-2;f>e;e+=3)this.addTriangle(a,[d[e][0],d[e][1],c],[d[e+1][0],d[e+1][1],c],[d[e+2][0],d[e+2][1],c]);return d.length},C.polygon3d=function(b,c){var d,e,f,g=c[0],i=g.length;if(4>=i){var j=0;return j+=this.addTriangle(b,g[0],g[2],g[1]),4===i&&(j+=this.addTriangle(b,g[0],g[3],g[2])),j}if(a(g[0],g[1],g[2])){for(var k=0,l=c[0].length;l>k;k++)c[0][k]=[c[0][k][2],c[0][k][1],c[0][k][0]];for(d=h(c),e=0,f=d.length-2;f>e;e+=3)this.addTriangle(b,[d[e][2],d[e][1],d[e][0]],[d[e+1][2],d[e+1][1],d[e+1][0]],[d[e+2][2],d[e+2][1],d[e+2][0]]);return d.length}for(d=h(c),e=0,f=d.length-2;f>e;e+=3)this.addTriangle(b,[d[e][0],d[e][1],d[e][2]],[d[e+1][0],d[e+1][1],d[e+1][2]],[d[e+2][0],d[e+2][1],d[e+2][2]]);return d.length},C.cylinder=function(a,b,d,e,f,g){for(var h,i,j,k,l,m,n=0,o=c,p=2*Math.PI,q=0;o>q;q++)h=q/o*p,i=(q+1)/o*p,j=Math.sin(h),k=Math.cos(h),l=Math.sin(i),m=Math.cos(i),n+=this.addTriangle(a,[b[0]+d*j,b[1]+d*k,f],[b[0]+e*l,b[1]+e*m,g],[b[0]+d*l,b[1]+d*m,f]),0!==e&&(n+=this.addTriangle(a,[b[0]+e*j,b[1]+e*k,g],[b[0]+e*l,b[1]+e*m,g],[b[0]+d*j,b[1]+d*k,f]));return n},C.dome=function(a,c,d,e,f){for(var g,h,i,j,k,l,m,n,o,p,q=0,r=f-e,s=b/2,t=Math.PI/2,u=0;s>u;u++)g=u/s*t-t,h=(u+1)/s*t-t,i=Math.sin(g),j=Math.cos(g),k=Math.sin(h),l=Math.cos(h),m=j*d,n=l*d,o=e-i*r,p=e-k*r,q+=this.cylinder(a,c,n,m,p,o);return q},C.pyramid=function(a,b,c,d,e){b=b[0];for(var f=0,g=0,h=b.length-1;h>g;g++)f+=this.addTriangle(a,[b[g][0],b[g][1],d],[b[g+1][0],b[g+1][1],d],[c[0],c[1],e]);return f},C.extrusion=function(a,b,c,d){for(var e,f,g,h,i,j,k=0,l=0,m=b.length;m>l;l++){e=b[l],f=e.length-1,(e[0][0]!==e[f][0]||e[0][1]!==e[f][1])&&(e.push(e[0]),f++);for(var n=0;f>n;n++)g=e[n],h=e[n+1],i=c,j=d,k+=this.quad(a,[g[0],g[1],i],[h[0],h[1],i],[g[0],g[1],j],[h[0],h[1],j])}return k},C.addTriangle=function(a,b,c,d){a.vertices.push(b[0],b[1],b[2],d[0],d[1],d[2],c[0],c[1],c[2]);var e=f(b[0],b[1],b[2],c[0],c[1],c[2],d[0],d[1],d[2]);return a.normals.push(e[0],e[1],e[2],e[0],e[1],e[2],e[0],e[1],e[2]),3}}();var D={Index:{items:[],add:function(a){this.items.push(a)},remove:function(a){for(var b=this.items,c=0,d=b.length;d>c;c++)if(b[c]===a)return void b.splice(c,1)},destroy:function(){this.items=null}}},E={};!function(){function a(a){return a?(k&&clearTimeout(k),void(k=setTimeout(function(){k=null,d()},a))):void d()}function b(){l=Math.round(v||j.zoom);var a=K.radius,b=Math.pow(2,l-j.zoom)/p,c=j.center;n=(c.x-a)*b<<0,q=(c.y-a)*b<<0,s=Math.ceil((c.x+a)*b),t=Math.ceil((c.y+a)*b)}function d(){if(!(j.zoom<o)){b();var a,c,d,g,i=[],k=[j.center.x/p<<0,j.center.y/p<<0];for(c=q;t>c;c++)for(a=n;s>a;a++)d=[a,c,l].join(","),u[d]||(u[d]=new F(a,c,l),i.push({tile:u[d],dist:e([a,c],k)}));if(g=i.length){i.sort(function(a,b){return a.dist-b.dist});for(var m,r=0;g>r;r++)m=i[r].tile,m.load(h(m.tileX,m.tileY,m.zoom));f()}}}function f(){for(var a in u)g(u[a],1)||(u[a].destroy(),delete u[a])}function g(a,b){b=b||0;var c=a.tileX,d=a.tileY;return a.zoom===l&&c>=n-b&&s+b>=c&&d>=q-b&&t+b>=d}function h(a,b,d){var e="abcd"[(a+b)%4];return c(i,{s:e,x:a,y:b,z:d})}var i,k,l,n,q,s,t,u={},v=16;E.setSource=function(b,c){(void 0===b||b===!1||""===b)&&(b=r.replace("{k}",c)),b&&(i=b,m.on("change",function(){a(2e3)}),m.on("resize",a),a())},E.destroy=function(){clearTimeout(k);for(var a in u)u[a].destroy();u=null}}();var F=function(a,b,c){this.tileX=a,this.tileY=b,this.zoom=c};F.prototype={load:function(a){this.mesh=new G.GeoJSON(a)},destroy:function(){this.mesh&&(this.mesh.destroy(),this.mesh=null)}};var G={};G.GeoJSON=function(){function a(a,b){var c=a.geometry[0],d=c.length;if(16>d)return!1;var f=a.max.x-a.min.x,g=a.max.y-a.min.y,h=f/g;if(.85>h||h>1.15)return!1;for(var i,j=(f+g)/4,k=j*j,l=0;d>l;l++)if(i=e(c[l],b),.75>i/k||i/k>1.25)return!1;return!0}function c(a,b){if(b=b||{},this.id=b.id,b.color&&(this.color=i.parse(b.color).toRGBA(!0)),this.replace=!!b.replace,this.scale=b.scale||1,this.rotation=b.rotation||0,this.elevation=b.elevation||0,this.position={},this.data={vertices:[],normals:[],colors:[],idColors:[]},n.setBusy(),"object"==typeof a){var c=a;this.onLoad(c)}else this.request=A.getJSON(a,function(a){this.request=null,this.onLoad(a)}.bind(this))}var f=16,g=p<<f,h=150,l=66;return c.prototype={onLoad:function(a){if(a&&a.features.length){var b=a.features[0].geometry.coordinates[0][0];this.position={latitude:b[1],longitude:b[0]},this.items=[],d(function(b,c){var d=a.features.slice(b,c),e={type:"FeatureCollection",features:d},f=H.parse(this.position,g,e);this.addItems(f),c===a.features.length&&this.onReady()}.bind(this),0,a.features.length,h,l)}},addItems:function(b){for(var c,d,e,f,g,h,i,j=0,k=b.length;k>j;j++){switch(c=b[j],e=J.idToColor(this.id||c.id),f=[c.min.x+(c.max.x-c.min.x)/2,c.min.y+(c.max.y-c.min.y)/2],!c.shape&&a(c,f)&&(c.shape="cylinder",c.isRotational=!0),c.isRotational&&(g=(c.max.x-c.min.x)/2),c.shape){case"cylinder":h=C.cylinder(this.data,f,g,g,c.minHeight,c.height);break;case"cone":h=C.cylinder(this.data,f,g,0,c.minHeight,c.height);break;case"dome":h=C.dome(this.data,f,g,c.minHeight,c.height);break;case"sphere":h=C.cylinder(this.data,f,g,g,c.minHeight,c.height);break;case"pyramid":h=C.pyramid(this.data,c.geometry,f,c.minHeight,c.height);break;default:h=C.extrusion(this.data,c.geometry,c.minHeight,c.height)}for(d=this.color||c.wallColor||u,i=0;h>i;i++)this.data.colors.push(d.r,d.g,d.b),this.data.idColors.push(e.r,e.g,e.b);switch(c.roofShape){case"cone":h=C.cylinder(this.data,f,g,0,c.height,c.height+c.roofHeight);break;case"dome":h=C.dome(this.data,f,g,c.height,c.height+(c.roofHeight||g));break;case"pyramid":h=C.pyramid(this.data,c.geometry,f,c.height,c.height+c.roofHeight);break;default:"cylinder"===c.shape?h=C.circle(this.data,f,g,c.height):void 0===c.shape&&(h=C.polygon(this.data,c.geometry,c.height))}for(d=this.color||c.roofColor||u,i=0;h>i;i++)this.data.colors.push(d.r,d.g,d.b),this.data.idColors.push(e.r,e.g,e.b)}},onReady:function(){this.vertexBuffer=new k.Buffer(3,new Float32Array(this.data.vertices)),this.normalBuffer=new k.Buffer(3,new Float32Array(this.data.normals)),this.colorBuffer=new k.Buffer(3,new Float32Array(this.data.colors)),this.idColorBuffer=new k.Buffer(3,new Float32Array(this.data.idColors)),this.data=null,D.Index.add(this),this.isReady=!0,n.setIdle()},getMatrix:function(){var a=new k.Matrix;this.elevation&&a.translate(0,0,this.elevation);var c=1/Math.pow(2,f-j.zoom)*this.scale;a.scale(c,c,c*t),this.rotation&&a.rotateZ(-this.rotation);var d=b(this.position.latitude,this.position.longitude,p*Math.pow(2,j.zoom)),e=j.center;return a.translate(d.x-e.x,d.y-e.y,0),a},destroy:function(){this.request&&this.request.abort(),this.items=null,this.isReady&&(D.Index.remove(this),this.vertexBuffer.destroy(),this.normalBuffer.destroy(),this.colorBuffer.destroy(),this.idColorBuffer.destroy())}},c}(),G.OBJ=function(){function a(a,b,c){c=c||{},this.id=c.id,c.color&&(this.color=i.parse(c.color).toRGBA(!0)),this.replace=!!c.replace,this.scale=c.scale||1,this.rotation=c.rotation||0,this.elevation=c.elevation||0,this.position=b,this.inMeters=p/(Math.cos(this.position.latitude*Math.PI/180)*z),this.data={vertices:[],normals:[],colors:[],idColors:[]},n.setBusy(),this.request=A.getText(a,function(b){this.request=null;var c;(c=b.match(/^mtllib\s+(.*)$/m))?this.request=A.getText(a.replace(/[^\/]+$/,"")+c[1],function(a){this.request=null,this.onLoad(b,a)}.bind(this)):this.onLoad(b,null)}.bind(this))}return a.prototype={onLoad:function(a,b){var c=new I.parse(a,b);this.items=[],this.addItems(c),this.onReady()},addItems:function(a){for(var b,c,d,e,f,g=0,h=a.length;h>g;g++)for(b=a[g],this.data.vertices.push.apply(this.data.vertices,b.vertices),this.data.normals.push.apply(this.data.normals,b.normals),c=this.color||b.color||u,d=J.idToColor(this.id||b.id),e=0,f=b.vertices.length-2;f>e;e+=3)this.data.colors.push(c.r,c.g,c.b),this.data.idColors.push(d.r,d.g,d.b)},onReady:function(){this.vertexBuffer=new k.Buffer(3,new Float32Array(this.data.vertices)),this.normalBuffer=new k.Buffer(3,new Float32Array(this.data.normals)),this.colorBuffer=new k.Buffer(3,new Float32Array(this.data.colors)),this.idColorBuffer=new k.Buffer(3,new Float32Array(this.data.idColors)),this.data=null,D.Index.add(this),this.isReady=!0,n.setIdle()},getMatrix:function(){var a=new k.Matrix;this.elevation&&a.translate(0,0,this.elevation);var c=Math.pow(2,j.zoom)*this.inMeters*this.scale;a.scale(c,c,c),this.rotation&&a.rotateZ(-this.rotation);var d=b(this.position.latitude,this.position.longitude,p*Math.pow(2,j.zoom)),e=j.center;return a.translate(d.x-e.x,d.y-e.y,0),a},destroy:function(){this.request&&this.request.abort(),this.items=null,this.isReady&&(D.Index.remove(this),this.vertexBuffer.destroy(),this.normalBuffer.destroy(),this.colorBuffer.destroy(),this.idColorBuffer.destroy())}},a}();var H={};!function(){function a(a){return a=a.toLowerCase(),"#"===a[0]?a:h[j[a]||a]||null}function c(b,c,e,h){var j,k,l,m=c.properties,n={};if(m){switch(n.height=m.height||(m.levels?m.levels*g:s),n.minHeight=m.minHeight||(m.minLevel?m.minLevel*g:0),k=m.material?a(m.material):m.wallColor||m.color,n.wallColor=(j=i.parse(k))?j.toRGBA(!0):u,l=m.roofMaterial?a(m.roofMaterial):m.roofColor,n.roofColor=(j=i.parse(l))?j.toRGBA(!0):u,m.shape){case"cylinder":case"cone":case"dome":case"sphere":n.shape=m.shape,n.isRotational=!0;break;case"pyramid":n.shape=m.shape}switch(m.roofShape){case"cone":case"dome":n.roofShape=m.roofShape,n.isRotational=!0;break;case"pyramid":n.roofShape=m.roofShape}n.roofShape&&m.roofHeight?(n.roofHeight=m.roofHeight,n.height=Math.max(0,n.height-n.roofHeight)):n.roofHeight=0,n.id=m.relationId||c.id||m.id;for(var o,p=d(c.geometry,e,h),q=Object.create(n),r=0,t=p.length;t>r;r++)q.geometry=p[r],o=f(p[r][0]),q.min=o.min,q.max=o.max,b.push(q)}}function d(a,b,c){var f,g,h,i;switch(a.type){case"GeometryCollection":var j=[];for(f=0,g=a.geometries.length;g>f;f++)(i=d(a.geometries[f]))&&j.push.apply(j,i);return j;case"MultiPolygon":var k=[];for(f=0,g=a.coordinates.length;g>f;f++)(i=d({type:"Polygon",coordinates:a.coordinates[f]}))&&k.push.apply(j,i);return k;case"Polygon":h=a.coordinates;break;default:return[]}var l=[];for(f=0,g=h.length;g>f;f++)l[f]=e(h[f],b,c);return[l]}function e(a,c,d){for(var e,f=[],g=0,h=a.length;h>g;g++)e=b(a[g][1],a[g][0],d),f[g]=[e.x-c.x,e.y-c.y];return f}function f(a){for(var b=1/0,c=1/0,d=-(1/0),e=-(1/0),f=0;f<a.length;f++)b=Math.min(b,a[f][0]),c=Math.min(c,a[f][1]),d=Math.max(d,a[f][0]),e=Math.max(e,a[f][1]);return{min:{x:b,y:c},max:{x:d,y:e}}}var g=3,h={brick:"#cc7755",bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",glass:"#e8f8f8",gold:"#ffcc00",plants:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},j={asphalt:"tar_paper",bitumen:"tar_paper",block:"stone",bricks:"brick",glas:"glass",glassfront:"glass",grass:"plants",masonry:"stone",granite:"stone",panels:"panel",paving_stones:"stone",plastered:"plaster",rooftiles:"roof_tiles",roofingfelt:"tar_paper",sandstone:"stone",sheet:"canvas",sheets:"canvas",shingle:"tar_paper",shingles:"tar_paper",slates:"slate",steel:"metal",tar:"tar_paper",tent:"canvas",thatch:"plants",tile:"roof_tiles",tiles:"roof_tiles"};H.parse=function(a,d,e){var f=[];if(e&&"FeatureCollection"===e.type&&e.features.length)for(var g=e.features,h=b(a.latitude,a.longitude,d),i=0,j=g.length;j>i;i++)c(f,g[i],h,d);return f}}();var I=function(){this.vertexIndex=[]};"undefined"!=typeof module&&(module.exports=I),I.prototype={parseMaterials:function(a){var b,c,d,e=a.split(/[\r\n]/g),f={},g=null;for(c=0,d=e.length;d>c;c++)switch(b=e[c].trim().split(/\s+/),b[0]){case"newmtl":this.storeMaterial(f,g),g={id:b[1],color:{}};break;case"Kd":g.color.r=parseFloat(b[1]),g.color.g=parseFloat(b[2]),g.color.b=parseFloat(b[3]);break;case"d":g.color.a=parseFloat(b[1])}return this.storeMaterial(f,g),a=null,f},storeMaterial:function(a,b){null!==b&&(a[b.id]=b.color)},parseModel:function(a,b){var c,d,e,f,g,h=a.split(/[\r\n]/g),i=[],j=[];for(d=0,e=h.length;e>d;d++)switch(c=h[d].trim().split(/\s+/),c[0]){case"g":case"o":this.storeMesh(i,f,g,j),f=c[1],j=[];break;case"usemtl":this.storeMesh(i,f,g,j),b[c[1]]&&(g=b[c[1]]),j=[];break;case"v":this.vertexIndex.push([parseFloat(c[1]),parseFloat(c[2]),parseFloat(c[3])]);break;case"f":j.push([parseFloat(c[1])-1,parseFloat(c[2])-1,parseFloat(c[3])-1])}return this.storeMesh(i,f,g,j),a=null,i},storeMesh:function(a,b,c,d){if(d.length){var e=this.createGeometry(d);a.push({id:b,color:c,vertices:e.vertices,normals:e.normals,min:e.min,max:e.max})}},createGeometry:function(a){for(var b,c,d,e,f,g,h,i=1/0,j=1/0,k=1/0,l=-(1/0),m=-(1/0),n=-(1/0),o={vertices:[],normals:[]},p=0,q=a.length;q>p;p++)b=this.vertexIndex[a[p][0]],c=this.vertexIndex[a[p][1]],d=this.vertexIndex[a[p][2]],i=Math.min(i,b[0],c[0],d[0]),j=Math.min(i,b[2],c[2],d[2]),k=Math.min(i,b[1],c[1],d[1]),l=Math.max(l,b[0],c[0],d[0]),m=Math.max(m,b[2],c[2],d[2]),n=Math.max(n,b[1],c[1],d[1]),e=[c[0]-b[0],c[1]-b[1],c[2]-b[2]],f=[d[0]-b[0],d[1]-b[1],d[2]-b[2]],g=[e[1]*f[2]-e[2]*f[1],e[2]*f[0]-e[0]*f[2],e[0]*f[1]-e[1]*f[0]],h=Math.sqrt(g[0]*g[0]+g[1]*g[1]+g[2]*g[2]),g[0]/=h,g[1]/=h,g[2]/=h,o.vertices.push(b[0],b[2],b[1],c[0],c[2],c[1],d[0],d[2],d[1]),o.normals.push(g[0],g[1],g[2],g[0],g[1],g[2],g[0],g[1],g[2]);return o.min={x:i,y:j,z:k},o.max={x:l,y:m,z:n},o}},I.parse=function(a,b){var c=new I,d=b?c.parseMaterials(b):{};return c.parseModel(a,d)};var J={idMapping:[null],viewportSize:512,initShader:function(){return this.shader=new k.Shader({vertexShader:B.interaction.vertex,fragmentShader:B.interaction.fragment,attributes:["aPosition","aColor"],uniforms:["uMMatrix","uMatrix","uFogRadius"]}),this.framebuffer=new k.Framebuffer(this.viewportSize,this.viewportSize),this},getTargetID:function(a,b,c){if(!(j.zoom<o)){var d=j.getContext(),e=new k.Matrix(k.Matrix.multiply(j.transform,j.perspective)),f=this.shader,g=this.framebuffer;
d.viewport(0,0,this.viewportSize,this.viewportSize),f.enable(),g.enable(),d.clearColor(0,0,0,1),d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT),d.uniform1f(f.uniforms.uFogRadius,K.radius);for(var h,i,l,m=D.Index.items,n=0,p=m.length;p>n;n++)h=m[n],(i=h.getMatrix())&&(d.uniformMatrix4fv(f.uniforms.uMMatrix,!1,i.data),l=k.Matrix.multiply(i,e),d.uniformMatrix4fv(f.uniforms.uMatrix,!1,l),h.vertexBuffer.enable(),d.vertexAttribPointer(f.attributes.aPosition,h.vertexBuffer.itemSize,d.FLOAT,!1,0,0),h.idColorBuffer.enable(),d.vertexAttribPointer(f.attributes.aColor,h.idColorBuffer.itemSize,d.FLOAT,!1,0,0),d.drawArrays(d.TRIANGLES,0,h.vertexBuffer.numItems));var q=g.getData();f.disable(),g.disable(),d.viewport(0,0,j.width,j.height),a=a/j.width*this.viewportSize<<0,b=b/j.height*this.viewportSize<<0;var r=4*((this.viewportSize-b)*this.viewportSize+a),s=q[r]|q[r+1]<<8|q[r+2]<<16;c(this.idMapping[s])}},idToColor:function(a){var b=this.idMapping.indexOf(a);return-1===b&&(this.idMapping.push(a),b=this.idMapping.length-1),{r:(255&b)/255,g:(b>>8&255)/255,b:(b>>16&255)/255}}},K={};!function(){function a(a){for(var b,c,d,e,f,g,j,k,l,m,n,o,p,q,r,s,t,u={vertices:[],texCoords:[]},v=Math.sin,w=Math.cos,x=Math.PI,y=0;i>y;y++)for(p=y/i,b=2*p*x,c=w(b)*a,d=v(b)*a,q=(y+1)/i,e=2*q*x,f=w(e)*a,g=v(e)*a,t=0;h>t;t++)j=t*x/(2*h),k=(t+1)*x/(2*h),l=[c*w(j),d*w(j),a*v(j)],m=[f*w(j),g*w(j),a*v(j)],n=[f*w(k),g*w(k),a*v(k)],o=[c*w(k),d*w(k),a*v(k)],u.vertices.push.apply(u.vertices,l),u.vertices.push.apply(u.vertices,m),u.vertices.push.apply(u.vertices,n),u.vertices.push.apply(u.vertices,l),u.vertices.push.apply(u.vertices,n),u.vertices.push.apply(u.vertices,o),r=1-(t+1)/h,s=1-t/h,u.texCoords.push(p,s,q,s,q,r,p,s,q,r,p,r);return u}var b,c,d,e,f,g=500,h=8,i=24;K.initShader=function(h){var i="skydome.jpg",j=a(g);return this.resize(),m.on("resize",this.resize.bind(this)),b=new k.Shader({vertexShader:B.skydome.vertex,fragmentShader:B.skydome.fragment,attributes:["aPosition","aTexCoord"],uniforms:["uMatrix","uTileImage","uFogColor"]}),this.fogColor=h.fogColor,c=new k.Buffer(3,new Float32Array(j.vertices)),d=new k.Buffer(2,new Float32Array(j.texCoords)),n.setBusy(),e=new k.texture.Image(i,function(a){n.setIdle(),a&&(f=!0)}),this},K.resize=function(){this.radius=Math.sqrt(j.width*j.width+j.height*j.height)/1},K.render=function(a){if(f){var h=j.getContext();b.enable(),h.uniform3fv(b.uniforms.uFogColor,[this.fogColor.r,this.fogColor.g,this.fogColor.b]);var i=new k.Matrix,l=this.radius/g;i.scale(l,l,l);var m=k.Matrix.multiply(i,a);h.uniformMatrix4fv(b.uniforms.uMatrix,!1,m),c.enable(),h.vertexAttribPointer(b.attributes.aPosition,c.itemSize,h.FLOAT,!1,0,0),d.enable(),h.vertexAttribPointer(b.attributes.aTexCoord,d.itemSize,h.FLOAT,!1,0,0),e.enable(0),h.uniform1i(b.uniforms.uTileImage,0),h.drawArrays(h.TRIANGLES,0,c.numItems),b.disable()}}}();var L={};!function(){var a;L.initShader=function(b){return a=new k.Shader({vertexShader:B.buildings.vertex,fragmentShader:B.buildings.fragment,attributes:["aPosition","aColor","aNormal","aIDColor"],uniforms:["uMMatrix","uMatrix","uNormalTransform","uAlpha","uLightColor","uLightDirection","uFogRadius","uFogColor","uHighlightColor","uHighlightID"]}),this.showBackfaces=b.showBackfaces,this.fogColor=b.fogColor,this},L.render=function(b){if(!(j.zoom<o)){var c=j.getContext();a.enable(),this.showBackfaces&&c.disable(c.CULL_FACE),c.uniform3fv(a.uniforms.uLightColor,[.5,.5,.5]),c.uniform3fv(a.uniforms.uLightDirection,g(1,1,1));var d=k.Matrix.invert3((new k.Matrix).data);c.uniformMatrix3fv(a.uniforms.uNormalTransform,!1,k.Matrix.transpose(d)),c.uniform1f(a.uniforms.uFogRadius,K.radius),c.uniform3fv(a.uniforms.uFogColor,[this.fogColor.r,this.fogColor.g,this.fogColor.b]),this.highlightColor||(this.highlightColor=v),c.uniform3fv(a.uniforms.uHighlightColor,[this.highlightColor.r,this.highlightColor.g,this.highlightColor.b]),this.highlightID||(this.highlightID={r:0,g:0,b:0}),c.uniform3fv(a.uniforms.uHighlightID,[this.highlightID.r,this.highlightID.g,this.highlightID.b]);for(var e,f,h,i=D.Index.items,l=0,m=i.length;m>l;l++)e=i[l],(f=e.getMatrix())&&(c.uniformMatrix4fv(a.uniforms.uMMatrix,!1,f.data),h=k.Matrix.multiply(f,b),c.uniformMatrix4fv(a.uniforms.uMatrix,!1,h),e.vertexBuffer.enable(),c.vertexAttribPointer(a.attributes.aPosition,e.vertexBuffer.itemSize,c.FLOAT,!1,0,0),e.normalBuffer.enable(),c.vertexAttribPointer(a.attributes.aNormal,e.normalBuffer.itemSize,c.FLOAT,!1,0,0),e.colorBuffer.enable(),c.vertexAttribPointer(a.attributes.aColor,e.colorBuffer.itemSize,c.FLOAT,!1,0,0),e.idColorBuffer.enable(),c.vertexAttribPointer(a.attributes.aIDColor,e.idColorBuffer.itemSize,c.FLOAT,!1,0,0),c.drawArrays(c.TRIANGLES,0,e.vertexBuffer.numItems));this.showBackfaces&&c.enable(c.CULL_FACE),a.disable()}}}()}(this);