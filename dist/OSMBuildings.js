var OSMBuildings=function(a){function b(a,b,c){return Math.min(c,Math.max(a,b))}function c(a,c,d){var e=d-c;return b((a-c)/e,0,1)}function d(a,b,d,e){var f=b.min,g=b.max,h=c(a,f[d],g[d]);return f[e]+(g[e]-f[e])*h}function e(a,b,c){var d=b/360+.5,e=Math.min(1,Math.max(0,.5-Math.log(Math.tan(Math.PI/4+Math.PI/2*a/180))/Math.PI/2));return{x:d*c,y:e*c}}function f(a,b){return a.replace(/\{(\w+)\}/g,function(a,c){return b[c]||a})}function g(a,b){var c=a[0]-b[0],d=a[1]-b[1];return c*c+d*d}function h(a){var b=a[0],c=b.length;if(16>c)return!1;var d,e=1/0,f=-1/0,h=1/0,i=-1/0;for(d=0;c>d;d++)e=Math.min(e,b[d][0]),f=Math.max(f,b[d][0]),h=Math.min(h,b[d][1]),i=Math.max(i,b[d][1]);var j=f-e,k=i-h,l=j/k;if(.85>l||l>1.15)return!1;var m=[e+j/2,h+k/2],n=(j+k)/4,o=n*n;for(d=0;c>d;d++){var p=g(b[d],m);if(.8>p/o||p/o>1.2)return!1}return!0}function i(a){for(var b=a[0],c=1/0,d=-1/0,e=1/0,f=-1/0,g=0;g<b.length;g++)c=Math.min(c,b[g][0]),d=Math.max(d,b[g][0]),e=Math.min(e,b[g][1]),f=Math.max(f,b[g][1]);return{minX:c,maxX:d,minY:e,maxY:f}}function j(a){return a*q/180}function k(a,b,c){var d=Math.sqrt(a*a+b*b+c*c);return 0===d&&(d=1e-5),[a/d,b/d,c/d]}!function(b){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=b();else if("function"==typeof define&&define.amd)define([],b);else{var c;"undefined"!=typeof a?c=a:"undefined"!=typeof global?c=global:"undefined"!=typeof self&&(c=self),c.earcut=b()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){"use strict";function c(a){var b=d(a[0],!0);a.length>1&&(b=i(a,b));var c=[];return b&&f(b,c),c}function d(a,b){var c,d,e,f=0,g=a.length;for(c=0,d=g-1;g>c;d=c++){var h=a[c],i=a[d];f+=(i[0]-h[0])*(h[1]+i[1])}if(b===f>0)for(c=0;g>c;c++)e=v(a[c],e);else for(c=g-1;c>=0;c--)e=v(a[c],e);return e}function e(a){var b,c=a;do if(b=!1,o(c.p,c.next.p)||0===n(c.prev.p,c.p,c.next.p)){if(c.prev.next=c.next,c.next.prev=c.prev,c=a=c.prev,c===c.next)return null;b=!0}else c=c.next;while(b||c!==a);return a}function f(a,b,c){if(a=e(a))for(var d,i,j=a;a.prev!==a.next;)if(d=a.prev,i=a.next,g(a))b.push(d.p,a.p,i.p),i.prev=d,d.next=i,a=i.next,j=i.next;else if(a=i,a===j){c?h(a,b):f(a,b,!0);break}}function g(a){var b=a.prev.p,c=a.p,d=a.next.p,e=b[0],f=c[0],g=d[0],h=b[1],i=c[1],j=d[1],k=e*i-h*f,l=e*j-h*g,m=g*i-j*f,n=k-l-m;if(0>=n)return!1;for(var o,p,q,r,s,t=a.next.next,u=j-h,v=e-g,w=h-i,x=f-e;t!==a.prev;)if(o=t.p[0],p=t.p[1],t=t.next,q=u*o+v*p-l,q>=0&&(r=w*o+x*p+k,r>=0&&(s=n-q-r,s>=0&&(q&&r||q&&s||r&&s))))return!1;return!0}function h(a,b){var c=a;do{for(var d=c.next.next;d!==c.prev;){if(m(c,d)){var e=u(c,d);return f(c,b),void f(e,b)}d=d.next}c=c.next}while(c!==a)}function i(a,b){for(var c=a.length,f=[],g=1;c>g;g++){var h=e(d(a[g],!1));h&&f.push(l(h))}for(f.sort(t),g=0;g<f.length;g++)j(f[g],b),b=e(b);return b}function j(a,b){b=k(a,b),b&&u(a,b)}function k(a,b){var c,d,e,f=b,g=a.p,h=g[0],i=g[1],j=-1/0;do{if(d=f.p,e=f.next.p,i<=d[1]&&i>=e[1]){var k=d[0]+(i-d[1])*(e[0]-d[0])/(e[1]-d[1]);h>=k&&k>j&&(j=k,c=d[0]<e[0]?f:f.next)}f=f.next}while(f!==b);if(!c)return null;var l,m,n,o,p,q,s=c.p[0],t=c.p[1],u=h*t-i*s,v=h*i-i*j,w=i-i,x=h-j,y=i-t,z=s-h,A=u-v-(j*t-i*s),B=0>=A?-1:1,C=c,D=1/0;for(f=c.next;f!==C;)l=f.p[0],m=f.p[1],n=h-l,n>=0&&l>=s&&(o=(w*l+x*m-v)*B,o>=0&&(p=(y*l+z*m+u)*B,p>=0&&A*B-o-p>=0&&(q=Math.abs(i-m)/n,D>q&&r(f,a)&&(c=f,D=q)))),f=f.next;return c}function l(a){var b=a,c=a;do b.p[0]<c.p[0]&&(c=b),b=b.next;while(b!==a);return c}function m(a,b){return!q(a,a.p,b.p)&&r(a,b)&&r(b,a)&&s(a,a.p,b.p)}function n(a,b,c){var d=(b[1]-a[1])*(c[0]-b[0])-(b[0]-a[0])*(c[1]-b[1]);return d>0?1:0>d?-1:0}function o(a,b){return a[0]===b[0]&&a[1]===b[1]}function p(a,b,c,d){return n(a,b,c)!==n(a,b,d)&&n(c,d,a)!==n(c,d,b)}function q(a,b,c){var d=a;do{var e=d.p,f=d.next.p;if(e!==b&&f!==b&&e!==c&&f!==c&&p(e,f,b,c))return!0;d=d.next}while(d!==a);return!1}function r(a,b){return-1===n(a.prev.p,a.p,a.next.p)?-1!==n(a.p,b.p,a.next.p)&&-1!==n(a.p,a.prev.p,b.p):-1===n(a.p,b.p,a.prev.p)||-1===n(a.p,a.next.p,b.p)}function s(a,b,c){var d=a,e=!1,f=(b[0]+c[0])/2,g=(b[1]+c[1])/2;do{var h=d.p,i=d.next.p;h[1]>g!=i[1]>g&&f<(i[0]-h[0])*(g-h[1])/(i[1]-h[1])+h[0]&&(e=!e),d=d.next}while(d!==a);return e}function t(a,b){return a.p[0]-b.p[0]}function u(a,b){var c={p:a.p,prev:null,next:null},d={p:b.p,prev:null,next:null},e=a.next,f=b.prev;return a.next=b,b.prev=a,c.next=e,e.prev=c,d.next=c,c.prev=d,f.next=d,d.prev=f,c}function v(a,b){var c={p:a,prev:null,next:null};return b?(c.next=b.next,c.prev=b,b.next.prev=c,b.next=c):(c.prev=c,c.next=c),c}b.exports=c},{}]},{},[1])(1)});var l=function(){function a(a,b,c){return 0>c&&(c+=1),c>1&&(c-=1),1/6>c?a+6*(b-a)*c:.5>c?b:2/3>c?a+(b-a)*(2/3-c)*6:a}function b(a,b){return Math.min(b,Math.max(0,a))}var c={aqua:"#00ffff",black:"#000000",blue:"#0000ff",fuchsia:"#ff00ff",gray:"#808080",grey:"#808080",green:"#008000",lime:"#00ff00",maroon:"#800000",navy:"#000080",olive:"#808000",orange:"#ffa500",purple:"#800080",red:"#ff0000",silver:"#c0c0c0",teal:"#008080",white:"#ffffff",yellow:"#ffff00"},d=function(a,b,c,d){this.H=a,this.S=b,this.L=c,this.A=d};return d.parse=function(a){var b,d=0,e=0,f=0,g=1;if(a=(""+a).toLowerCase(),a=c[a]||a,b=a.match(/^#(\w{2})(\w{2})(\w{2})$/))d=parseInt(b[1],16),e=parseInt(b[2],16),f=parseInt(b[3],16);else{if(!(b=a.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/)))return;d=parseInt(b[1],10),e=parseInt(b[2],10),f=parseInt(b[3],10),g=b[4]?parseFloat(b[5]):1}return this.fromRGBA(d,e,f,g)},d.fromRGBA=function(a,b,c,e){"object"==typeof a?(b=a.g/255,c=a.b/255,e=a.a,a=a.r/255):(a/=255,b/=255,c/=255);var f,g,h=Math.max(a,b,c),i=Math.min(a,b,c),j=(h+i)/2,k=h-i;if(k){switch(g=j>.5?k/(2-h-i):k/(h+i),h){case a:f=(b-c)/k+(c>b?6:0);break;case b:f=(c-a)/k+2;break;case c:f=(a-b)/k+4}f*=60}else f=g=0;return new d(f,g,j,e)},d.prototype={toRGBA:function(){var c=b(this.H,360),d=b(this.S,1),e=b(this.L,1),f={a:b(this.A,1)};if(0===d)f.r=e,f.g=e,f.b=e;else{var g=.5>e?e*(1+d):e+d-e*d,h=2*e-g;c/=360,f.r=a(h,g,c+1/3),f.g=a(h,g,c),f.b=a(h,g,c-1/3)}return{r:Math.round(255*f.r),g:Math.round(255*f.g),b:Math.round(255*f.b),a:f.a}},toString:function(){var a=this.toRGBA();return 1===a.a?"#"+((1<<24)+(a.r<<16)+(a.g<<8)+a.b).toString(16).slice(1,7):"rgba("+[a.r,a.g,a.b,a.a.toFixed(2)].join(",")+")"},hue:function(a){return new d(this.H*a,this.S,this.L,this.A)},saturation:function(a){return new d(this.H,this.S*a,this.L,this.A)},lightness:function(a){return new d(this.H,this.S,this.L*a,this.A)},alpha:function(a){return new d(this.H,this.S,this.L,this.A*a)}},d}(this),m=function(a){a=a||{},o=new B(a.src||u.replace("{k}",a.dataKey||t),{fixedZoom:16}),a.map&&this.addTo(a.map),a.style&&this.setStyle(a.style)};!function(){function a(){o.updateTileBounds(),o.update(100)}function b(){o.updateTileBounds(),o.update(),p.resize()}m.VERSION="0.1.5",m.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>',m.prototype={addTo:function(c){return c.addLayer(this),n={},c.on("change",function(){n.zoom=c.getZoom(),n.bounds=c.getBounds(),n.origin=c.getOrigin(),n.rotation=c.getRotation(),n.tilt=c.getTilt(),a()}),c.on("resize",function(){n.size=c.getSize(),n.bounds=c.getBounds(),b()}),n.size=c.getSize(),n.zoom=c.getZoom(),n.bounds=c.getBounds(),n.origin=c.getOrigin(),n.rotation=c.getRotation(),n.tilt=c.getTilt(),p=new J(c.getContext()),a(),b(),this},remove:function(){},render:function(){return p.render(),this},destroy:function(){o.destroy()},setStyle:function(a){var b=a.color||a.wallColor;return b&&(w=l.parse(b).toRGBA()),this},addObject:function(a,b,c){return D.load(a,b,c),this}}}();var n,o,p,q=Math.PI,r=14.5,s=256,t="anonymous",u="http://{s}.data.osmbuildings.org/0.2/{k}/tile/{z}/{x}/{y}.json",v=10,w=l.parse("rgb(220, 210, 200)").toRGBA(),x={zoomAlpha:{min:{zoom:17,alpha:1},max:{zoom:20,alpha:1}}},y={};!function(){var a={};y.loadJSON=function(b,c){if(a[b])return a[b];var d=new XMLHttpRequest;return d.onreadystatechange=function(){if(4===d.readyState&&(delete a[b],!(!d.status||d.status<200||d.status>299)&&d.responseText))try{c(JSON.parse(d.responseText))}catch(e){}},a[b]=d,d.open("GET",b),d.send(null),{abort:function(){d.abort(),delete a[b]}}},y.abortAll=function(){for(var b in a)a[b].abort();a={}}}();var z={"default":{src:{vertex:"\nprecision mediump float;\nattribute vec4 aPosition;\nattribute vec3 aNormal;\nattribute vec3 aColor;\nuniform mat4 uMatrix;\nuniform mat3 uNormalTransform;\nuniform vec3 uLightDirection;\nuniform vec3 uLightColor;\nvarying vec3 vColor;\nvarying vec4 vPosition;\nvoid main() {\n  gl_Position = uMatrix * aPosition;\n  vPosition = aPosition;\n  vec3 transformedNormal = aNormal * uNormalTransform;\n  float intensity = max( dot(transformedNormal, uLightDirection), 0.0) / 1.5;\n  vColor = aColor + uLightColor * intensity;\n}",fragment:"\nprecision mediump float;\nuniform float uAlpha;\nvarying vec4 vPosition;\nvarying vec3 vColor;\nfloat gradientHeight = 90.0;\nfloat maxGradientStrength = 0.3;\nvoid main() {\n  float shading = clamp((gradientHeight-vPosition.z) / (gradientHeight/maxGradientStrength), 0.0, maxGradientStrength);\n  gl_FragColor = vec4(vColor - shading, uAlpha);\n//  float fog = clamp((10.0-vPosition.y)/20.0, 0.0, 0.5);\n//  gl_FragColor = vec4(vColor - shading, uAlpha-fog);\n}\n"},attributes:["aPosition","aColor","aNormal"],uniforms:["uNormalTransform","uMatrix","uAlpha","uLightColor","uLightDirection"]}},A={LAT_SEGMENTS:32,LON_SEGMENTS:32,quad:function(a,b,c,d,e,f){this.addTriangle(a,b,c,d,f),this.addTriangle(a,c,e,d,f)},circle:function(a,b,c,d,e){for(var f,g,h=this.LON_SEGMENTS,i=0;h>i;i++)f=i/h,g=(i+1)/h,this.addTriangle(a,[b[0]+c*Math.sin(f*Math.PI*2),b[1]+c*Math.cos(f*Math.PI*2),d],[b[0],b[1],d],[b[0]+c*Math.sin(g*Math.PI*2),b[1]+c*Math.cos(g*Math.PI*2),d],e)},polygon:function(a,b,c,d){for(var e=earcut(b),f=0,g=e.length-2;g>f;f+=3)this.addTriangle(a,[e[f+0][0],e[f+0][1],c],[e[f+1][0],e[f+1][1],c],[e[f+2][0],e[f+2][1],c],d)},cylinder:function(a,b,c,d,e,f,g){for(var h,i,j,k,l,m,n=this.LON_SEGMENTS,o=0;n>o;o++)h=o/n,i=(o+1)/n,j=Math.sin(h*Math.PI*2),k=Math.cos(h*Math.PI*2),l=Math.sin(i*Math.PI*2),m=Math.cos(i*Math.PI*2),this.addTriangle(a,[b[0]+c*j,b[1]+c*k,e],[b[0]+d*l,b[1]+d*m,f],[b[0]+c*l,b[1]+c*m,e],g),0!==d&&this.addTriangle(a,[b[0]+d*j,b[1]+d*k,f],[b[0]+d*l,b[1]+d*m,f],[b[0]+c*j,b[1]+c*k,e],g)},Sphere:function(a,b,c,d,e,f){for(var g,h,i,j=this.LAT_SEGMENTS,k=0;j>k;k++)g=k*Math.PI/j,h=Math.sin(g),i=Math.cos(g),A.cylinder(a,b,radiusBottom,radiusTop,d,e,f)},Dome:function(){this.LAT_SEGMENTS/2},extrusion:function(a,b,c,d,e){for(var f,g,h,i,j,k,l=0,m=b.length;m>l;l++){f=b[l],g=f.length-1,(f[0][0]!==f[g][0]||f[0][1]!==f[g][1])&&(f.push(f[0]),g++);for(var n=0;g>n;n++)h=f[n],i=f[n+1],j=c,k=d,this.quad(a,[h[0],h[1],j],[i[0],i[1],j],[h[0],h[1],k],[i[0],i[1],k],e)}},addTriangle:function(a,b,c,d,e){a.vertices.push(b[0],b[1],b[2],c[0],c[1],c[2],d[0],d[1],d[2]);var f=this.computeNormal(b[0],b[1],b[2],c[0],c[1],c[2],d[0],d[1],d[2]);a.normals.push(f[0],f[1],f[2],f[0],f[1],f[2],f[0],f[1],f[2]),a.colors.push(e.r,e.g,e.b,e.r,e.g,e.b,e.r,e.g,e.b)},computeNormal:function(a,b,c,d,e,f,g,h,i){var j=a-d,l=b-e,m=c-f,n=d-g,o=e-h,p=f-i,q=l*p-m*o,r=m*n-j*p,s=j*o-l*n;return k(q,r,s)}},B=function(a,b){this.url=a,b=b||{},this.tileSize=b.tileSize||256,this.fixedZoom=b.fixedZoom,this.tiles={},this.loading={}};B.prototype={updateTileBounds:function(){var a=n.bounds,b=this.tileSize,c=this.zoom=this.fixedZoom||Math.round(n.zoom),d=b<<c,f=e(a.n,a.w,d),g=e(a.s,a.e,d);this.tileBounds={minX:f.x/b<<0,minY:f.y/b<<0,maxX:Math.ceil(g.x/b),maxY:Math.ceil(g.y/b)}},update:function(a){return a?void(this.isWaiting||(this.isWaiting=setTimeout(function(){this.isWaiting=null,this.loadTiles()}.bind(this),a))):void this.loadTiles()},loadTiles:function(){var a,b,c,d,e=this.tileBounds,f=this.zoom,h=this.tiles,i=this.loading,j=[];for(b=e.minY;b<=e.maxY;b++)for(a=e.minX;a<=e.maxX;a++)c=[a,b,f].join(","),h[c]||i[c]||j.push({x:a,y:b,z:f});if(d=j.length){var k={x:e.minX+(e.maxX-e.minX-1)/2,y:e.minY+(e.maxY-e.minY-1)/2};j.sort(function(a,b){return g(b,k)-g(a,k)});for(var l=0;d>l;l++)this.loadTile(j[l].x,j[l].y,j[l].z);this.purge()}},getURL:function(a,b,c){var d="abcd"[(a+b)%4];return f(this.url,{s:d,x:a,y:b,z:c})},loadTile:function(a,b,c){var d=[a,b,c].join(",");this.loading[d]=y.loadJSON(this.getURL(a,b,c),function(e){delete this.loading[d],this.tiles[d]=new C(a,b,c,e)}.bind(this))},purge:function(){var a,b=this.tiles,c=this.loading;for(a in b)this.isVisible(a,2)||(b[a].destroy(),delete b[a]);for(a in c)this.isVisible(a)||(c[a].abort(),delete c[a])},isVisible:function(a,b){b=b||0;var c=this.tileSize,d=this.tileBounds,e=a.split(","),f=parseInt(e[0],10),g=parseInt(e[1],10),h=parseInt(e[2],10);return h!==this.zoom?!1:f>=d.minX-b-c&&f<=d.maxX+b&&g>=d.minY-b-c&&g<=d.maxY+b},getVisibleItems:function(){var a,b=this.tiles,c=[];for(a in b)this.isVisible(a)&&c.push(b[a]);return c},destroy:function(){clearTimeout(this.isWaiting);for(var a in this.tiles)this.tiles[a].destroy();this.tiles=null;for(a in this.loading)this.loading[a].abort();this.loading=null}};var C=function(a,b,c,d){this.x=a,this.y=b,this.z=c;var e=F.read(a,b,c,d);this.vertexBuffer=this.createBuffer(3,new Float32Array(e.vertices)),this.normalBuffer=this.createBuffer(3,new Float32Array(e.normals)),this.colorBuffer=this.createBuffer(3,new Uint8Array(e.colors))};C.prototype={createBuffer:function(a,b){var c=H.createBuffer();return c.itemSize=a,c.numItems=b.length/a,H.bindBuffer(H.ARRAY_BUFFER,c),H.bufferData(H.ARRAY_BUFFER,b,H.STATIC_DRAW),c},render:function(a,b){var c=1/Math.pow(2,this.z-n.zoom),d=s*c,e=n.size,f=n.origin,g=I.create();g=I.scale(g,c,c,.65*c),g=I.translate(g,this.x*d-f.x,this.y*d-f.y,0),g=I.rotateZ(g,n.rotation),g=I.rotateX(g,n.tilt),g=I.translate(g,e.width/2,e.height/2,0),g=I.multiply(g,b),H.uniformMatrix4fv(a.uniforms.uMatrix,!1,new Float32Array(g)),H.bindBuffer(H.ARRAY_BUFFER,this.vertexBuffer),H.vertexAttribPointer(a.attributes.aPosition,this.vertexBuffer.itemSize,H.FLOAT,!1,0,0),H.bindBuffer(H.ARRAY_BUFFER,this.normalBuffer),H.vertexAttribPointer(a.attributes.aNormal,this.normalBuffer.itemSize,H.FLOAT,!1,0,0),H.bindBuffer(H.ARRAY_BUFFER,this.colorBuffer),H.vertexAttribPointer(a.attributes.aColor,this.colorBuffer.itemSize,H.UNSIGNED_BYTE,!0,0,0),H.drawArrays(H.TRIANGLES,0,this.vertexBuffer.numItems)},destroy:function(){H.deleteBuffer(this.vertexBuffer),H.deleteBuffer(this.normalBuffer),H.deleteBuffer(this.colorBuffer)}};var D={items:[],getVisibleItems:function(){for(var a=[],b=0,c=this.items.length;c>b;b++)a.push(this.items[b]);return a},load:function(a,b,c){var d=new XMLHttpRequest;return d.onreadystatechange=function(){if(4===d.readyState&&!(!d.status||d.status<200||d.status>299)&&d.responseText){var b;switch(a.toLowerCase()){case"geojson":b=F.read(0,0,16,JSON.parse(d.responseText));break;case"obj":b=G.read(d.responseText)}b&&this.items.push(new E(b,c))}}.bind(this),d.open("GET",b),d.send(null),d}},E=function(a){this.vertexBuffer=this.createBuffer(3,new Float32Array(a.vertices)),this.normalBuffer=this.createBuffer(3,new Float32Array(a.normals)),this.colorBuffer=this.createBuffer(3,new Uint8Array(a.colors))};E.prototype={createBuffer:function(a,b){var c=H.createBuffer();return c.itemSize=a,c.numItems=b.length/a,H.bindBuffer(H.ARRAY_BUFFER,c),H.bufferData(H.ARRAY_BUFFER,b,H.STATIC_DRAW),c},render:function(a,b){var c=1/Math.pow(2,16-n.zoom),d=n.size,e=n.origin,f=I.create();f=I.scale(f,c,c,.65*c),f=I.translate(f,-e.x,-e.y,0),f=I.rotateZ(f,n.rotation),f=I.rotateX(f,n.tilt),f=I.translate(f,d.width/2,d.height/2,0),f=I.multiply(f,b),H.uniformMatrix4fv(a.uniforms.uMatrix,!1,new Float32Array(f)),H.bindBuffer(H.ARRAY_BUFFER,this.vertexBuffer),H.vertexAttribPointer(a.attributes.aPosition,this.vertexBuffer.itemSize,H.FLOAT,!1,0,0),H.bindBuffer(H.ARRAY_BUFFER,this.normalBuffer),H.vertexAttribPointer(a.attributes.aNormal,this.normalBuffer.itemSize,H.FLOAT,!1,0,0),H.bindBuffer(H.ARRAY_BUFFER,this.colorBuffer),H.vertexAttribPointer(a.attributes.aColor,this.colorBuffer.itemSize,H.UNSIGNED_BYTE,!0,0,0),H.drawArrays(H.TRIANGLES,0,this.vertexBuffer.numItems)},destroy:function(){H.deleteBuffer(this.vertexBuffer),H.deleteBuffer(this.normalBuffer),H.deleteBuffer(this.colorBuffer)}};var F={};!function(){function a(a){return a=a.toLowerCase(),"#"===a[0]?a:g[j[a]||a]||null}function b(b){var c,d={};b=b||{},d.height=b.height||(b.levels?b.levels*f:v),d.minHeight=b.minHeight||(b.minLevel?b.minLevel*f:0);var e=b.material?a(b.material):b.wallColor||b.color;d.wallColor=(c=l.parse(e))?c.toRGBA():w;var g=b.roofMaterial?a(b.roofMaterial):b.roofColor;switch(d.roofColor=(c=l.parse(g))?c.toRGBA():w,b.shape){case"cylinder":case"cone":case"dome":case"sphere":d.shape=b.shape,d.isRotational=!0;break;case"pyramid":d.shape=b.shape}switch(b.roofShape){case"cone":case"dome":d.roofShape=b.roofShape,d.isRotational=!0;break;case"pyramid":d.roofShape=b.roofShape}return d.roofShape&&b.roofHeight?(d.roofHeight=b.roofHeight,d.height=Math.max(0,d.height-d.roofHeight)):d.roofHeight=0,d.height+d.roofHeight<=d.minHeight?void 0:(b.relationId&&(d.relationId=b.relationId),d)}function c(a){var b,d,e,f=[];switch(a.type){case"GeometryCollection":for(d=0,e=a.geometries.length;e>d;d++)(b=c(a.geometries[d]))&&f.push.apply(f,b);return f;case"MultiPolygon":for(d=0,e=a.coordinates.length;e>d;d++)(b=c({type:"Polygon",coordinates:a.coordinates[d]}))&&f.push.apply(f,b);return f;case"Polygon":return[a.coordinates];default:return[]}}function d(a,b,c,d){for(var f,g,h,i,j=s*Math.pow(2,c),k=a*s,l=b*s,m=[],n=0,o=d.length;o>n;n++)for(i=d[n],m[n]=[],f=0,g=i.length-1;g>f;f++)h=e(i[f][1],i[f][0],j),m[n][f]=[h.x-k,h.y-l];return m}var f=3,g={brick:"#cc7755",bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",glass:"#e8f8f8",gold:"#ffcc00",plants:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},j={asphalt:"tar_paper",bitumen:"tar_paper",block:"stone",bricks:"brick",glas:"glass",glassfront:"glass",grass:"plants",masonry:"stone",granite:"stone",panels:"panel",paving_stones:"stone",plastered:"plaster",rooftiles:"roof_tiles",roofingfelt:"tar_paper",sandstone:"stone",sheet:"canvas",sheets:"canvas",shingle:"tar_paper",shingles:"tar_paper",slates:"slate",steel:"metal",tar:"tar_paper",tent:"canvas",thatch:"plants",tile:"roof_tiles",tiles:"roof_tiles"};F.read=function(a,e,f,g){if(!g||"FeatureCollection"!==g.type)return[];for(var j,k,l,m,n,o,p,q,r,s=g.features,t={vertices:[],normals:[],colors:[]},u=0,v=s.length;v>u;u++)if(j=s[u],n=b(j.properties))for(k=c(j.geometry),l=0,m=k.length;m>l;l++){switch(o=d(a,e,f,k[l]),"cone"!==n.roofShape&&"dome"!==n.roofShape||n.shape||!h(o)||(n.shape="cylinder",n.isRotational=!0),n.isRotational&&(p=i(o),q=(p.maxX-p.minX)/2,r=[p.minX+(p.maxX-p.minX)/2,p.minY+(p.maxY-p.minY)/2]),n.shape){case"cylinder":A.cylinder(t,r,q,q,n.minHeight,n.height,n.wallColor),A.circle(t,r,q,n.height,n.roofColor);break;case"cone":A.cylinder(t,r,q,0,n.minHeight,n.height,n.wallColor);break;case"sphere":A.cylinder(t,r,q,q/2,n.minHeight,n.height,n.wallColor),A.circle(t,r,q/2,n.height,n.roofColor);break;case"pyramid":break;default:A.extrusion(t,o,n.minHeight,n.height,n.wallColor),A.polygon(t,o,n.height,n.roofColor)}switch(n.roofShape){case"cone":A.cylinder(t,r,q,0,n.height,n.height+n.roofHeight,n.roofColor);break;case"dome":A.cylinder(t,r,q,q/2,n.height,n.height+n.roofHeight,n.roofColor),A.circle(t,r,q/2,n.height+n.roofHeight,n.roofColor);break;case"pyramid":}}return t}}();var G={};!function(){function a(a,b){var c=parseFloat(b[1]),d=parseFloat(b[2]),e=parseFloat(b[3]);a.vertices.push([c,e,d])}function b(a,b){a.normals.push([parseFloat(b[1]),parseFloat(b[2]),parseFloat(b[3])])}function c(a,b){a.texCoords.push([parseFloat(b[1]),parseFloat(b[2])])}function d(a,b,c){for(var d,e,f,g,h=[240,220,200],i=1,j=4;j>i;i++)g=b[i].split("/"),d=c.vertices[g[0]-1],e=c.normals[g[2]-1],f=c.texCoords[g[1]-1],a.vertices.push(d[0],d[1],d[2]),a.normals.push(e[0],e[1],e[2]),a.colors.push(h[0],h[1],h[2]),a.texCoords.push(f[0],f[1])}G.read=function(e){for(var f,g={vertices:[],normals:[],texCoords:[]},h={vertices:[],normals:[],colors:[],texCoords:[]},i=e.split("\n"),j=0,k=i.length;k>j;j++)switch(f=i[j].split(" "),f[0]){case"v":a(g,f);break;case"vn":b(g,f);break;case"vt":c(g,f);break;case"f":d(h,f,g)}return h}}();var H,I={create:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},multiply:function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=b[0],t=b[1],u=b[2],v=b[3],w=b[4],x=b[5],y=b[6],z=b[7],A=b[8],B=b[9],C=b[10],D=b[11],E=b[12],F=b[13],G=b[14],H=b[15];return[c*s+d*w+e*A+f*E,c*t+d*x+e*B+f*F,c*u+d*y+e*C+f*G,c*v+d*z+e*D+f*H,g*s+h*w+i*A+j*E,g*t+h*x+i*B+j*F,g*u+h*y+i*C+j*G,g*v+h*z+i*D+j*H,k*s+l*w+m*A+n*E,k*t+l*x+m*B+n*F,k*u+l*y+m*C+n*G,k*v+l*z+m*D+n*H,o*s+p*w+q*A+r*E,o*t+p*x+q*B+r*F,o*u+p*y+q*C+r*G,o*v+p*z+q*D+r*H]},perspective:function(a,b,c,d){return[2/b,0,0,0,0,-2/c,0,0,0,40/d,-2/d,a*(-2/d),-1,1,0,1]},ortho:function(a,b,c){return this.perspective(1,a,b,c)},translate:function(a,b,c,d){return this.multiply(a,[1,0,0,0,0,1,0,0,0,0,1,0,b,c,d,1])},rotateX:function(a,b){var c=j(b),d=Math.cos(c),e=Math.sin(c);return this.multiply(a,[1,0,0,0,0,d,e,0,0,-e,d,0,0,0,0,1])},rotateY:function(a,b){var c=j(b),d=Math.cos(c),e=Math.sin(c);return this.multiply(a,[d,0,-e,0,0,1,0,0,e,0,d,0,0,0,0,1])},rotateZ:function(a,b){var c=j(b),d=Math.cos(c),e=Math.sin(c);return this.multiply(a,[d,-e,0,0,e,d,0,0,0,0,1,0,0,0,0,1])},scale:function(a,b,c,d){return this.multiply(a,[b,0,0,0,0,c,0,0,0,0,d,0,0,0,0,1])},invert:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15],r=b*g-c*f,s=b*h-d*f,t=b*i-e*f,u=c*h-d*g,v=c*i-e*g,w=d*i-e*h,x=j*o-k*n,y=j*p-l*n,z=j*q-m*n,A=k*p-l*o,B=k*q-m*o,C=l*q-m*p,D=r*C-s*B+t*A+u*z-v*y+w*x;return D?(D=1/D,[(g*C-h*B+i*A)*D,(d*B-c*C-e*A)*D,(o*w-p*v+q*u)*D,(l*v-k*w-m*u)*D,(h*z-f*C-i*y)*D,(b*C-d*z+e*y)*D,(p*t-n*w-q*s)*D,(j*w-l*t+m*s)*D,(f*B-g*z+i*x)*D,(c*z-b*B-e*x)*D,(n*v-o*t+q*r)*D,(k*t-j*v-m*r)*D,(g*y-f*A-h*x)*D,(b*A-c*y+d*x)*D,(o*s-n*u-p*r)*D,(j*u-k*s+l*r)*D]):null},invert3:function(a){var b=a[0],c=a[1],d=a[2],e=a[4],f=a[5],g=a[6],h=a[8],i=a[9],j=a[10],k=j*f-g*i,l=-j*e+g*h,m=i*e-f*h,n=b*k+c*l+d*m;return n?(n=1/n,[k*n,(-j*c+d*i)*n,(g*c-d*f)*n,l*n,(j*b-d*h)*n,(-g*b+d*e)*n,m*n,(-i*b+c*h)*n,(f*b-c*e)*n]):null},transpose:function(a){return[a[0],a[3],a[6],a[1],a[4],a[7],a[2],a[5],a[8]]}},J=function(a){H=a,this.shaderPrograms["default"]=new K("default"),this.resize()};J.prototype={projections:{},shaderPrograms:{},clear:function(){H.clear(H.COLOR_BUFFER_BIT|H.DEPTH_BUFFER_BIT)},render:function(){var a,b,c;if(!(n.zoom<r)){H.enable(H.CULL_FACE),H.enable(H.DEPTH_TEST),H.cullFace(H.FRONT);var e=o.getVisibleItems(),f=D.getVisibleItems();a=this.shaderPrograms["default"].use(),H.uniform3fv(a.uniforms.uLightColor,[.5,.5,.5]),H.uniform3fv(a.uniforms.uLightDirection,k(1,1,1)),H.uniform1f(a.uniforms.uAlpha,d(n.zoom,x.zoomAlpha,"zoom","alpha"));var g=I.invert3(I.create());for(H.uniformMatrix3fv(a.uniforms.uNormalTransform,!1,new Float32Array(I.transpose(g))),b=0,c=e.length;c>b;b++)e[b].render(a,this.projections.perspective);for(b=0,c=f.length;c>b;b++)f[b].render(a,this.projections.perspective);a.end()}},resize:function(){var a=n.size;H.viewport(0,0,a.width,a.height),this.projections.perspective=I.perspective(20,a.width,a.height,4e4),this.projections.ortho=I.ortho(a.width,a.height,4e4)}};var K=function(a){var b=z[a];if(this.id=H.createProgram(),this.name=a,!b.src)throw new Error('missing source for shader "'+a+'"');if(this._attach(H.VERTEX_SHADER,b.src.vertex),this._attach(H.FRAGMENT_SHADER,b.src.fragment),H.linkProgram(this.id),!H.getProgramParameter(this.id,H.LINK_STATUS))throw new Error(H.getProgramParameter(this.id,H.VALIDATE_STATUS)+"\n"+H.getError());this.attributeNames=b.attributes,this.uniformNames=b.uniforms};K.prototype={_attach:function(a,b){var c=H.createShader(a);if(H.shaderSource(c,b),H.compileShader(c),!H.getShaderParameter(c,H.COMPILE_STATUS))throw new Error(H.getShaderInfoLog(c));H.attachShader(this.id,c)},use:function(){H.useProgram(this.id);var a,b,c;if(this.attributeNames)for(this.attributes={},a=0;a<this.attributeNames.length;a++)b=this.attributeNames[a],c=H.getAttribLocation(this.id,b),0>c?console.error('could not locate attribute "'+b+'" in shader "'+this.name+'"'):(H.enableVertexAttribArray(c),this.attributes[b]=c);if(this.uniformNames)for(this.uniforms={},a=0;a<this.uniformNames.length;a++)b=this.uniformNames[a],c=H.getUniformLocation(this.id,b),0>c?console.error('could not locate uniform "'+b+'" in shader "'+this.name+'"'):this.uniforms[b]=c;return this},end:function(){if(H.useProgram(null),this.attributes)for(var a in this.attributes)H.disableVertexAttribArray(this.attributes[a]);this.attributes=null,this.uniforms=null}};var L=function(a,b,c){if(c=c||{},this.width=a,this.height=b,this.texture=new M(a,b,c.texture),this.id=H.createFramebuffer(),H.bindFramebuffer(H.FRAMEBUFFER,this.id),H.framebufferTexture2D(H.FRAMEBUFFER,H.COLOR_ATTACHMENT0,H.TEXTURE_2D,this.texture.id,0),this.renderbuffer=H.createRenderbuffer(),H.bindRenderbuffer(H.RENDERBUFFER,this.renderbuffer),this.renderbuffer.width=this.width,this.renderbuffer.height=this.height,H.renderbufferStorage(H.RENDERBUFFER,H.DEPTH_COMPONENT16,this.width,this.height),H.framebufferRenderbuffer(H.FRAMEBUFFER,H.DEPTH_ATTACHMENT,H.RENDERBUFFER,this.renderbuffer),H.checkFramebufferStatus(H.FRAMEBUFFER)!==H.FRAMEBUFFER_COMPLETE)throw new Error("This combination of framebuffer attachments does not work");H.bindRenderbuffer(H.RENDERBUFFER,null),H.bindFramebuffer(H.FRAMEBUFFER,null),this.texture.end()};L.prototype={use:function(){return this.viewport=H.getParameter(H.VIEWPORT),H.bindFramebuffer(H.FRAMEBUFFER,this.id),H.bindRenderbuffer(H.RENDERBUFFER,this.renderbuffer),H.viewport(0,0,this.width,this.height),this},end:function(){H.bindFramebuffer(H.FRAMEBUFFER,null),H.bindRenderbuffer(H.RENDERBUFFER,null),H.viewport(this.viewport[0],this.viewport[1],this.viewport[2],this.viewport[3])}};var M=function(a,b,c){c=c||{},this.id=H.createTexture(),this.width=a,this.height=b,this.format=c.format||H.RGBA,this.type=c.type||H.UNSIGNED_BYTE;var d=c.filter||c.magFilter||H.LINEAR,e=c.filter||c.minFilter||H.LINEAR;H.bindTexture(H.TEXTURE_2D,this.id),H.pixelStorei(H.UNPACK_FLIP_Y_WEBGL,1),H.texParameteri(H.TEXTURE_2D,H.TEXTURE_MAG_FILTER,d),H.texParameteri(H.TEXTURE_2D,H.TEXTURE_MIN_FILTER,e),H.texParameteri(H.TEXTURE_2D,H.TEXTURE_WRAP_S,c.wrap||c.wrapS||H.CLAMP_TO_EDGE),H.texParameteri(H.TEXTURE_2D,H.TEXTURE_WRAP_T,c.wrap||c.wrapT||H.CLAMP_TO_EDGE),H.texImage2D(H.TEXTURE_2D,0,this.format,a,b,0,this.format,this.type,null)};return M.prototype={use:function(a){return H.activeTexture(H.TEXTURE0+(a||0)),H.bindTexture(H.TEXTURE_2D,this.id),this},end:function(a){H.activeTexture(H.TEXTURE0+(a||0)),H.bindTexture(H.TEXTURE_2D,null)}},m}(this);